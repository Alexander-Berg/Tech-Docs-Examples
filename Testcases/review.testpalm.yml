feature: Объектный ответ
type: Отзывы

counter: /$page/$main/$result[@wizard_name="entity_search"]/object-badge/about

specs-integration:
  beforeEach:
    - do: получить выдачу по запросу 'Готика 3' (альтернативные вопросы 'Герои меча и магии', 'Симс 3') (пользователь залогинен)
    - assert: на выдаче есть карточка ОО
  Проверка звезд на СЕРПе:
    - tags:
      - pp_new_core
    - assert: в карточке есть звезды
    - do: кликнуть на четвертую звезду
    - assert: выставленная оценка отображается (если открылся попап со счетчиком оценок - закрыть его), ниже появилось сообщение 'Хотите оставить отзыв?' с кнопками 'Хочу' и 'Нет, спасибо'

specs:
  aliases:
    - &OpenGameSerp
        - do: открыть вкладку инкогнито (для ПП - очистить историю), незалогин и получить выдачу по запросу 'Готика 3'
        - assert: на выдаче есть Объектный ответ, в карточке есть блок рейтингов
        - assert: у пользователя не должно быть оценок фильмов, сериалов, игр и т.д., для незалогина очистить историю браузера
        - screenshot: внешний вид блоков рейтингов [entity-search__rating-{{SET_NAME}} >> rating]
    - &OnFirstRatingSet
        - assert: в блоке рейтингов появилась оценка пользователя
        - screenshot: внешний вид для экранов 320px и меньше с оставленной оценкой [entity-search__rating-{{SET_NAME}} >> rating-user]
        - screenshot: внешний вид для экранов больше 320px [https://jing.yandex-team.ru/files/litsyuk/matritsa_film_1999_%E2%80%94_YAndeks__nashlos_8%C2%A0tys.%C2%A0rezultatov_%E2%80%94_YAndeks.Brauzer_2019-09-03_15.24.54.png]
    - &RatingSet
        - do: получить выдачу по запросу 'foreverdata'
        - assert: на выдаче есть Объектный ответ, в карточке есть блок рейтингов
        - assert: у пользователя не должно быть оценок фильмов, сериалов и т.д., для незалогина очистить историю браузера
        - do: поставить оценку 4 (кликнуть на четвертую звезду)
        - assert: в блоке рейтингов появилась оценка пользователя
        - assert: в блоке рейтингов появилась предложение оставить свой отзыв
        - screenshot: внешний вид предложением оставить отзыв [rating-invite]
        - do: нажать на кнопку "Хочу"
        - assert: показалось модальное окно
        - screenshot: внешний вид с возможностью отредактировать оценку [rating-modal]

  Выставление первой оценки:
    - label: entity-search__rating-{{SET_NAME}}
    - *OpenGameSerp
    - screenshot: внешний вид блоков рейтингов [rating]
    - do: поставить игре оценку 4 (кликнуть на четвертую звезду)
    - tech: сработал счетчик /snippet/entity_search/rating-dynamic/set
    - *OnFirstRatingSet
    - screenshot: внешний вид с оставленной оценкой [rating-user]
    - assertMetrics: '*'
  Редактирование оценки:
    - label: entity-search__review-edit-{{SET_NAME}}
    - *OpenGameSerp
    - do: поставить игре оценку 4 (кликнуть на четвертую звезду)
    - *OnFirstRatingSet
    - do: кликнуть по оценке пользователя (справа от рейтингов КП/IMDb)
    - tech: сработал счетчик /snippet/entity_search/rating-user
    - assert: открылось модальное окно редактирования отзыва
    - assert: выбрана четвертая звезда
    - screenshot: внешний вид [review-modal]
    - do: кликнуть по пятой звезде
    - assert: пятая звезда закрасилась
    - tech: сработал счетчик /snippet/entity_search/review-editable/rating-dynamic/change
    - do: кликнуть по кнопке 'Отмена'
    - assert: модальное окно редактирования отзыва закрылось
    - tech: сработал счетчик /snippet/entity_search/review-editable/cancel
    - assert: значение оценки в карточке не изменилось (равно 4)
    - do: кликнуть по оценке пользователя
    - assert: открылось модальное окно редактирования отзыва
    - assert: выбрана четвертая звезда
    - do: кликнуть по пятой звезде
    - assert: пятая звезда закрасилась
    - do: кликнуть по кнопке 'Готово'
    - assert: модальное окно редактирования отзыва закрылось
    - tech: сработал счетчик /snippet/entity_search/review-editable/success
    - assert: значение оценки в карточке изменилось (равно 5)
    - assertMetrics: '*'
  Удаление оценки:
    - *OpenGameSerp
    - do: поставить игре оценку 4 (кликнуть на четвертую звезду)
    - *OnFirstRatingSet
    - do: кликнуть по оценке пользователя
    - tech: сработал счетчик /snippet/entity_search/rating-user
    - assert: открылось модальное окно редактирования отзыва
    - assert: выбрана четвертая звезда
    - do: кликнуть по четвертой звезде
    - assert: звезды перестали быть закрашенными
    - do: кликнуть по кнопке 'Удалить'
    - screenshot: внешний вид рейтинга после удаления оценки [rating-empty]
  В альбомной ориентации:
    - *OpenGameSerp
    - do: поставить игре оценку 4 (кликнуть на четвертую звезду)
    - *OnFirstRatingSet
    - screenshot: внешний вид оценки в альбомной ориентации [user-rating-landscape]
    - assertMetrics: '*'

  Предложение оставить отзыв после выставления оценки:
    Книга:
      - params:
          foreverdata: '220089373'
      - *RatingSet
    Игра:
      - params:
          foreverdata: '573875805'
      - *RatingSet

  Переход в рекомендации [manual]:
    - tags:
        - skip_manual_check
    - automation: SERP-135998
    - do: выполнить авторизацию пользователем, у которого оценено более 10 фильмов (или сериалов/мультфильмов/передач и т.п.)
    - assert: авторизация выполнена
    - do: получить выдачу по запросу "Тихое место" (альтернативные запросы '1+1', 'лжец, лжец', 'веном')
    - assert: на выдаче присутствует карточка объектного ответа
    - do: если фильм не оценён, выставить оценку. Если оценён, шаг можно пропустить
    - assert: в карточке присутствует/появился блок "Ваша оценка"
    - do: нажать на вопросик в кружочке у блока "Ваша оценка"
    - assert: |
        появился попап
        примерный внешний вид [https://jing.yandex-team.ru/files/eksamoylova/2021-05-11_16.36.03-bt2cr.png]
    - do: нажать на кнопку 'Мои рекомендации'
    - assert: |
        выдача обновилась
        запрос поменялся на 'фильмы'
        присутствует карусель с подборкой фильмов (могут также присутствовать сериалы и мультфильмы, это не баг)

  Возврат к выдаче неавторизованным пользователем [manual]:
    - tags:
        - skip_manual_check
    - automation: SERP-135998
    - do: залогиниться в Яндексе и выйти из аккаунта
    - do: неавторизованным пользователем получить выдачу по запросу 'Тихое место' (альтернативные запросы '1+1', 'лжец, лжец', 'веном')
    - assert: на выдаче присутствует карточка объектного ответа
    - do: |
        в карточке объектного ответа поставить любую оценку в блоке оценки
        в случае появления плашки с вопросом «Это вы?» и предложением залогиниться выбрать пункт «не сейчас»
    - assert: |
        появился попап
        примерный внешний вид (кнопка 'Оценить фильмы' может отсутствовать) [https://jing.yandex-team.ru/files/eksamoylova/2021-05-12_10.07.35-xccuz.png]
    - do: нажать на кнопку "Войти и сохранить оценки"
    - assert: открылась страница паспорта
    - do: нажать назад (стрелочка у карточки в паспорте, НЕ браузерная)
    - assert: произошел возврат к выдаче по запросу
    - do: нажать на кнопку "Войти"
    - assert: открылась страница входа в Яндекс.ID
    - do: нажать назад (стрелочка у карточки входа в левом верхнем углу, НЕ браузерная)
    - assert: произошел возврат к выдаче
    - assert: |
        открыта страница поисковой выдачи
        проставленная ранее оценка сохранена в карточке объектного ответа

files:
  - features/touch-phone/z-entity-search/review/review.hermione.js
  - features/touch-phone/z-entity-search/review/review.hermione.e2e.js

v-team: OO

tlds: ru
