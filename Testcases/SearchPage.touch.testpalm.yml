feature: SearchPage

specs:
  Саджест:
    - do: открыть https://yandex.ru/products/search?text=iphone
    - do: ввести в поисковую строку запрос «ipho»
    - assert: появились подсказки под поисковой строкой (саджест)
    - do: нажать на первую подсказку
    - assert: в поисковую строку подставился текст выбранной подсказки
    - do: нажать на кнопку «Найти»
    - assert: |
        саджест скрылся
        появилась выдача по сформированному запросу

  Сортировка → Фильтр по цене → Сортировка:
    - do: открыть https://yandex.ru/products/search?text=iphone
    - assert: повилась кнопка сортировки выдачи и фильтрации по цене
    - do: |
        нажать на кнопку сортировки выдачи
        выбрать «Сначала недорогие»
    - tech: сработал счетчик event "click", по пути $page.$main.product-list-sorting
    - assert: |
        выдача поменялась в соответствии с выбранной сортировкой
        в адресной строке браузера появился параметр `order=aprice`
    - do: |
        нажать на кнопку фильтрации по цене
        ввести в поле «от» значение «50000»
        нажать на кнопку «Применить»
    - tech: сработал счетчик event "click", по пути $page.$main.product-list-price-filter
    - assert: |
        выдача поменялась в соответствии с выбранным фильтром и сортировкой
        в адресной строке браузера появился параметр `pricefrom=50000`
    - do: |
        нажать на кнопку сортировки выдачи
        выбрать «По популярности»
    - tech: сработал счетчик event "click", по пути $page.$main.product-list-sorting
    - assert: |
        выдача поменялась в соответствии с выбранным фильтром и сортировкой
        в адресной строке браузера появился параметр `order=dpop`
        в адресной строке браузера сохранился параметр `pricefrom=50000`

  Сортировка → Очистка запроса на крестик:
  before:
    - do: открыть https://yandex.ru/products/search?text=iphone
    - assert: |
        в поисковом поле текст iphone
        повилась кнопка сортировки выдачи
    - do: |
        нажать на кнопку сортировки выдачи
        выбрать «Сначала недорогие»
    - tech: сработал счетчик event "click", по пути $page.$main.product-list-sorting
    - assert: выдача поменялась в соответствии с выбранной сортировкой
    - do: нажать на крестик в поисковом поле
    - assert: текст в поле поиска очистился

  Сортировка:
    Применение параметра order:
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: повилась кнопка сортировки выдачи
      - do: нажать на кнопку сортировки выдачи
      - do: выбрать в селекте «Сначала недорогие»
      - tech: сработал счетчик event "click", по пути $page.$main.product-list-sorting
      - assert: |
          выдача поменялась в соответствии с выбранной сортировкой
          в адресной строке браузера появился параметр `order=aprice`
      - do: нажать на кнопку сортировки выдачи
      - do: выбрать в селекте «Сначала подороже»
      - tech: сработал счетчик event "click", по пути $page.$main.product-list-sorting
      - assert: |
          выдача поменялась в соответствии с выбранной сортировкой
          в адресной строке браузера появился параметр `order=dprice`

    Применение параметра категорий:
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: повилась кнопка сортировки выдачи
      - do: нажать на кнопку сортировки выдачи
      - do: выбрать в селекте «Сначала недорогие»
      - tech: сработал счетчик event "click", по пути $page.$main.product-list-sorting
      - assert: выдача поменялась в соответствии с выбранной сортировкой

  Избранное:
    - params:
        exp_flags:
          - enable_favorites=1
    - do: открыть https://yandex.ru/products/search?text=iphone
    - assert: |
        появилась выдача по запросу
        на карточке товара есть иконка Избранного
    - screenshot: внешний вид [plain]

  Параметр rs:
    Должен сбрасываться при изменении сортировки:
      - tags:
          - no_assessors
      - do: открыть https://yandex.ru/products/search?text=iphone&rs=foo
      - do: выбрать сортировку «сначала недорогие»
      - assert: в запросе за отсортированной выдачей отсутствует параметр rs

  Сообщение о потери сети:
    - do: открыть https://yandex.ru/products/search?text=iphone
    - assert: повилась кнопка сортировки выдачи
    - do: |
        выключить доступ в интернет
        нажать на кнопку сортировки выдачи
        выбрать в селекте «Сначала недорогие»
    - assert: появилось сообщение «Нет интернета»

  Флаг tabs_order_version:
    - params:
        exp_flags:
          - tabs_order_version=search,images,video,products,all
    - do: открыть https://yandex.ru/products/search?text=iphone
    - assert: появилась навигация
    - screenshot: в навигации присутствуют только табы из скриншота [plain]

  Темная тема:
    Внешний вид с настройкой темы "light":
      - params:
          exp_flags:
            - dark_theme_touch=light
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: появилась выдача по запросу
      - screenshot: внешний вид [theme_light]

    Внешний вид с настройкой темы "dark":
      - params:
          exp_flags:
            - dark_theme_touch=dark
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: появилась выдача по запросу
      - screenshot: внешний вид [theme_dark]

    Внешний вид с настройкой темы "system":
      - params:
          exp_flags:
            - dark_theme_touch=system
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: появилась выдача по запросу
      - screenshot: внешний вид [theme_system]

    Переключение системной темы под настройкой темы "system":
      - params:
          exp_flags:
            - dark_theme_touch=system
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: появилась выдача по запросу
      - screenshot: внешний вид [theme_system_before]
      - do: переключить в браузере дефолтную тему на темную
      - screenshot: внешний вид [theme_system_after]

  Баобаб:
    Отправка события show при переходе на выдачу:
      - tags:
          - no_assessors
      - do: открыть https://yandex.ru/products/product/1414986413/sku/101446177754
      - assert: открылась страница с товаром
      - do: нажать на крестик
      - tech: сработал счетчик event "show" с деревом выдачи

    При возврате на выдачу не должно отправляться событие show:
      - tags:
          - no_assessors
      - do: открыть https://yandex.ru/products/search?text=iphone%2012
      - assert: страница загрузилась
      - do: нажать на первую карточку товара
      - assert: открылась страница с товаром
      - do: нажать на крестик
      - tech: при возврате на выдачу дерево не отправилось повторно

    Отправка события show при сортировке выдачи:
      - tags:
          - no_assessors
      - do: открыть https://yandex.ru/products/search?text=iphone%2012
      - assert: открылась страница с товаром
      - do: |
          нажать на кнопку сортировки выдачи
          выбрать «Сначала недорогие»
      - tech: |
          новое баобаб дерево после сортировки залогировалось с событием "show"
          в url в атрибутах дерева залогирована ссылка с параметрами сортировки "order=aprice"

  Metrics:
    Запросы:
      - tags:
          - no_assessors
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: открылась поисковая выдача
      - do: нажать на первую карточку товара
      - assert: открылась страница с товаром
      - tech: |
          - метрика "products.all_requests" = 2
          - метрика "products.requests" = 1
          - метрика "products.sku_requests" = 1
      - do: нажать на крестик на карточке товара
      - tech: |
          - метрика "products.all_requests" = 2
          - метрика "products.requests" = 1
          - метрика "products.sku_requests" = 1

  Быстрые фильтры:
    Внешний вид:
      - params:
          exp_flags:
            - all_filters=1
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: |
          - открылась поисковая выдача
          - на выдаче присутствуют быстрые фильтры
      - screenshot: внешний вид [plain]

    Внешний вид примененных фильтров:
      - params:
          exp_flags:
            - all_filters=1
      - do: открыть https://yandex.ru/products/search?text=iphone&exp_flags=all_filters&glfilter=7893318%3A153043&priceto=50000
      - assert: |
          - открылась поисковая выдача
          - на выдаче присутствуют быстрые фильтры
      - screenshot: внешний вид [plain]

    Сброс фильтра по крестику:
      - params:
          exp_flags:
            - all_filters=1
      - do: открыть https://yandex.ru/products/search?text=iphone&exp_flags=all_filters&priceto=50000
      - assert: |
          - открылась поисковая выдача
          - на выдаче присутствуют быстрые фильтры
      - do: нажать в крестик в фильтре по цене
      - assert: |
          - фильтр сбросился
          - выдача перезагрузилась

    Сброс всех фильтров по крестику:
      - params:
          exp_flags:
            - all_filters=1
      - do: открыть https://yandex.ru/products/search?text=iphone&exp_flags=all_filters&glfilter=7893318%3A153043&priceto=50000
      - assert: |
          - открылась поисковая выдача
          - на выдаче присутствуют быстрые фильтры
      - do: нажать в крестик перед быстрыми фильтрами
      - assert: |
          - все фильтры сбросились
          - выдача перезагрузилась

  Категорийные фильтры:
    Фильтр по цене не сбрасывается при сортировке:
      - params:
          exp_flags:
            - all_filters=1
      - do: открыть https://yandex.ru/products/search?text=iphone&priceto=50000
      - assert: открылась поисковая выдача с примененным фильтром по цене
      - do: |
          нажать на кнопку сортировки выдачи
          выбрать «Сначала недорогие»
      - asset: |
          применилась сортировка
          остался фильтр по цене

  Врезка б/у:
    Поисковая выдача с врезкой б/у предложений:
      - params:
          exp_flags:
            - used_goods=1
            - used_goods_gallery=1
      - do: |
          открыть страницу поиска по товарам
          получить выдачу по запросу iphone
      - assert: |
          поисковая выдача загрузилась
          поисковая выдача содержит ровно 12 товаров
          поисковая выдача не содержит врезку б/у предложений
      - do: проскроллить поисковую выдачу до конца вниз
      - assert: |
          появилась врезка б/у предложений
          появилась выдача следующих 12 товаров после врезки б/у предложений
      - tech: |
          отправилось событие "append" с врезкой б/у предложений
          отправилось событие "append" с дозагруженными товарами

    Поисковая выдача без врезки б/у предложений:
      - params:
          exp_flags:
            - used_goods=1
            - used_goods_gallery=1
      - do: |
          открыть страницу поиска по товарам
          получить выдачу по запросу iphone
      - assert: |
          поисковая выдача загрузилась
          отображается кнопка фильтрации по б/у товарам
      - do: |
          нажать на кнопку фильтрации по б/у товарам
          выбрать «Б/У товары»
      - assert: |
          поисковая выдача загрузилась
          поисковая выдача содержит как минимум 12 товаров
          поисковая выдача не содержит врезку б/у предложений
      - do: проскроллить поисковую выдачу до конца вниз
      - assert: |
          появилась выдача следующих 12 товаров
          поисковая выдача не содержит врезку б/у предложений
      - tech: отправилось событие "append" с дозагруженными товарами

    Переход на страницу выдачи с врезки б/у предложений по ссылке "Частные объявления":
      - params:
          exp_flags:
            - used_goods=1
            - used_goods_gallery=1
      - do: |
          открыть страницу поиска по товарам
          получить выдачу по запросу iphone
      - assert: поисковая выдача загрузилась
      - do: проскроллить поисковую выдачу до конца вниз
      - assert: |
          появилась врезка б/у предложений
          появилась выдача следующих 12 товаров после врезки б/у предложений
      - tech: отправилось событие "append" с врезкой б/у предложений
      - do: кликнуть по ссылке "Частные объявления" во врезке б/у предложений
      - tech: сработал счетчик event "click", по пути $page.$main.$result.#type:wizard.used-products-gallery.used-goods-head-link
      - assert: |
          произошел переход на поисковую выдачу по б/у товарам
          отображается кнопка фильтрации по б/у товарам c выбранным значением «Б/У товары»
          поисковая выдача содержит как минимум 12 товаров
          поисковая выдача не содержит врезку б/у предложений
      - do: проскроллить поисковую выдачу до конца вниз
      - assert: |
          появилась выдача следующих 12 товаров
          поисковая выдача не содержит врезку б/у предложений

    Переход на страницу выдачи с врезки б/у предложений по ссылке "Посмотреть все":
      - params:
          exp_flags:
            - used_goods=1
            - used_goods_gallery=1
      - do: |
          открыть страницу поиска по товарам
          получить выдачу по запросу iphone
      - assert: поисковая выдача загрузилась
      - do: проскроллить поисковую выдачу до конца вниз
      - assert: |
          появилась врезка б/у предложений
          появилась выдача следующих 12 товаров после врезки б/у предложений
      - tech: отправилось событие "append" с врезкой б/у предложений
      - do: кликнуть по ссылке "Посмотреть все" во врезке б/у предложений
      - tech: сработал счетчик event "click", по пути $page.$main.$result.#type:wizard.used-products-gallery.used-goods-link
      - assert: |
          произошел переход на поисковую выдачу по б/у товарам
          отображается кнопка фильтрации по б/у товарам c выбранным значением «Б/У товары»
          поисковая выдача содержит как минимум 12 товаров
          поисковая выдача не содержит врезку б/у предложений
      - do: проскроллить поисковую выдачу до конца вниз
      - assert: |
          появилась выдача следующих 12 товаров
          поисковая выдача не содержит врезку б/у предложений

    Переход на страницу оффера с врезки б/у предложений:
      - params:
          exp_flags:
            - used_goods=1
            - used_goods_gallery=1
      - do: |
          открыть страницу поиска по товарам
          получить выдачу по запросу iphone
      - assert: поисковая выдача загрузилась
      - do: проскроллить поисковую выдачу до конца вниз
      - assert: |
          появилась врезка б/у предложений
          появилась выдача следующих 12 товаров после врезки б/у предложений
      - tech: отправилось событие "append" с врезкой б/у предложений
      - do: |
          проскроллить список офферов до конца вправо во врезке б/у предложений
          кликнуть на последний в списке оффер
      - assert: открылась страница оффера
      - tech: Отправилась цель 'from-search-to-offer' с параметрами "offerId = <id оффера>"

v-team: goods

files:
    - src/pages/SearchPage/tests/SearchPage.touch.hermione.ts
