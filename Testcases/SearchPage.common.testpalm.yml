feature: SearchPage

specs:
  Поиск, выдача и отсутствие оффера:
    - do: открыть https://yandex.ru/products/search?text=iphone&offer_does_not_exist=1
    - assert: |
        поисковая строка пустая
        вкладка имеет заголовок «iphone — Поиск по товарам»
        есть сообщение "Похоже, что такого товара больше нет"
    - screenshot: внешний вид [plain]

  Пустая выдача и отсутствие оффера:
    - do: открыть https://yandex.ru/products/search?offer_does_not_exist=1
    - assert: |
        поисковая строка пустая
        есть сообщение "Похоже, что такого товара больше нет"

  Очистка поисковой строки:
    - do: открыть https://yandex.ru/products/search?text=iphone
    - assert: поисковая строка имеет значение «iphone»
    - do: нажать на крестик справа от поисковой строки
    - assert: поисковая строка пустая

  Редирект:
    - do: открыть https://yandex.ru/products?text=iphone
    - assert: произошла переадресация на адрес https://yandex.ru/products/search?text=iphone

  Опечатка:
    - do: открыть https://yandex.ru/products/search?text=кампьютер
    - assert:
        появился блок с исправлением опечатки (опечаточник)
        в поисковой строке запрос исправился на «компьютер»
    - do: нажать на кнопку «Отменить» в блоке опечаточника
    - assert: |
        опечаточник скрылся
        в поисковой строке появился запрос «кампьютер»
        в адресной строке браузера появился параметр `noreask=1`

  Дозагрузка:
    - params:
        exp_flags:
          - more_button_items_count=24
    - do: открыть https://yandex.ru/products/search?text=iphone
    - assert: на выдаче как минимум 12 товаров
    - do: проскроллить страницу до конца вниз
    - assert: |
        загрузилась следующая порция товаров
        появилась кнопка «Показать ещё»

  Пустая выдача:
    - do: открыть https://yandex.ru/products/search?text=0
    - assert: страница отображается корректно, футер находится внизу страницы

  Сортировка:
    Внешний вид без иконки:
      - params:
          exp_flags:
            - hide_sort_icon=1
      - do: открыть https://yandex.ru/products/search?text=iphone&exp_flags=hide_sort_icon=1
      - assert: фильтр сортировки отображается без иконки
      - screenshot: внешний вид фильтра [plain]

  Фильтр б/у:
    Присутствует в списке быстрых фильтров на третьей позиции:
      - params:
          exp_flags:
            - used_goods=1
      - do: |
          открыть страницу поиска по товарам
          получить выдачу по запросу iphone
      - assert: |
          появился блок с быстрыми фильтрами
          на третьем месте в блоке с быстрыми фильтрами отображается фильтр "Состояние"
      - screenshot: внешний вид фильтра "Состояние" [used-goods-quick-filter]

  Параметр rs:
    Должен присутствовать при дозагрузке:
      - tags:
          - no_assessors
      - do: открыть https://yandex.ru/products/search?text=iphone&rs=foo
      - do: |
          проскроллить страницу до конца вниз
          дождаться загрузки следующей страницы выдачи
      - assert: в запросе за следующей страницей присутствует параметр rs

  Фильтр по цене:
    Внешний вид:
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: выдача загрузилась
      - do: нажать на кнопку "Цена" в блоке фильтров
      - assert: появилась форма ввода цены
      - screenshot: внешний вид формы [plain]

    Цена от:
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: выдача загрузилась
      - do: нажать на кнопку "Цена" в блоке фильтров
      - tech: сработал счетчик event "click", по пути $page.$main.product-list-price-filter.button
      - assert: появилась форма ввода цены
      - do: |
          ввести 50000 в поле ввода "от"
          нажать на "Enter" на клавиатуре
          нажать на кнопку "Применить"
      - tech: сработал счетчик event "click", по пути $page.$main.product-list-price-filter
      - assert: форма ввода цены скрылась
      - screenshot: внешний вид кнопки [button]

    Цена до:
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: выдача загрузилась
      - do: нажать на кнопку "Цена" в блоке фильтров
      - tech: сработал счетчик event "click", по пути $page.$main.product-list-price-filter.button
      - assert: появилась форма ввода цены
      - do: |
          ввести 20000 в поле ввода "до"
          нажать на "Enter" на клавиатуре
          нажать на кнопку "Применить"
      - tech: сработал счетчик event "click", по пути $page.$main.product-list-price-filter
      - assert: форма ввода цены скрылась
      - screenshot: внешний вид кнопки [button]

    Обе цены:
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: выдача загрузилась
      - do: нажать на кнопку "Цена" в блоке фильтров
      - tech: сработал счетчик event "click", по пути $page.$main.product-list-price-filter.button
      - assert: появилась форма ввода цены
      - do: |
          ввести 10000 в поле ввода "от"
          ввести 20000 в поле ввода "до"
          нажать на "Enter" на клавиатуре
          нажать на кнопку "Применить"
      - tech: сработал счетчик event "click", по пути $page.$main.product-list-price-filter
      - assert: форма ввода цены скрылась
      - screenshot: внешний вид кнопки [button]

    Без товаров:
      - do: открыть https://yandex.ru/products/search?text=iphone&pricefrom=7000000
      - assert: |
          появилось сообщение "Задан пустой поисковый запрос"
          на странице присутствует фильтр по цене

    Не появляется рекламная галлерея после применения фильтра [manual]:
      # тест не удалось автоматизировать, так как данные БКО отдаются только "живому" пользователю
      - automation: GOODS-1461
      - do: залогиниться на yandex.ru
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: выдача загрузилась
      - do: нажать на кнопку "Цена" в блоке фильтров
      - assert: появилась форма ввода цены
      - do: |
          ввести 10000 в поле ввода "от"
          ввести 20000 в поле ввода "до"
          нажать на "Enter" на клавиатуре
          нажать на кнопку "Применить"
      - assert: |
          форма ввода цены скрылась
          выдача обновилась
          на странице не появилась рекламная галлерея сверху выдачи

  Баобаб:
    Отправка дерева в blockstat:
      - tags:
          - no_assessors
      - do: открыть https://yandex.ru/products/search?text=iphone%2012
      - assert: страница загрузилась
      - tech: |
          в blockstat отправилось баобаб дерево с событием "show"
          у дерева есть атрибут "subservice" со значение "search"
          при загрузке страницы не было отправлено redir счетчиков

    Соответствие деревьев на клиенте и на сервере:
      - tags:
          - no_assessors
      - params:
          exp_flags:
            - validate_cointers=1
      - do: открыть https://yandex.ru/products/search?text=iphone%2012
      - assert: страница загрузилась
      - tech: баобаб дерево, отправленное в blockstat, соответствует клиентскому дереву

    Отправка события show при фильтрации выдачи по цене:
      - tags:
          - no_assessors
      - do: открыть https://yandex.ru/products/search?text=iphone%2012
      - assert: страница загрузилась
      - do: |
          ввести 10000 в поле ввода "от"
          нажать на "Enter" на клавиатуре
          нажать на кнопку "Применить"
      - tech: |
          новое баобаб дерево после фильтрации залогировалось с событием "show"
          в url в атрибутах дерева залогирована ссылка с параметрами фильтрации "pricefrom=90000"

    Отправка parent-reqid в url-атрибуте $page:
      - tags:
          - no_assessors
      - do: открыть https://yandex.ru/products/search?text=iphone%2012&parent-reqid=123
      - assert: страница загрузилась
      - tech: |
          parent-reqid присутствует в url-атрибуте $page
          parent-reqid удален из url страницы

  Залогин в шапке:
    После открытия и закрытия оффера:
      - tags:
          - no_assessors
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: страница загрузилась
      - do: |
          нажать на любой товар
          нажать на крестик
          нажать на аватар в шапке
      - assert: открылся попап с информацией об аккаунте

    Логирование дозагруки выдачи:
      - tags:
          - no_assessors
      - do: открыть https://yandex.ru/products/search?text=iphone%2012
      - assert: страница загрузилась
      - do: проскролить страницу в самый низ
      - assert: загрузилась следующая страница
      - tech: |
          отправилось событие "append" с дозагруженными товарами
          ноды дозагруженных товаров добавились в блок $main начального дерева

  Цели метрики:
    По переходу на оффер:
      - do: открыть https://yandex.ru/products/search?text=олег+газманов
      - assert: страница загрузилась
      - do: нажать на любой оффер
      - tech: Отправилась цель 'from-search-to-offer' с параметрами "offerId = <id оффера>"

    По переходу на sku:
      - do: открыть https://yandex.ru/products/search?text=iphone
      - assert: страница загрузилась
      - do: нажать на любой sku
      - tech: Отправилась цель 'from-search-to-sku' с параметрами "skuId = <id sku>"

    Старт сессии:
      Отправляется при первом заходе:
        - do: открыть в режиме инкогнито https://yandex.ru/products/search?text=iphone
        - tech: отправилась одна цель 'ecom-session-start'

      Не отправляется при повторном заходе в течение таймаута одной сессии:
        - do: открыть https://yandex.ru/products/search?text=iphone
        - tech: |
            в консоли выполнить скрипт
            'localStorage.setItem("PRODUCTS_ecomSession", JSON.stringify({ lastTick: now - 25 * 60 * 1000 }))'
        - do: сразу обновить страницу
        - assert: не отправилось событие 'ecom-session-start'

      Отправляется при повторном заходе после таймаута одной сессии:
        - do: открыть https://yandex.ru/products/search?text=iphone
        - tech: |
            в консоли выполнить скрипт
            'localStorage.setItem("PRODUCTS_ecomSession", JSON.stringify({ lastTick: now - 35 * 60 * 1000 }))'
        - do: сразу обновить страницу
        - assert: отправилось событие 'ecom-session-start'

  Товарная галерея:
    - do: открыть https://yandex.ru/products/search?text=xbox&exp_flags=with_rich_media_gallery=1
    - assert: на выдаче присуствует Товарная галерея с меткой "реклама"
    - screenshot: пример внешнего вида выдачи с Товарной галереей (содержимое может отличаться) [with-product-gallery]

v-team: goods

files:
    - src/pages/SearchPage/tests/SearchPage.common.hermione.ts
