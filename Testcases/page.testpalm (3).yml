feature: Page

tlds: ru

specs:
  aliases:
    &OpenLink
      - do: открыть ссылку yandex.ru/turbo?text=news-infinite-1
      - assert: открывается турбо-страница в той же вкладке (в поисковом приложении Яндекс турбо-страница открывается в новой вкладке)

  afterEach:
    - tech: не должно быть клиентских ошибок

  Должен менять url при скролле бесконечной ленты:
    - browsers:
        notFor:
          - searchapp
          - android-pp-4.99-touch
          - android-pp-7-touch
    - *OpenLink
    - assert: загрузилась первая новость
    - do: проверить урл в адресной строке
    - assert: в адресной строке url https://yandex.ru/turbo?text=news-infinite-1
    - do: скроллить страницу вниз до конца
    - assert: подгрузилась вторая новость
    - do: скроллить страницу вниз, пока вторая новость не будет занимать 20% от viewport
    - do: проверить урл в адресной строке
    - assert: в адресной строке url https://yandex.ru/turbo?text=news-infinite-2
    - do: проскроллить вторую статью до конца
    - do: скроллить страницу вверх до начала первой статьи
    - assert: в адресной строке url https://yandex.ru/turbo?text=news-infinite-1

  Не должен менять URL при скролле безконечной ленты, если есть cgi=no_friendly_url:
    - browsers:
        notFor:
          - searchapp
          - android-pp-4.99-touch
          - android-pp-7-touch
    - do: открыть ссылку yandex.ru/turbo?text=news-infinite-1&no_friendly_url=1
    - assert: открывается турбо-страница в той же вкладке (в поисковом приложении Яндекс турбо-страница открывается в новой вкладке)
    - assert: загрузилась первая новость
    - do: проверить урл в адресной строке
    - assert: в адресной строке url https://yandex.ru/turbo?text=news-infinite-1&no_friendly_url=1
    - do: скроллить страницу вниз до конца
    - assert: подгрузилась вторая новость
    - do: скроллить страницу вниз, пока вторая новость не будет занимать 20% от viewport
    - do: проверить урл в адресной строке
    - assert: в адресной строке url https://yandex.ru/turbo?text=news-infinite-1&no_friendly_url=1
    - do: скроллить страницу вверх до начала документа
    - assert: в адресной строке url https://yandex.ru/turbo?text=news-infinite-1&no_friendly_url=1

  Должен меняться title документа при скролле бесконечной ленты:
    - tags: no_assessors
    - *OpenLink
    - assert: загрузилась первая новость
    - assert: title документа содержит "ЕВС рассмотрит вопрос о нарушении правил "Евровидения" в Киеве после завершения конкурса"
    - do: скроллить страницу вниз до конца
    - assert: подгрузилась вторая новость
    - do: скроллить страницу вниз, пока вторая новость не будет занимать 20% от viewport
    - assert: title документа изменился на "Совершенно другой title"
    - do: скроллить страницу вверх до начала документа
    - assert: title документа  изменился на "ЕВС рассмотрит вопрос о нарушении правил "Евровидения" в Киеве после завершения конкурса"

  Флаг отключающий изменение url и title при скролле:
    - browsers:
        notFor:
          - searchapp
          - android-pp-4.99-touch
          - android-pp-7-touch
    - tags: no_assessors
    - do: открыть ссылку yandex.ru/turbo?text=bin:url-replacement-disabled
    - assert: открывается турбо-страница в той же вкладке (в поисковом приложении Яндекс турбо-страница открывается в новой вкладке)
    - assert: загрузилась первая новость
    - do: проверить урл в адресной строке
    - assert: в адресной строке url https://yandex.ru/turbo?text=bin:url-replacement-disabled
    - assert: title документа содержит "ЕВС рассмотрит вопрос о нарушении правил "Евровидения" в Киеве после завершения конкурса"
    - do: скроллить страницу вниз до конца
    - assert: подгрузилась вторая новость
    - do: скроллить страницу вниз, пока вторая новость не будет занимать 20% от viewport
    - do: проверить урл в адресной строке
    - assert: в адресной строке url https://yandex.ru/turbo?text=bin:url-replacement-disabled
    - assert: title документа содержит "ЕВС рассмотрит вопрос о нарушении правил "Евровидения" в Киеве после завершения конкурса"

  Должен отправлять postMessage при скролле бесконечной ленты:
    - tags: no_assessors
    - *OpenLink
    - assert: загрузилась первая новость
    - do: скроллить страницу вниз до конца
    - assert: подгрузилась вторая новость
    - do: скроллить страницу вниз, пока вторая новость не будет занимать 20% от viewport
    - tech: должен отправиться postMessage 'active-document-changed'

  Должен отправлять postMessage при скролле бесконечной ленты внутри iframe:
    - tags: no_assessors
    - params:
        foreverdata: '2251695851'
    - do: получить выдачу по запросу 'foreverdata' и кликнуть в заголовок первого сниппета (название заголовка Тестовая страница для NewsInfinite-1 — турбо)
    - assert: открывается турбо-страница в той же вкладке (в поисковом приложении Яндекс турбо-страница открывается в новой вкладке)
    - assert: загрузилась первая новость
    - do: скроллить страницу вниз до конца
    - assert: подгрузилась вторая новость
    - do: скроллить страницу вниз, пока вторая новость не будет занимать 20% от viewport
    - tech: должен отправиться postMessage 'active-document-changed'
    - do: скроллить страницу вверх до начала документа
    - tech: должен отправиться postMessage 'active-document-changed'

  Должна устанавливаться cookie turbo_uid, если был передан CGI параметр turbo_uid:
    - tags: no_assessors
    - do: открыть ссылку yandex.ru/turbo?text=news-infinite-1&turbo_uid=asdas123124
    - assert: открывается турбо-страница в той же вкладке (в поисковом приложении Яндекс турбо-страница открывается в новой вкладке)
    - tech: должна установиться cookie turbo_uid со значением asdas123124

  Должен отдаваться приоритет turbo_uid из CGI, а не из данных:
    - tags: no_assessors
    - description: данный сценарий возможно выполнить только в темпларе
    - do: открыть ссылку https://yandex.ru/turbo?text=news-infinite-1&turbo_uid=111&setReqData=turboUid,222&patch=setReqData
    - assert: открывается турбо-страница в той же вкладке (в поисковом приложении Яндекс турбо-страница открывается в новой вкладке)
    - tech: должна установиться cookie turbo_uid со значением 111

  Должен отправлять heart-beat текущей статьи:
    - tags: no_assessors
    - *OpenLink
    - assert: загрузилась первая статья
    - tech: отправился первый харт-бит первой статьи с `{ iteration 0, time 1 }`
    - do: подождать 3 секунды
    - tech: отправился третий харт-бит первой статьи с `{ iteration 2, time 2.56 }`
    - do: скроллить страницу вниз до конца
    - assert: подгрузилась вторая статья
    - do: скроллить страницу вниз, пока вторая новость не будет занимать 20% от viewport
    - tech: отправился первый харт-бит второй статьи с `{ iteration 0, time 1 }`
    - do: скроллить страницу вверх до начала документа
    - tech: отправился новый первый харт-бит первой статьи с `{ iteration 0, time 1 }`

files:
  - features/blocks/page/page.hermione.js

v-team: Turbo

manager: tanzwuta

qa-engineer: olga0321, dakhetov
