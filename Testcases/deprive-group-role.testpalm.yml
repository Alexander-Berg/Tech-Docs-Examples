feature: Добавление и удаление департамента

specs:
  beforeEach:
    - do: (PREPARE) запустить в Runner сценарий "api/v4/services/departments/ POST + DELETE" (https://github.yandex-team.ru/pixel/abc-runner)
    - do: (PREPARE) проверить, что robot-cat-leopold является руководителем в сервисе с id=4075 (/services/postmanaddrolesdepartment3/)
    - do: (PREPARE) проверить, что в сервисе с id=4075 не выданы никакие роли на департаменты (/services/postmanaddrolesdepartment3/)
    - do: (PREPARE) проверить, что robot-cat-leopold является руководителем в сервисе с id=4076 (/services/postmanaddrolesdepartment4/)
    - do: (PREPARE) проверить, что в сервисе с id=4076 не выданы никакие роли на департаменты (/services/postmanaddrolesdepartment4/)
    - do: (PREPARE) проверить, что robot-cat-leopold является руководителем в сервисе с id=4082 (/services/postmanaddrolesdepartment6/)
    - do: (PREPARE) проверить, что в сервисе с id=4082 не выданы никакие роли на департаменты (/services/postmanaddrolesdepartment6/)
    - do: (PREPARE) проверить, что robot-cat-leopold является управляющим в сервисе с id=3921 (/services/postman_add_roles_departments_2/)
    - do: (PREPARE) проверить, что в сервисе с id=3921 не выданы никакие роли на департаменты (/services/postman_add_roles_departments_2/)
    - do: (PREPARE) проверить, что robot-internal-002 имеет роль "DevOps" в сервисе с id=3921 (/services/postman_add_roles_departments_2/)
    - do: (PREPARE) проверить, что robot-internal-003 не имеет ролей в сервисе с id=3921 (/services/postman_add_roles_departments_2/)    
 
  Добавление и удаление бессрочной роли на департамент руководителем сервиса:
    - do: отправить запрос "Запрос с автоапрувом бессрочной роли на департамент" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Нельзя запросить выданную роль" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Нельзя запросить выданную роль" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-15%2018-42-09.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запрос id бессрочной роли" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Запрос id бессрочной роли" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2012-26-34.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление групповой роли из сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление отозванной групповой роли из сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "404" 
    - screenshot: ответ на запрос "Удаление отозванной групповой роли из сервиса" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2012-30-55.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Добавление и удаление бессрочной роли на стафф-департамент руквоводителем сервиса:
    - do: отправить запрос "Запрос  с автоапрувом бессрочной роли на стафф департамент" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Стафф департамент игнорируется при наличии департамента" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Нельзя запросить выданную роль на стафф департамент" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "409"
    - screenshot: ответ на запрос "Нельзя запросить выданную роль на стафф департамент" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2012-59-03.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запрос id бессрочной роли стафф" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Запрос id бессрочной роли стафф" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2013-23-16.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запрос id роли на департамент" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Запрос id роли на департамент" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2013-23-56.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление групповой роли выданной по стафф-департаменту" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление групповой роли департамента" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Добавление и удаление роли на срок для департамента руководителем сервиса:
    - do: отправить запрос "Запрос с автоапрувом групповой роли на срок" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запрос id роли на срок" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Запрос id роли на срок" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2013-32-23.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление групповой роли на срок из сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Добавление и удаление роли до даты для департамента руководителем сервиса:
    - do: отправить запрос "Запрос с автоапрувом групповой роли до даты" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запрос id роли до даты" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Запрос id роли до даты" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2013-32-23.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление групповой роли до даты из сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Пользователь с ограниченной ролью не может добавлять департамент:
    - do: отправить запрос "Запрос с автоапрувом бессрочной роли на департамент Ограниченная роль" с токеном "robot-cat-matroskin"
    - assert: пришёл ответ со статусом "403" и телом "Your permissions are not enough"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"    

  Пользователь с сильно ограниченной ролью не может добавлять департамент:
    - do: отправить запрос "Запрос с автоапрувом бессрочной роли на департамент Сильно ограниченная роль" с токеном "robot-cat-bayun"
    - assert: пришёл ответ со статусом "403" и телом "Your permissions are not enough"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"  

  Пользователь без роли в ABC не может добавлять департамент:
    - do: отправить запрос "Запрос  с автоапрувом бессрочной роли на департамент (без роли)" с токеном "arnold"
    - assert: пришёл ответ со статусом "403" и телом "Your permissions are not enough"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"  

  Пользователь с ограниченной ролью не может удалять департамент:
    - do: отправить запрос "Удаление групповой роли из сервиса (ограниченная роль)" с токеном "robot-cat-matroskin"
    - assert: пришёл ответ со статусом "403" и телом "Your permissions are not enough"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"    

  Пользователь с сильно ограниченной ролью не может удалять департамент:
    - do: отправить запрос "Удаление групповой роли из сервиса (сильно ограниченная роль)" с токеном "robot-cat-bayun"
    - assert: пришёл ответ со статусом "403" и телом "Your permissions are not enough"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PAS

  Пользователь без роли в сервисе не может удалять департамент:
    - do: отправить запрос "Удаление групповой роли из сервиса (без роли)" с токеном "robot-cat-bayun"
    - assert: пришёл ответ со статусом "403" и телом "Your permissions are not enough"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"  

  Добавлять уже добавленный департамент нельзя: 
    - do: (PREPARE) проверить, что в сервисе "postman_add_roles_departments_3" добавлена группа "Служба экономической безопасности" с ролью "Менеджер по маркетингу" (/services/postmanaddrolesdepartment3/)
    - do: отправить запрос "Нельзя запросить выданную роль" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "409"
    - screenshot: ответ на запрос "Нельзя запросить выданную роль" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2012-22-58.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Добавление и удаление роли для департамента участником сервиса:
    - do: отправить запрос "Запросить роль на департамент (участник сервиса)" с токеном "robot-internal-002"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Нельзя запросить запрошенную роль (участник сервиса)" с токеном "robot-internal-002"
    - assert: пришёл ответ со статусом "409"
    - screenshot: ответ на запрос "Нельзя запросить запрошенную роль (участник сервиса)" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2013-48-58.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "[IDM] забираем id запроса от участника сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2013-52-12.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "[IDM] Удаление запроса от участника сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Добавление и удаление роли для департамента не-участником сервиса:
    - do: отправить запрос "Запросить роль на департамент (не участник сервиса)" с токеном "robot-internal-003"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "[IDM] забираем id запроса от не участника сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "[IDM] забираем id запроса от не участника сервиса" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2013-55-12.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "[IDM] Удаление запроса от не участника сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Валидация параметров запросов: 
    - do: отправить запрос "Удаление без id" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "405"
    - screenshot: ответ на запрос "Удаление без id" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-15%2019-00-06.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS" 
    - do: отправить запрос "Запрос с двумя параметрами даты" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "400"
    - screenshot: ответ на запрос "Запрос с двумя параметрами даты" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-25%2013-57-51.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS" 

  Пользователь с базовой ролью не может удалять департаменты из того сервиса, в котором он не состоит:
    - do: (PREPARE) проверить, что пользователь "robot-cat-leopold" не имеет ролей в сервисе с id=4476 (/services/kotovets/)
    - do: отправить запрос "С базовой ролью нельзя удалять группы в сервисе, в котором не состоишь " с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "403" 
    - screenshot: ответ на запрос содержит поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-15%2019-06-25.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"    


priority: blocker

files:
  - tests/unit/services/api/test_departments.py

tags:
  - reviewed
  - no_assessors
  - postman_automation
  - fitcher:abc:src/blocks/desktop/service-team-editor/**
  - fitcher:abc:src/blocks/desktop/service-team-department/**
  - fitcher:abc:src/blocks/desktop/service-team-member/** 
  - fitcher:abc:src/blocks/desktop/service-team-editor-member/** 
  - fitcher:abc:src/blocks/desktop/service-team-editor-department/**
  - fitcher:plan:develop/tests/unit/services/api/test_departments.py
