feature: Голосовой поиск
type: Голосовой ввод

description: предварительно в Настройках телефона надо дать разрешение приложению на доступ к микрофону, если доступа нет(в разделе Приложения на Android и в разделе Конфиденциальность на iOS)

specs:
  Внешний вид Голосового поиска с введенным запросом:
    - label: voice-search-{{SET_NAME}}
    - do: получить выдачу по запросу "погода в Москве"
    - screenshot: внешний вид строки поиска [plain]
  Проверка голосового ввода:
    Короткий запрос [manual]:
      - automation: SERP-85896
      - tags: [smoke, smoke_ext, smoke_extended, skip_manual_check]
      - do: получить выдачу по запросу "погода в москве"
      - do: кликнуть крестик в поисковой строке
      - do: кликнуть иконку микрофона в поисковой строке
      - assert: появился попап голосового ввода
      - assert: надпись "Говорите..." совершает волнообразные движения
      - do: произнести короткий поисковый запрос "москва"
      - assert: на месте надписи "Говорите" появляется распознанный запрос
      - assert: во время произнесения запроса снизу мигает желтый индикатор
      - assert: после завершения голосового ввода попап исчез
      - assert: выдача обновилась ajax-перезапросом
      - assert: в инпуте запрос "москва"
      - assertMetrics: '*'
    Длинный запрос [manual]:
      - automation: SERP-85896
      - tags: skip_manual_check
      - do: получить выдачу по запросу "погода в москве"
      - do: кликнуть крестик в поисковой строке
      - do: кликнуть иконку микрофона в поисковой строке
      - assert: появился попап голосового ввода
      - assert: надпись "Говорите..." совершает волнообразные движения
      - do: произнести длинный поисковый запрос "погода в санкт-петербурге на 14 дней от гидрометцентра Российкой Федерации"
      - assert: на месте надписи "Говорите" появляется распознанный запрос
      - assert: когда запрос перестает умещаться в попапе, текст переносится на новую строку
      - assert: во время произнесения запроса снизу мигает желтый индикатор
      - assert: после завершения голосового ввода попап исчез
      - assert: выдача обновилась ajax-перезапросом
      - assert: в инпуте запрос "погода в санкт-петербурге на 14 дней от гидрометцентра Российкой Федерации"
      - assertMetrics: '*'
    Распознавание останавливается при свертывании браузера [manual]:
      - automation: SERP-85896
      - tags: skip_manual_check
      - do: получить выдачу по запросу "погода в москве"
      - assert: получена выдача по указанному запросу
      - do: кликнуть крестик в поисковой строке
      - assert: поисковая стрелка очишена
      - do: кликнуть иконку микрофона в поисковой строке
      - assert: появился попап голосового ввода
      - do: свернуть браузер
      - do: произнести поисковый запрос "москва"
      - do: снова открыть браузер
      - assert: попап голосового ввода отсутствует
      - assert: в поисковой стрелке отсутствует запрос
      - assertMetrics: '*'
  Проверка интерфейса:
    beforeEach:
      - do: получить выдачу по запросу "погода в Москве"
      - screenshot: внешний вид строки поиска [voice-search-{{SET_NAME}} >> plain]
      - assert: крестик виден
      - do: кликнуть крестик
      - assert: поисковый инпут пуст
      - assert: крестик отсутствует
    Внешний вид Голосового поиска:
      - label: voice-{{SET_NAME}}
      - screenshot: внешний вид [clear]
    Базовые проверки крестика и попапа:
      - screenshot: внешний вид [voice-{{SET_NAME}} >> clear]
      - tags: [smoke_ext, smoke_extended]
      - do: кликнуть на микрофон (при необходимости разрешить браузеру доступ к микрофону)
      - tech: сработали динамические счетчики '/header/microphone' и '/header/microphone/start'
      - assert: появляется попап голосового ввода "Говорите..."
      - screenshot: внешний вид попапа голосового ввода [popup]
      - tech: сработал динамический счетчик '/header/microphone/init'
      - do: кликнуть в паранджу
      - assert: попап с голосовым вводом исчез
      - tech: сработали динамические счетчики '/header/microphone/hide' и '/header/microphone/hide' с 'vars = -eventType=paranja-click'
      - assertMetrics: '*'
    Способы закрытия попапа:
      Крестик:
        - do: кликнуть иконку микрофона в поисковой строке
        - assert: появился попап голосового ввода
        - do: кликнуть крестик в попапе
        - assert: попап с голосовым вводом закрыт
        - tech: сработали динамические счетчики '/header/microphone/stop' и '/header/microphone/hide' с 'vars = -eventType=cross-close'
        - assertMetrics: '*'
      Кнопка Назад:
        - do: кликнуть иконку микрофона в поисковой строке
        - assert: появился попап голосового ввода
        - do: нажать кнопку "назад" в браузере или устройстве
        - assert: попап с голосовым вводом закрыт
        - tech: сработали динамические счетчики '/header/microphone/stop' и '/header/microphone/hide' с 'vars = -eventType=history-change'
        - assertMetrics: '*'
      Скролл:
        - do: кликнуть иконку микрофона в поисковой строке
        - assert: появился попап голосового ввода
        - do: проскроллить выдачу вниз
        - assert: попап с голосовым вводом закрыт
        - tech: сработали динамические счетчики '/header/microphone/stop' и '/header/microphone/hide' с 'vars = -eventType=scroll-page'
        - assertMetrics: '*'
      Ожидание:
        - do: кликнуть иконку микрофона в поисковой строке
        - assert: появился попап голосового ввода
        - do: подождать 15 сеукнд
        - assert: попап с голосовым вводом закрыт
        - tech: сработали динамические счетчики '/header/microphone/stop' и '/header/microphone/hide' с 'vars = -eventType=timeout-empty'
        - assertMetrics: '*'
    Доступ заблокирован:
      Попап показа ошибки:
        - do: заблокировать доступ к микрофону в браузере
        - do: кликнуть иконку микрофона в поисковой строке
        - assert: появился попап "Вы заблокировали доступ к микрофону"
        - screenshot: попап заблокированного микрофона виден [popup-block]
        - tech: сработал динамический счетчик '/header/microphone/error'
        - do: нажать на кнопку "Продолжить поиск"
        - assert: попап закрылся
        - tech: сработал динамический счетчик '/header/microphone/hide' с 'vars = -eventType=btn-continue'
        - assertMetrics: '*'
    Отсутствует интернет (внешний вид):
      - do: отключить на устройстве интернет
      - do: кликнуть иконку микрофона в поисковой строке
      - assert: появился попап "Ошибка соединения"
      - tech: сработал динамический счетчик '/header/microphone/error/' c 'vars= -message=offline'
      - screenshot: внешний вид попапа отсутствующего подключения [offline]
      - assertMetrics: '*'
    Отсутствует интернет (закрытие):
      - do: отключить на устройстве интернет
      - do: кликнуть иконку микрофона в поисковой строке
      - assert: появился попап "Ошибка соединения"
      - do: нажать кнопку "Продолжить поиск"
      - assert: попап закрылся
      - tech: сработал динамический счетчик '/header/microphone/hide/' c 'vars= -eventType=btn-continue'
      - assertMetrics: '*'
  Попап открывается после загрузки страницы:
    #исключаю яндекс браузер для ручных проверок на асессорах, так как там нет как такового урла, в который можно подставить нужный параметр
    - browsers:
        - chrome-phone
        - android-samsung-internet-5-touch
        - android-browser-5.1-touch
    - params:
        promo: show-voice-input
    - do: получить выдачу по запросу "погода в Москве"
    - assert: получена выдача по указанному запросу
    - do: добавьте в урл параметр '&promo=show-voice-input' и перейдите на этот урл
    - assert: появляется попап с надписью "Говорите..."
    - assert: параметр '&promo=show-voice-input' отсутствует в урле
    - do: кликнуть крестик в попапе
    - assert: попап с голосовым вводом закрылся
    - do: нажать на кнопку "Найти"
    - assert: выдача обновляется
    - assert: параметр '&promo=show-voice-input' отсутствует
    - assertMetrics: '*'
  Голосовой поиск отключен:
    - params:
        exp_flags:
          - voice_search_disable=1
    - do: получить выдачу по запросу "погода в Москве"
    - do: подождать 5 секунд
    - assert: иконка голосового ввода отсутствует
    - assertMetrics: '*'
  Флаг query_source=voice убирается при перезапросе:
    beforeEach:
      - do: получить выдачу по запросу "погода в москве" при помощи голосового ввода (иконки микрофона в поисковой строке)
    При перезапросе через стрелку:
      - do: поменять значение "погода в москве" на "котики" в инпуте
      - assert: запрос изменился
      - do: клик в кнопку "Найти"
      - assert: выдача обновилась
      - assert: параметр query_source=voice отсутствует в урле
      - assertMetrics: '*'
    При клике по ссылке:
      - do: кликнуть первую ссылку в связанных запросах внизу страницы
      - assert: выдача обновилась
      - assert: параметр query_source=voice отсутствует в урле
      - assertMetrics: '*'
  Крестик после голосового ввода:
    - do: |
        получить выдачу по запросу "погода в Москве"
        кликнуть крестик
    - assert: |
        поисковый инпут пуст
        крестик заменился на микрофон
    - do: |
        кликнуть иконку микрофона в поисковой строке
        сделать голосовой запрос
    - assert: иконка голосового ввода заменилась на крестик

files:
  - features/touch-phone/voice-search/voice-search.hermione.js

v-team: Beauty

#Голосовой поиск не поддерживается на ios, также на некоторых браузерах в Android. Список поддержки взят тут:
#features/touch-phone/voice-search/voice-search_exp.testpalm.yml
browsers:
  - chrome-phone
  - android-samsung-internet-5-touch
  - android-yandex-browser-17-touch
  - android-browser-5.1-touch

tags:
  - voice
  - popup
  - ajax
  - input
  - reviewed
  - popular
  - skip_e2e_check
# Голосовой поиск никак не зависит от данных и от запроса пользователя, т.е. он контекстнонезависимый.
# Таким образом, целесообразнее проводить функциональное тестирование, e2e никакого профита не принесет.

counter: /header/microphone

tlds:
  - ru
  - by
  - kz
  - uz
  - ua
