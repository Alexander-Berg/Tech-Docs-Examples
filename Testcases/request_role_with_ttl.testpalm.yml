feature: Запрос роли

specs:
  beforeEach:
    - do: проверить, что в персональном воркфлоу Тестовой системы указан правильный код для роли "group-101" (/system/testsystem/workflow)
    - screenshot: правильные настройки персонального воркфлоу Тестовой системы [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-03%2013-41-28.png]
    - do: проверить, что у пользователя robot-cat-bayun нет выданной роли "group-101" (/system/testsystem/roles#f-status=active,f-role=testsystem/group-101,sort-by=-updated,f-is-expanded=true,f-user=user:robot-cat-bayun)

  Запрос роли со сроком :
    - do: запустить в Runner сценарий "Запрос роли со сроком" (https://github.yandex-team.ru/pixel/idm-runner)
    - do: отправить запрос "Запрос роли со сроком через api" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "201"
    - screenshot: ответ на запрос "Запрос роли со сроком через api" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-03%2014-00-40.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Отзыв запрошенной со сроком роли через api" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Нельзя запросить роль со сроком меньше 1 дня" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "400"
    - screenshot: ответ на запрос "Нельзя запросить роль со сроком меньше 1 дня" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-03%2014-02-14.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Нельзя запросить роль с невалидным значением срока" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "400"
    - screenshot: ответ на запрос "Нельзя запросить роль с невалидным значением срока" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-03%2014-03-30.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

priority: blocker

files:
  - idm/tests/models/idm/test_rolefield.py
  - idm/tests/api/frontend/test_rolerequest.py

tags:
  - reviewed
  - no_assessors
  - postman_automation
  - reviewed
  - no_assessors
  - postman_automation
  - fitcher:idm-www:blocks/desktop/card/__controls/**
  - fitcher:idm-www:blocks/desktop/role-request-form/**
  - fitcher:idm-www:blocks/desktop/table/__check-panel/**
  - fitcher:idm-www:blocks/desktop/idm-form/**
  - fitcher:idm-www:test/auto/01-roles/01-request/**
  - fitcher:idm_backend_palmsync:idm/tests/models/idm/test_rolefield.py
  - fitcher:idm_backend_palmsync:idm/tests/api/frontend/test_rolerequest.py
  - fitcher:idm_backend_palmsync:idm/core/constants/rolefield.py
  - fitcher:idm_backend_palmsync:idm/core/exceptions.py
  - fitcher:idm_backend_palmsync:idm/core/models/role.py
  - fitcher:idm_backend_palmsync:idm/core/models/rolefield.py
  - fitcher:idm_backend_palmsync:idm/core/models/rolenode.py
  - fitcher:idm_backend_palmsync:idm/core/models/networkmacro.py
  - fitcher:idm_backend_palmsync:idm/core/models/conductorgroup.py
  - fitcher:idm_backend_palmsync:idm/core/plugins/errors.py
  - fitcher:idm_backend_palmsync:idm/api/frontend/forms.py
  - fitcher:idm_backend_palmsync:idm/api/frontend/rolerequest.py
  - fitcher:idm_backend_palmsync:idm/tests/utils.py
  - fitcher:idm_backend_palmsync:idm/core/constants/role.py
  - fitcher:idm_backend_palmsync:idm/core/constants/system.py
  - fitcher:idm_backend_palmsync:idm/core/models/approverequest.py
  - fitcher:idm_backend_palmsync:idm/core/models/userpassportlogin.py
  - fitcher:idm_backend_palmsync:idm/users/models.py
