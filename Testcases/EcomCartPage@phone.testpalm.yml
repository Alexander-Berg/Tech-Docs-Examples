feature: Страница корзины

params:
  exp_flags:
    - turboforms_endpoint=https://test-turbo-forms.common.yandex.ru/
    - analytics-disabled=1

browsers:
  - ios-safari-12-touch
  - ios-safari-11-touch
  - ios-safari-10-touch
  - ios-safari-9-touch

specs:
  Переходы по истории:
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
    - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Добавить в корзину"
    - do: нажать на кнопку "Перейти в корзину"
    - assert: открылась страница корзины
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - do: нажать на браузерную кнопку "Назад"
    - assert: вернулись на предыдущую страницу с корзиной
    - do: нажать на браузерную кнопку "Вперед"
    - assert: вернулись на страницу с формой заказа

  Валидация полей:
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
    - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Добавить в корзину"
    - do: нажать на кнопку "Перейти в корзину"
    - assert: открылась страница корзины
    - screenshot: внешний вид [plain]
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - screenshot: внешний вид [form-screen]
    - do: нажать на кнопку "Оплатить" под формой
    - assert: незаполменные поля подсветились красным
    - screenshot: внешний вид [form-errors]
    - do: ввести имя "name"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: выбрать способ доставки "Самовывоз"
    - do: выбрать способ оплаты "Наличными"
    - do: нажать на кнопку "Отправить"
    - assert: появился попап "Спасибо за заказ!"

  Валидация телефона и почты:
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
    - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Добавить в корзину"
    - do: нажать на кнопку "Перейти в корзину"
    - assert: открылась страница корзины
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - do: ввести имя "name"
    - do: выбрать способ доставки "Самовывоз"
    - do: выбрать способ оплаты "Наличными"
    - do: нажать на кнопку "Отправить"
    - assert: заказ не отправился и вокруг поля ввода телефона и email появилась красная рамка

  Стоимость и способ доставки:
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
    - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Добавить в корзину"
    - do: нажать на кнопку "Перейти в корзину"
    - assert: открылась страница корзины
    - do: сделать так, чтобы в корзине лежал 1 товар (1 наименование и 1 штука)
    - do: запомнить цену, указанную под списком товаров
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - assert: цена на кнопке "Оплатить" внизу формы равна стоимости товара + указанная стоимость доставки
    - do: выбрать способ доставки "Самовывоз"
    - assert: сумма на кнопке "Оплатить" поменялась - стала равна стоимости товара
    - do: выбрать изначальный способ доставки - первый
    - assert: сумма на кнопке "Оплатить" стала изначальной
    - do: нажать браузерную "Назад"
    - do: увеличить число товаров до 2х и запомнить стоимость
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - assert: цена на кнопке "Оплатить" внизу формы равна стоимости товара
    - do: выбрать вторую опцию доставки
    - assert: сумма на кнопке "Оплатить" не изменилась

  Ошибка оформления:
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
    - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Добавить в корзину"
    - do: нажать на кнопку "Перейти в корзину"
    - assert: открылась страница корзины
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - do: ввести имя "test"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: ввести адрес "Адрес"
    - do: выбрать способ оплаты "Наличными"
    - do: выключить интернет
    - do: нажать на кнопку "Отправить"
    - assert: появился попап "Подтверждение заказа"
    - assert: попап сменился попапом "Произошла ошибка"
    - do: нажать в попапе на "Повторить"
    - assert: попап закрылся и мы остались на странице с формой

  Успешное оформление:
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
    - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Добавить в корзину"
    - do: нажать на кнопку "Перейти в корзину"
    - assert: открылась страница корзины
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - do: ввести имя "test"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: ввести адрес "Адрес"
    - do: выбрать способ оплаты "Наличными"
    - do: нажать на кнопку "Отправить"
    - assert: появился попап "Подтверждение заказа"
    - assert: попап сменился попапом успешного заказа с заголовком "Спасибо за заказ!"
    - tech: |
        отправилось 2 запроса на "/shopping-cart" - OPTIONS и POST
        в POST-запросе в поле "data" отправлено "null"
    - do: нажать в попапе на "вернуться в магазин"
    - assert: |
        попап закрылся и отобразилась страница со списком товаров
        в корзине нет товаров

  Ошибка получения ссылки на оплату:
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
    - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Добавить в корзину"
    - do: нажать на кнопку "Перейти в корзину"
    - assert: открылась страница корзины
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - do: ввести имя "test"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: ввести адрес "Адрес"
    - do: выключить интернет
    - do: нажать на кнопку "Оплатить"
    - assert: открылась страница с оплатой "Яндекс.Оплата" со спинером
    - assert: появился попап "Произошла ошибка"
    - do: нажать в попапе на "Повторить"
    - assert: попап закрылся и мы вернулись на страницу с формой
    - do: нажать на браузерный "Вперед"
    - assert: остались на странице с формой

  Ошибка оплаты:
    - tags:
        - no_assessors # не гоняем тесты на трасте
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
    - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Положить в корзину"
    - do: открыть ссылку https://yandex.ru/turbo?stub=ecomcartpage/default.json
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - do: ввести имя "error-pay"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: ввести адрес "Адрес"
    - do: нажать на кнопку "Оплатить"
    - assert: открылась страница с оплатой "Яндекс.Оплата" со спинером
    - assert: загрузилась страница с текстом "Trust status will be fail"
    - assert: через некоторое время появился попап "Произошла ошибка"
    - do: нажать в попапе на "Повторить"
    - assert: попап закрылся и мы вернулись на страницу с формой
    - do: нажать на браузерный "Вперед"
    - assert: остались на странице с формой

  Успех оплаты:
    - tags:
        - no_assessors # не гоняем тесты на трасте
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
    - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Положить в корзину"
    - do: открыть ссылку https://yandex.ru/turbo?stub=ecomcartpage/default.json
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - do: ввести имя "test"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: ввести адрес "Адрес"
    - do: нажать на кнопку "Оплатить"
    - assert: открылась страница с оплатой "Яндекс.Оплата" со спинером
    - assert: проверить что по клику на логотипе "Яндекс.Оплата" в новой вкладке открывается сайт Яндекс.Оплаты https://pay.yandex.ru/promo
    - assert: загрузилась страница с текстом "Trust status will be success"
    - assert: через некоторое время появилась страница успешного оформления "Спасибо за заказ!"
    - assert: в тексте указана почта "test@test.ru"

  Заказ уже оформлен:
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
    - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Положить в корзину"
    - do: открыть ссылку https://yandex.ru/turbo?stub=ecomcartpage/default.json
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - do: ввести имя "test"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: ввести адрес "Адрес"
    - do: выбрать способ оплаты "Наличными"
    - do: открыть в новой вкладке ссылку https://yandex.ru/turbo?stub=ecomcartpage/default.json
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - do: ввести имя "test"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: ввести адрес "Адрес"
    - do: выбрать способ оплаты "Наличными"
    - assert: появился попап "Подтверждение заказа"
    - assert: попап сменился попапом "Спасибо за заказ!"
    - do: вернуться в первую вкладку
    - do: нажать на кнопку "Отправить"
    - assert: появился попап "Подтверждение заказа"
    - assert: попап сменился попапом "Заказ уже оформлен"

  Проверка отправки подписи:
    - tags: no_assessors
    - do: перейти по ссылке https://yandex.ru/turbo?text=oris-parquet.ru%2Fyandexturbocart%2F
    - do: если в корзине отсутствуют товары, то нужно перейти в каталог и добавить товаров в корзину, а затем вернуться назад на страницу корзины
    - do: нажать на кнопку добавления товара
    - tech: запрос в корзину содержит параметр sk
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - do: ввести имя "test"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: ввести адрес "Адрес"
    - do: нажать на кнопку "Оформить заказ"
    - assert: появился попап "Подтверждение заказа"
    - assert: попап сменился попапом "Спасибо за заказ!"
    - tech: запрос в корзину содержит параметр sk

  Post-message на загрузку товаров в корзине:
    - tags:
        - no_assessors
    - params:
        foreverdata: '3036502055'
    - do: получить выдачу по запросу 'foreverdata' и кликнуть в заголовок первого сниппета
    - assert: в оверлее открылась страницы корзины
    - do: дождаться загрузки товаров
    - tech: пришел post-message с type = 'ecom-cart-loaded'

  При наличии товара под заказ прячем выбор способа оплаты, а в данных отправляем "наличными":
    - tags: no_assessors # бекенд не в продакшене https://st.yandex-team.ru/TURBOUI-3598
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-made-by-order.json # пока этого стаба не будет
    - do: если товар не в корзине (в товаре есть кнопка `добавить в корзину`) - добавить
    - do: перейти по ссылке https://yandex.ru/turbo?stub=cartpage/server-data-on-screens-redesign.json
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - assert: отсутствует опция выбора способа оплаты
    - do: ввести имя "test"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: ввести адрес "Адрес"
    - do: нажать на кнопку "Оформить заказ"
    - assert: появился попап "Подтверждение заказа"
    - assert: попап сменился попапом "Спасибо за заказ!"
    - tech: запрос в корзину содержит параметр payment_method со значением cash

  Расположение бейджа безопасности:
    В корзине с товарами:
      - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
      - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Добавить в корзину"
      - do: открыть ссылку https://yandex.ru/turbo?stub=ecomcartpage/with-safe.json
      - assert: открылась страница корзины
      - do: дождаться загрузки товаров
      - assert: под кнопкой оформления заказа есть бейдж про безопасную сделку и серый текст
      - do: кликнуть на "Яндекс.Маркета"
      - assert: в новой вкладке открылась страница "https://yandex.ru/legal/market_guarantee/"
      - do: нажать на кнопку "Оформить заказ"
      - assert: |
          открылась страница с формой оформления заказа
          под кнопкой заказа находится такой же бейдж безопасности
      - do: поменять способ оплаты
      - assert: бейдж также остался под кнопкой оплаты

    В корзине без товаров:
      - do: открыть ссылку https://yandex.ru/turbo?stub=ecomcartpage/with-safe.json
      - assert: загрузилась страница корзины
      - do: если в корзине есть товары - нажать у каждого `удалить`
      - assert: показалась надпись о том, что корзина пуста
      - assert: не отображается бейджа безопасной сделки

  С минимальной стоимостью заказа:
    - do: |
        перейти по ссылке https://yandex.ru/turbo?stub=ecomcartpage/default.json
        удалить из корзины все товары
        перейти по ссылке https://yandex.ru/turbo?stub=productpage/product-4.json
        добавить товар в корзину
        перейти по ссылке https://yandex.ru/turbo?stub=ecomcartpage/with-min-order-cost.json
    - assert: кнопка под списком товаров неактивна
    - screenshot: внешний вид [disabledButton]
    - do: кликнуть на "Перейти в каталог" под кнопкой
    - assert: в той же вкладке открылся каталог (stub=productspage/index.json)
    - do: вернуться на предыдущую страницу
    - assert: кнопка под списком товаров неактивна
    - do: поставить количество первого товара - 20
    - assert: появилась кнопка "Оформить заказ"

  Внешний вид с темой:
    - tags:
        - no_assessors # не гоняем тесты на трасте
    - do: перейти по ссылке https://yandex.ru/turbo?stub=productpage%2Fproduct-server-for-screens.json
    - do: если корзина пустая (в правом верхнем углу не указано количество товаров) - нажать "Положить в корзину"
    - do: открыть ссылку https://yandex.ru/turbo?stub=ecomcartpage/default.json
    - screenshot: внешний вид кнопки оформления заказа соответствует скриншоту [open-form-button]
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - do: ввести имя "test"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: ввести адрес "Адрес"
    - screenshot: внешний вид кнопки соответствует скриншоту [pay-cache]
    - do: поменять способ оплаты на "Наличными"
    - screenshot: внешний вид кнопки соответствует скриншоту [pay-cache]
    - do: поменять способ оплаты на "Онлайн"
    - do: нажать на кнопку "Оплатить"
    - assert: открылась страница с оплатой "Яндекс.Оплата" со спинером
    - assert: проверить что по клику на логотипе "Яндекс.Оплата" в новой вкладке открывается сайт Яндекс.Оплаты https://pay.yandex.ru/promo
    - assert: загрузилась страница с текстом "Trust status will be success"
    - assert: через некоторое время появилась страница успешного оформления "Спасибо за заказ!"
    - screenshot: внешний вид соответствует скриншоту [success-online-paid]

tags:
  - e-commerce
  - no_assessors #раскатили новый дизайн на 100%

files:
  - platform/components/EcomCartPage/__tests__/EcomCartPage@phone.hermione.js

v-team: Turbo

manager: tanzwuta

qa-engineer: spv

tlds: none
