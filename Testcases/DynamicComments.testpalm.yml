feature: DynamicComments

tags: no_assessors

specs:
  Базовая функциональность и ответ на первый комментарий:
    - do: открыть страницу примера блока dдинамических комментариев (/turbo?stub=dynamiccomments/login.json)
    - assert: должна показаться заглушка загрузки
    - screenshot: внешний вид соответствует скриншоту [loading]
    - assert: через некоторое время заглушка пропадет и появятся комментарии
    - screenshot: внешний вид соответствует скриншоту [plain]
    - do: кликнуть на "Ответить" под первым комментарием
    - assert: должна показаться форма для комментария, а "Ответить" должна скрыться
    - assert: фокус стоит в поле ввода
    - do: убрать фокус из поля ввода
    - screenshot: внешний вид соответствует скриншоту [firstCommentReplyForm]
    - do: кликнуть "Ответить" под вторым комментарием
    - assert: должна показаться форма для комментария, а "Ответить" должна скрыться
    - assert: фокус стоит в поле ввода
    - do: убрать фокус из поля ввода
    - screenshot: внешний вид соответствует скриншоту [firstReplyCommentReplyForm]
    - do: кликнуть на "Отменить" в форме под вторым комментарием
    - assert: форма под вторым комментарием должны скрыться, а "Ответить" должна появиться
    - do: ввести несколько пробелов и переводов строки в поле ввода под первым комменатрием
    - do: нажать "Отправить" под полем ввода
    - assert: ничего не должно произойти
    - do: очистить поле ввода под первым комментарием
    - do: ввести 1 пробел, 1 перевод строки, текст "Вторая строка" и еще 1 перевод строки
    - do: нажать "Отправить" под полем ввода
    - assert: форма стала неактивной
    - screenshot: внешний вид соответствует скриншоту [disabledReplyForm]
    - assert: |
        форма пропадет и новый комментарий добавился третьим сверху
        имя в новом комментарии соответствует "test-user@yandex-team.ru"
        дата комментария - 22 янв 2019
        правильно указан ник пользователя, на комментарий которого мы ответили
        в ответах к первому комментарию видна кнопка "Показать еще (1)"
    - screenshot: внешний вид соответствует скриншоту [replyToComment]

  Ответ на isreply-комментарий:
    - do: открыть страницу примера блока динамических комментариев (/turbo?stub=dynamiccomments/login.json)
    - assert: должна показаться заглушка загрузки
    - assert: через некоторое время заглушка пропадет и появятся комментарии
    - do: кликнуть "Ответить" под вторым комментарием
    - assert: должна показаться форма для комментария, а "Ответить" должна скрыться
    - do: ввести в поле "Первая строка", перевод строки, перевод строки, "и последняя"
    - do: нажать "Отправить" под полем ввода
    - assert: форма стала неактивной
    - assert: |
        форма пропадет и новый комментарий добавился третьим сверху
        имя в новом комментарии соответствует "test-user@yandex-team.ru"
        дата комментария - 22 янв 2019
        правильно указан ник пользователя, на комментарий которого мы ответили
        в ответах к первому комментарию видна кнопка "Показать еще (1)"
    - screenshot: внешний вид соответствует скриншоту [replyToReplyComment]

  Новый комментарий:
    - do: открыть страницу примера блока dдинамических комментариев (/turbo?stub=dynamiccomments/login.json)
    - assert: должна показаться заглушка загрузки
    - assert: через некоторое время заглушка пропадет и появятся комментарии
    - do: кликнуть на кнопку "Написать комментарий" под всеми комментариями
    - do: ввести в поле "Первая строка", перевод строки, перевод строки, "и последняя"
    - do: нажать "Отправить" под полем ввода
    - assert: форма стала неактивной
    - assert: |
        форма пропадет и новый комментарий добавился последним
        имя в новом комментарии соответствует "test-user@yandex-team.ru"
        дата комментария - 22 янв 2019
        в под последним комментарием видна кнопка "Показать еще (2)"
    - screenshot: внешний вид соответствует скриншоту [newComment]

  Не загрузились комментарии:
    - do: открыть страницу примера блока dдинамических комментариев (/turbo?stub=dynamiccomments/error-on-load.json)
    - assert: должна показаться заглушка загрузки
    - assert: через некоторое время загрушка должна скрыться и высота блока должна стать 0

  Ошибка при отправке комментария:
    - do: открыть страницу примера блока dдинамических комментариев (/turbo?stub=dynamiccomments/error-on-send.json)
    - assert: должна показаться заглушка загрузки
    - assert: через некоторое время заглушка пропадет и появятся комментарии
    - do: кликнуть на "Ответить" под первым комментарием
    - assert: должна показаться форма для комментария, а "Ответить" должна скрыться
    - do: ввести в поле перевод строки, "Вторая строка", перевод строки
    - do: нажать "Отправить" под полем ввода
    - assert: форма стала неактивной
    - assert: через некоторое время вверху экрана появится предупреждение, что комментарий не удалось отправить
    - assert: форма снова стала активной

  Поведение при логине/разлогине:
    - do: открыть страницу примера блока dдинамических комментариев (/turbo?stub=dynamiccomments/default.json)
    - assert: должна показаться заглушка загрузки
    - assert: через некоторое время заглушка пропадет и появятся комментарии
    - do: кликнуть на "Ответить" под первым комментарием
    - assert: должен открыться попап с формой авторизации
    - do: заурыть попап кликом по тректику
    - assert: |
        попап должен закрыться
        комментарии должны остаться без изменений
    - do: кликнуть на "Войти" над комментариями
    - assert: должен открыться попап с формой авторизации
    - do: в поле Login ввести "Test user"
    - do: в поле Password ввести "123"
    - do: кликнуть по кнопке "Войти"
    - assert: |
        попап должен закрыться
        над комментариями должен отображаться логин пользователя "Test user" после "Выйти"
        комментарии должны остаться без изменений
    - do: кликнуть на "Ответить" под первым комментарием
    - assert: должна показаться форма для комментария, а "Ответить" должна скрыться
    - do: кликнуть по "Выйти"
    - assert: |
        пользователя должно разлогинить
        должна скрыться форма под первым комментарием
    - do: кликнуть на "Ответить" под первым комментарием
    - assert: должен открыться попап с формой авторизации
    - do: в поле Login ввести "Test user"
    - do: в поле Password ввести "123"
    - do: кликнуть по кнопке "Войти"
    - assert: |
        попап должен закрыться
        над комментариями должен отображаться логин пользователя "Test user" после "Выйти"
        под первым комментарием должна показаться форма для комментария, а "Ответить" должна скрыться

  Загружается кнопка, если нет комментариев:
     - do: открыть страницу примера блока dдинамических комментариев (/turbo?stub=dynamiccomments/default-no-data.json)
     - screenshot: показалась кнопка [comments]

  Работает пагинация реплаев:
    - do: открыть страницу примера блока динамических комментариев (/turbo?stub=dynamiccomments/login.json)
    - assert: должна показаться заглушка загрузки
    - assert: через некоторое время заглушка пропадет и появятся комментарии
    - do: кликнуть на "Показать еще (1)" под вторым комментарием
    - assert: |
        не отобразился индикатор загрузки
        появился новый комментарий
        под новым комментарием не отображается кнопка "Показать еще"
        под всеми комментариями отображается кнопка "Показать еще (2)", жирным шрифтом
    - screenshot: внешний вид соответствует скриншоту [repliesShowMore]

  Работает пагинация верхнеуровневых комментариев:
    - do: открыть страницу примера блока динамических комментариев (/turbo?stub=dynamiccomments/login.json)
    - assert: должна показаться заглушка загрузки
    - assert: через некоторое время заглушка пропадет и появятся комментарии
    - do: кликнуть на кнопку "Показать еще (2)" под всеми комментариями
    - assert: |
        кнопка исчезла
        на месте кнопки появилась надпись "Загрузка..."
        через некоторое время появился еще один комментарий
        появилась кнопка "Показать еще (1)" под всеми комментариями
    - screenshot: внешний вид соответствует скриншоту [commentsShowMore]

  Возможность ответить на верхнеуровневый комментарий после загрузки следующей страницы комментов:
    - do: открыть страницу примера блока динамических комментариев (/turbo?stub=dynamiccomments/login.json)
    - assert: должна показаться заглушка загрузки
    - assert: через некоторое время заглушка пропадет и появятся комментарии
    - do: кликнуть на кнопку "Показать еще (2)" под всеми комментариями
    - assert: |
        кнопка исчезла
        на месте кнопки появилась надпись "Загрузка..."
        через некоторое время появился еще один комментарий
        появилась кнопка "Показать еще (1)" под всеми комментариями
    - do: кликнуть "Ответить" под последним комментарием
    - assert: должна показаться форма для комментария, а "Ответить" должна скрыться
    - do: ввести в поле перевод строки, "Вторая строка", перевод строки
    - do: нажать "Отправить" под полем ввода
    - assert: форма стала неактивной
    - assert: через некоторое время вверху экрана появится предупреждение, что комментарий не удалось отправить
    - assert: форма снова стала активной
    - screenshot: внешний вид соответсвует скриншоту [replyOnSecondRootComment]

  Корректно работает пагинация с лимитом > 1:
    - do: открыть страницу примера блока динамических комментариев (/turbo?stub=dynamiccomments/large.json)
    - assert: должна показаться заглушка загрузки
    - screenshot: через некоторое время заглушка пропадет и появятся комментарии [withLargeOffset]
    - do: кликнуть на первую кнопку "Показать еще (8)"
    - screenshot: подргузились два комментария [withLargeOffsetFirstOpened]
    - do: кликнуть по нижней кнопке "Показать еще (498)"
    - screenshot: спустя какое-то время подгрузились новые комментарии и добавились в конец [withLargeOffsetMoreOpened]
    

files:
  - platform/components/DynamicComments/__tests__/DynamicComments.hermione.js

v-team: Turbo

manager: tanzwuta

tlds: none
