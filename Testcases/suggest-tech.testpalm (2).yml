feature: Саджест
type: Счетчики

specs:
  Основные:
    beforeEach:
      - do: получить выдачу по запросу "тест"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
    Тип взаимодействия с саджестом и индекс выбранной подсказки при выборе полнотекстовой:
      - do: кликнуть в полнотекстовую
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_touch\.mouse\.p6\.nah_not_shown\.click_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с саджестом и индекс выбранной подсказки при выборе навигационки:
      - do: получить выдачу по запросу "вконтакте"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
      - do: кликнуть в навигационную подсказку
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_touch\.mouse\.p5\.nah_not_used\.click_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с саджестом, если саджест не отображался:
      - do: получить выдачу по запросу со специфичным текстом
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: саджест не появился
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_touch\.not_shown\.p0\.nah_not_shown\.button_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с саджестом, если саджест не использовался:
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_touch\.not_used\.p0\.nah_not_shown\.button_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с саджестом при использовании пословной:
      - do: кликнуть в пословную подсказку
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_touch\.tpah\.p0\.nah_not_shown\.button_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с саджестом при изменении после использования пословной:
      - do: кликнуть в пословную подсказку
      - do: дописать в поисковое поле текст
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_touch\.edit\.p0\.nah_not_shown\.button_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с историей, если она не была использована:
      - do: сделать перезапрос с текстом "тест"
      - do: кликнуть в поле поиска
      - assert: появился саджест
      - assert: в саджесте присутствует историческая подсказка с текстом "тест"
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_touch\.not_used\.p0\.nah_not_used\.button_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с историей, если она была использована:
      - do: сделать перезапрос с текстом "тест"
      - do: кликнуть в поле поиска
      - assert: появился саджест
      - assert: в саджесте присутствует историческая подсказка с текстом "тест"
      - do: кликнуть в историческую подсказку
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_touch\.mouse\.p1\.nah_used\.click_by_mouse/
      - assertMetrics: '*'
    Способ отправки запроса и индекс выбранной подсказки при использовании фактовой:
      - do: ввести запрос "вес слитка золота"
      - assert: в саджесте отображается фактовая подсказка
      - do: кликнуть в фактовую подсказку
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_touch\.mouse\.p5\.nah_not_shown\.click_by_mouse/
      - assertMetrics: '*'
    Способ отправки запроса при нажатии на кнопку "Найти":
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_touch\.not_used\.p0\.nah_not_shown\.button_by_mouse/
      - assertMetrics: '*'
    Способ отправки запроса при нажатии Enter на клавиатуре:
      - do: нажать на кнопку "Enter" на клавиатуре
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_touch\.not_used\.p0\.nah_not_shown\.button_by_mouse/
      - assertMetrics: '*'
    Проверка вычисляемых полей счетчика:
      - do: удалить два символа запроса
      - do: добавить текст "ст ть"
      - do: кликнуть в первую пословную подсказку
      - do: кликнуть в первую полнотекстовую подсказку
      - tech: отправился счетчик саджеста
      - tech: поле sfc больше 0
      - tech: поле slc больше 0
      - tech: поле tit больше 0
      - tech: поле tit больше sfc
      - tech: поле sfc больше slc
      - tech: поле clks равно 1
      - tech: поле times содержит 9 значений, разделенных "."
      - tech: все значения в поле times не отрицательные
      - tech: поле render_times содержит 9 значений, разделенных "."
      - tech: все значения в поле render_times не отрицательные
      - tech: поле pos равно 27
      - tech: поле ratio содержит 3 значений, разделенных "."
      - tech: поле ratio равно 7.27.11
      - assertMetrics: '*'
    Содержит верное количество запросов/ответов/рендеров:
      - do: добавить текст " лал"
      - do: удалить три символа запроса
      - do: добавить текст "лал1"
      - do: кликнуть в кнопку "Найти"
      - tech: отправился счетчик саджеста
      - tech: поле cchd равно 6
      - tech: поле rqs равно 12
      - tech: поле rsp равно 12
      - tech: поле ersp равно 1
      - tech: поле rndr равно 11
      - assertMetrics: '*'
    При первоначальной очистке инпута логируется один раз clear:
      - do: получить выдачу по запросу "тест"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в крестик очистки инпута
      - do: кликнуть в кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле tpah_log начинается с '[[clear'
      - assertMetrics: '*'
    Содержит количество различных подсказок:
      - do: кликнуть в кнопку "х" поисковой стрелки
      - do: ввести "apple iphone x 256" в поисковую стрелку
      - do: очистить поисковую стрелку
      - do: ввести "вес слитка" в поисковую стрелку
      - do: кликнуть по кнопке "Найти"
      - tech: отправился запрос с маской 'cid=2873'
      - tech: в запросе параметр 'type_counts' с подсчетом типов подсказок
      - assertMetrics: '*'
    Символ * экранирован в значениях параметров:
      - do: кликнуть в кнопку "х" поисковой стрелки
      - do: ввести "п*г*да" в поисковую стрелку
      - do: кликнуть по кнопке "Найти"
      - do: ввести "числ* пи"
      - do: кликнуть по кнопке "Найти"
      - tech: должен отправиться запрос с маской 'cid=2873'
      - tech: в запросе cимвол "*" экранирован как "%2A" в значениях параметров
      - assertMetrics: '*'
    Содержит suggest_reqid в запросах к ручке саджеста, счетчиках и перезапросе:
      - do: получить выдачу по запросу "тест"
      - do: добавить текст в поле ввода
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста
      - tech: в запросе за подсказками, \
              в счетчике саджеста и в перезапросе за новой выдачей содержится параметр suggest_reqid \
              c одинаковым значением
    Корректный счетчик при тапе на навигационник:
      - do: получить выдачу по запросу "вконтакте"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в инпут поисковой стрелки
      - assert: в выдаче саджеста присутствует навигационная подсказка
      - screenshot: примерный внешний вид [https://jing.yandex-team.ru/files/maxsinev/nav.png]
      - do: кликнуть в навигационную подсказку
      - tech: отправился один запрос с маской 'cid=2873'
      - tech: параметры запроса содержат ненулевые значения в rndr, rqs, total_input_time
    Заполнение поля text при тапе на навигационную подсказку:
      - do: получить выдачу по запросу "вкон"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
      - do: кликнуть в навигационную подсказку
      - tech: отправился счетчик саджеста, \
          поле text соответствует значению "вконтакте"
      - assertMetrics: '*'
    Поле prev_query:
      - do: получить выдачу по запросу "тест"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
      - do: кликнуть в любую подсказку
      - tech: отправился счетчик саджеста, \
          поле prev_query равно "%D1%82%D0%B5%D1%81%D1%82"
      - assertMetrics: '*'
    Содержит space_created=1 при использовании пословной:
      - do: кликнуть в первую пословную подсказку
      - tech: за подсказками ушел запрос с параметром space_created=1
      - do: ввести символ "к"
      - tech: за подсказками ушел запрос без параметра space_created
      - do: кликнуть в первую пословную подсказку
      - tech: за подсказками ушел запрос с параметром space_created=1
      - do: кликнуть в крестик поисковой стрелки
      - tech: за подсказками ушел запрос без параметра space_created
  Safeclick:
    Проверка safeclick счетчика в навигационках:
      - params:
          exp_flags: suggest_safeclick=1
      - do: получить выдачу по запросу "одноклассники"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
      - do: кликнуть в навигационную подсказку
      - assert: ссылка ведет на m.ok.ru
      - tech: отправился счетчик саджеста
      - assertMetrics: '*'
    Проверка корректности sc куки после перехода по навигационке:
      - do: получить выдачу по запросу "янд"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
      - assert: видна навигационная подсказка
      - do: кликнуть в навигационную подсказку
      - do: перейти на yandex.ru/watch
      - assert: сайт содержит корректные куки sc_* без undefined значений
      - assertMetrics: '*'
specs-integration:
  Safeclick:
    Проверка safeclick счетчика в навигационках:
      - do: кликнуть в "х" поисковой стрелки
      - assert: поисковая стрелка очищена
      - assert: саджест открыт
      - do: введите в поисковую стрелку "одноклассники"
      - assert: в саджесте присутствует навигационная подсказка с ссылкой на ресурс "одноклассники"
      - do: клинуть в навигационную подсказку (имеет ссылку на m.ok.ru)
      - assert: в новой вкладке открылся сервис "Одноклассники"

files:
  - features/touch-phone/suggest/suggest-tech.hermione.js
  - features/touch-phone/suggest/suggest-tech.hermione.e2e.js

qa-engineer:
  - e-rea

tags:
  - suggest
  - input
  - reviewed
  - no_assessors

browsers:
  notFor:
    - searchapp-phone-group

v-team: Suggest

priority: high

tlds:
  - ru
  - by
  - ua
  - kz
  - uz
  - com
  - com.tr
