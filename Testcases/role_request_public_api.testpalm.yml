feature: Public API

specs:
  Запрос роли с симуляцией в Public API:
    - do: запустить в Runner сценарий "Запрос роли с симуляцией в Public API" (https://github.yandex-team.ru/pixel/idm-runner)
    - do: отправить запрос "Вернуть подтверждающих" с токеном "robot-cat-bayun"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Вернуть подтверждающих" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-12%2020-14-12.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Список подтверждений в Public API:
    - do: (PREPARE) проверить, что robot-internal-2 не имеет выданных и запрошенных ролей (/system/abc/roles#f-status=all,f-role=abc/services/orange/kotovets/*/5,sort-by=-updated,f-is-expanded=true,f-user=user:robot-internal-2,f-state=granted,f-state=requested)
    - do: запустить в Runner сценарий "Список подтверждений в Public API" (https://github.yandex-team.ru/pixel/idm-runner)
    - do: отправить запрос "Нельзя отправить запрос без обязательного параметра status" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "400"
    - screenshot: ответ на запрос "Нельзя отправить запрос без обязательного параметра status" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-12%2020-18-50.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Генерация данных для ручки с запросом ролей" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "201" и id роли в ответе
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запросы ролей Кота Леопольда, которым нужен аппрув" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: в ответе на запрос "Запросы ролей Кота Леопольда, которым нужен аппрув" записи должны содержать поле "username" со значением "robot-cat-leopold" только в блоке "user" в "role" [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-12%2020-22-48.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление роли из сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Отзыв нескольких ролей в Public API:
    - do: запустить в Runner сценарий "Отзыв нескольких ролей в Public API" (https://github.yandex-team.ru/pixel/idm-runner)
    - do: отправить запрос "Запрос 2-х ролей group-64" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Запрос 2-х ролей group-64" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-12%2020-26-00.png]
    - do: отправить запрос "Отзыв нескольких ролей" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "undefined"
    - screenshot: ответ на запрос "Отзыв нескольких ролей" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-12%2020-27-05.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Перезапрос роли в Public API:
    - do: запустить в Runner сценарий "Перезапрос роли в Public API" (https://github.yandex-team.ru/pixel/idm-runner)
    - do: отправить запрос "[подготовка данных] Отзыв роли" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: отправить запрос "Перезапрос роли" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "202" и null в теле
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

priority: blocker

files:
  - idm/tests/api/v1/test_rolerequest.py
  - idm/tests/api/frontend/test_approverequest.py

tags:
  - reviewed
  - no_assessors
  - postman_automation
  - fitcher:idm_backend_palmsync:idm/tests/api/v1/test_rolerequest.py
  - fitcher:idm_backend_palmsync:idm/tests/api/frontend/test_approverequest.py
  - fitcher:idm_backend_palmsync:idm/core/models/role.py
  - fitcher:idm_backend_palmsync:idm/core/models/approverequest.py
  - fitcher:idm_backend_palmsync:idm/tests/utils.py
  - fitcher:idm_backend_palmsync:idm/users/constants/user.py
  - fitcher:idm_backend_palmsync:idm/users/models.py
