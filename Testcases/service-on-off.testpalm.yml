feature: Включение и отключение сервисов

description: |
  Preconditions.
  Кейс выполняется на подготовленных организациях:
    - под админом(ewan-ivanov@yandex.ru =-123qwe)
    - сотрудником в организации с включенными сервисами(od@evan.connect-test.tk =-123qwe)
    - админом с подписками(podpiski@yandex.ru =-123qwe)
  Просьба вернуть организацию в изначальное состояние после выполнения кейса.

aliases:
  - &disabling
    - do: на странице сервиса в верхнем правом углу нажать на экшен "Отключить"
    - assert: появился попап "Уверены, что хотите отключить сервис?"
    - do: нажать кнопку "Отключить"
    - assert: |
        попап закрылся
        через время статус изменился на "сервис отключен" с красным кружком (возможен промежуточный статус с жёлтым кружком)
        в верхнем правом углу отображается кнопка "Подключить"
  - &enabling
    - do: нажать кнопку "Подключить"
    - assert: |
        через время статус изменился на "сервис подключен" с зеленым кружком (возможен промежуточный статус с жёлтым кружком)
  - &enabling_dashboard
    - do: перейти на страницу дашборда {{CONNECT_HOST}}/portal/home
    - assert: на плитке отображается экшен "+ Подключить сервис"
    - screenshot: внешний вид экшена [action-enable]
    - do: нажать на экшен "+ Подключить сервис"
    - assert: на плитке отображается статус "Подключение" и крутится спинер
  - &admin
    - do: авторизоваться под админом организации(ewan-ivanov@yandex.ru)
  - &user
    - do: авторизоваться под сотрудником организации(od@evan.connect-test.tk)
  - &disabling_tracker
    - do: на странице сервиса в верхнем правом углу нажать на экшен "Отключить"
    - assert: появился попап "Хотите отключить Трекер?"
    - do: нажать кнопку "Отключить"
    - assert: |
        попап закрылся
        изменился статус сервиса на "сервис отключается" с оранжевым кружком
        через время статус изменился на "сервис отключен" с красным кружком
        в верхнем правом углу отображается кнопка "Подключить"
        вкладки "Подписки", "Запросы", "Настройки сервиса" не отображаются
        экшены "+ Создать задачу", "Перейти в Трекер", "Отключить" не отображаются
specs:
  Админ:
    1. Неотключаемый сервис Почта:
      - *admin
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/mail
      - assert: выполнился переход в сторонний сервис
    2. Отключение и включение сервиса Люди:
      - *admin
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/staff
      - screenshot: открыта страница Люди с экшенами "+ Редактировать профиль", "Перейти в сервис", "Отключить" [enabled]
      - *disabling
      - screenshot: открыта страница Люди без экшенов "+ Редактировать профиль", "Перейти в сервис", "Отключить" [disabled]
      - *enabling
      - assert: отображаются экшены "+ Редактировать профиль", "Перейти в сервис", "Отключить"
      - *disabling
      - *enabling_dashboard
      - assert: через время статус "Подключение" изменился на экшен "+ Редактировать профиль"
    3. Отключение и включение сервиса Вики:
      - *admin
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/wiki
      - screenshot: открыта страница Вики с экшенами "+ Создать страницу", "Перейти в Вики", "Отключить" [enabled]
      - *disabling
      - screenshot: открыта страница Вики без экшенов "+ Создать страницу", "Перейти в Вики", "Отключить" [disabled]
      - *enabling
      - assert: отображаются экшены "+ Создать страницу", "Перейти в Вики", "Отключить"
      - *disabling
      - *enabling_dashboard
      - assert: через время статус "Подключение" изменился на экшен "+ Создать страницу"
    4. Отключение и включение сервиса Формы:
      - *admin
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/forms
      - screenshot: открыта страница Формы с экшенами "+ Создать форму", "Перейти в сервис", "Отключить" [enabled]
      - *disabling
      - screenshot: открыта страница Формы без экшенов "+ Создать форму", "Перейти в сервис", "Отключить" [disabled]
      - *enabling
      - assert: отображаются экшены "+ Создать форму", "Перейти в сервис", "Отключить"
      - *disabling
      - *enabling_dashboard
      - assert: через время статус "Подключение" изменился на экшен "+ Создать форму"
    5. Неотключаемый сервис Календарь:
      - *admin
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/calendar
      - screenshot: открыта страница Календарь с экшеном "+ Создать событие", "Перейти в сервис" [enabled]
      - assert: нет экшена "Отключить"
    6. Неотключаемый сервис Вебмастер:
      - *admin
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/webmaster
      - screenshot: открыта страница Вебмастер с экшеном "Перейти в Вебмастер" [enabled]
      - assert: нет экшена "Отключить"
    8. Неотключаемый сервис Чаты:
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/yamb
      - screenshot: открыта страница Чаты с экшенами "+ Написать в чат", "Перейти в Чат" [enabled]
      - assert: нет экшена "Отключить"
    9. Неотключаемый сервис Диск:
      - *admin
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/disk
      - screenshot: открыта страница Диск с экшеном "Перейти в Диск" [enabled]
      - assert: нет экшена "Отключить"
    10. Неотключаемый сервис Справочник:
      - *admin
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/yandexsprav
      - screenshot: открыта страница Справочник с экшеном "Перейти в Справочник" [enabled]
    11. Неотключаемый сервис Метрика:
      - *admin
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/metrika
      - screenshot: открыта страница Метрика с экшеном "Перейти в сервис" [enabled]
      - assert: нет экшена "Отключить"
    12. Проверка работы попапа отключения сервиса Люди:
      - *admin
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/staff
      - do: нажать на экшен "Отключить"
      - assert: появился попап "Уверены, что хотите отключить сервис?"
      - do: нажать на кнопку "Отменить"
      - assert: |
          попап закрылся
          отображаются экшены "+ Редактировать профиль", "Перейти в сервис", "Отключить"
      - do: нажать на экшен "Отключить"
      - assert: появился попап "Уверены, что хотите отключить сервис?"
      - do: нажать на элемент попапа "крестик"
      - assert: |
          попап закрылся
          отображаются экшены "+ Редактировать профиль", "Перейти в сервис", "Отключить"
    13. Отключение и включение сервиса Трекер:
      - *admin
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/tracker
      - screenshot: открыта страница Трекера с экшенами "+ Создать задачу", "Перейти в Трекер", "Отключить" и тремя вкладками "Подписки", "Запросы", "Настройки сервиса" [enabled]
      - assert: статус сервиса "сервис подключен" с зеленым кружком
      - *disabling_tracker
      - screenshot: открыта страница Трекера с кнопкой "Подключить" [disabled]
      - do: нажать на кнопку "Подключить"
      - screenshot: появился попап "Подключение Трекера" [confirm]
      - do: нажать на "крестик"
      - assert: попап закрылся
      - do: нажать на кнопку "Подключить"
      - assert: появился попап "Подключение Трекера"
      - do: нажать на кнопку "Включить"
      - assert: |
          попап "Подключение Трекера" закрылся
          изменился статус сервиса на "сервис подключается" с оранжевым кружком
          через время статус изменился на "сервис подключен" с зеленым кружком
          появилась плашка "Только чтение"
          отображаются экшены "+ Создать задачу", "Перейти в Трекер", "Отключить"
          отображаются три вкладки "Подписки", "Запросы", "Настройки сервиса"
      - *disabling_tracker
      - assert: не отображается плашка "Только чтение"
      - do: перейти на страницу дашборда {{CONNECT_HOST}}/portal/home
      - assert: на плитке отображается экшен "+ Подключить сервис"
      - screenshot: внешний вид экшена [action-enable]
      - do: нажать на экшен "+ Подключить сервис"
      - assert: появился попап "Подключение Трекера"
      - do: нажать на кнопку "Подключить"
      - assert: |
          попап закрылся
          на плитке отображается статус "Подключение" и крутится спинер
          через время появился экшен "+ Создать задачу"
      - screenshot: внешний вид экшена [action-create]
      - assert: появилась плашка "Только чтение"
    14. Отключение и включение сервиса Трекер когда есть подписки:
      - do: авторизоваться под админом в организацией с подписками(podpiski@yandex.ru)
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/tracker
      - assert: открыта страница Трекера с экшенами "+ Создать задачу", "Перейти в Трекер", "Отключить" и тремя вкладками "Подписки", "Запросы", "Настройки сервиса"
      - *disabling_tracker
      - do: перейти на страницу дашборда {{CONNECT_HOST}}/portal/home
      - assert: на плитке отображается экшен "+ Подключить сервис"
      - do: нажать на экшен "+ Подключить сервис"
      - screenshot: появился попап "Подключение Трекера" с тремя кнопками "Включить с подписками", "Включить без подписок" и "Отменить" [confirm]
      - do: нажать на кнопку "отмена"
      - assert: |
          попап закрылся
          на плитке отображается экшен "+ Подключить сервис"
      - do: нажать на экшен "+ Подключить сервис"
      - assert: попап "Подключение Трекера"
      - do: нажать на кнопку  "Включить с подписками"
      - assert: |
          попап закрылся
          на плитке отображается статус "Подключение" и крутится спинер
          через время появился экшен "+ Создать задачу"
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/tracker
      - assert: открыта страница Трекера с экшенами "+ Создать задачу", "Перейти в Трекер", "Отключить" и тремя вкладками "Подписки", "Запросы", "Настройки сервиса"
      - screenshot: на странице Трекера отображаются ранее выданные подписки [subs]

  Пользователь:
    1. Нельзя отключить сервис Метрика:
      - *user
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/metrika
      - assert: |
          открыта страница Метрика с экшеном  "Перейти в сервис"
          нет экшена "Отключить"
    2. Нельзя отключить сервис Почта:
      - *user
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/mail
      - assert: |
          открыта страница Почта с экшенами "+ Написать письмо" "Перейти в Почту"
          нет экшена "Отключить"
    4. Нельзя отключить сервис Чаты:
      - *user
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/yamb
      - assert: |
          открыта страница Чаты с экшенами "+ Написать в чат" "Перейти в Чаты"
          нет экшена "Отключить"
    5. Нельзя отключить сервис Диск:
      - *user
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/disk
      - assert: |
          открыта страница Диск с экшеном" "Перейти в Диск"
          нет экшена "Отключить"
    6. Нельзя отключить сервис Люди:
      - *user
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/staff
      - assert: |
          открыта страница Люди с экшенами "+ Редактировать профиль" "Перейти в сервис"
          нет экшена "Отключить"
    7. Нельзя отключить сервис Трекер:
      - *user
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/tracker
      - assert: |
          открыта страница Трекер с экшенами "+ Создать задачу" "Перейти в Трекер"
          нет экшена "Отключить"
    8. Нельзя отключить сервис Вики:
      - *user
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/wiki
      - assert: |
          открыта страница Вики с экшенами "+ Создать страницу" "Перейти в Вики"
          нет экшена "Отключить"
    9. Нельзя отключить сервис Формы:
      - *user
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/forms
      - assert: |
          открыта страница Формы с экшенами "+ Создать форму" "Перейти в сервис"
          нет экшена "Отключить"
    10. Нельзя отключить сервис Календарь:
      - *user
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/calendar
      - assert: |
          открыта страница Календарь с экшенами "+ Создать событие" "Перейти в сервис"
          нет экшена "Отключить"
    11. Нельзя отключить сервис Справочник:
      - *user
      - do: перейти на страницу сервиса {{CONNECT_HOST}}/portal/services/yandexsprav
      - assert: |
          открыта страница Справочник с экшеном "Перейти в Справочник"
          нет экшена "Отключить"

priority: blocker

tlds:
  - ru
  - com

files:
  - tests/hermione/suites/services/service-on-off.js

tags:
  - smoke_test_assessors
  - regression
  - smoke_test
  - reviewed
  - smoke_test_mini
