feature: Подтверждение ресурсов

aliases:
  - &deleteResource
    - do: (PREPARE) залогиниться пользователем robot-abc-002
    - do: (PREPARE) открыть таб "Ресурсы" для сервиса "autotest-for-resources-requests" (/services/autotest-for-resources-requests/resources/)
    - do: (PREPARE) в списке найти ресурс типа "Квота, аккаунты" в статусе "Выдан"
    - do: (PREPARE) кликнуть на многоточие в строке с этим ресурсом
    - do: (PREPARE) выбрать в появившемся попапе пункт "Удалить"
    - do: (PREPARE) в модалке с подтверждением удаления нажать на кнопку "Подтвердить"
    - assert: (PREPARE) удалённый ресурс перешёл в статус "Отозван"

specs:
  beforeEach:
      - do: (PREPARE) залогиниться пользователем robot-abc-002
      - do: (PREPARE) открыть форму запроса ресурса "YP - Квота" для сервиса "autotest-for-resources-requests" (/services/autotest-for-resources-requests/resources/?new-resource-service=4525&new-resource=yes&new-resource-resource=164)
      - do: (PREPARE) выбрать сценарий "Перераспределение квоты"
      - do: (PREPARE) указать в поле "Слаг Сервиса-донора" значение "asd2"
      - do: (PREPARE) в поле "Локация" выбрать вариант "VLA"
      - do: (PREPARE) в поле "Сегмент" выбрать вариант "default"
      - do: (PREPARE) в поле "CPU" указать значение "0.918"
      - do: (PREPARE) кликнуть на кнопку "Отправить"

  Положительные:
    1. Подтвердить выдачу запрошенного ресурса со страницы "Подтверждения":
      - do: залогиниться пользователем robot-abc-001
      - do: открыть страницу "Подтверждения" на табе "Ресурсы" (/approves/resources/)
      - assert: в таблице есть запись о запросе ресурса, где потребитель - "autotest-for-resources-requests", а тип - "Квота, аккаунты"
      - screenshot: запрос на подтверждение ресурса [resource-request]
      - do: кликнуть на многоточие в конце строки с запросом ресурса
      - screenshot: появился попап с двумя блоками - "Статус", в котором есть пункты "Подтвердить" и "Отклонить", и "Редактировать" и "Посмотреть" [actions-menu]
      - do: кликнуть на пункт "Подтвердить"
      - assert: попап скрылся, список ресурсов на подтверждение обновился
      - do: открыть страницу с ресурсами сервиса "autotest-for-resources-requests" с предустановленными фильтрами по поставщику - YP и по статусу - "Выдан" (/services/autotest-for-resources-requests/resources/?supplier=2604&type=164&state=granted&view=consuming&layout=cards)
      - assert: в таблице есть ресурс "loc:VLA-seg:default-cpu:0.918-mem:0-hdd:0-ssd:0-ip4:0-net:0-io_ssd:0-io_hdd:0"
      - do: (PREPARE) кликнуть на многоточие в строке с этим ресурсом
      - do: (PREPARE) выбрать в появившемся попапе пункт "Удалить"
      - do: (PREPARE) в модалке с подтверждением удаления нажать на кнопку "Подтвердить"
      - assert: (PREPARE) удалённый ресурс перешёл в статус "Отозван"

    2. Отклонить выдачу запрошенного ресурса со страницы "Подтверждения":
      - do: залогиниться пользователем robot-abc-001
      - do: открыть страницу "Подтверждения" на табе "Ресурсы" (/approves/resources/)
      - assert: в таблице есть запись о запросе ресурса, где потребитель - "autotest-for-resources-requests", а тип - "Квота, аккаунты"
      - do: кликнуть на строку с запрошенным ресурсом
      - screenshot: появилась модалка с просмотром информации о ресурсе [resource-view-modal]
      - do: кликнуть на кнопку "Отклонить" в модалке с просмотром информации о ресурсе
      - assert: модалка скрылась, список ресурсов на подтверждение обновился, в таблице нет запрошенного для сервиса "autotest-for-resources-requests" ресурса "loc:VLA-seg:default-cpu:0.001-mem:0-hdd:0-ssd:0-ip4:0-net:0-io_ssd:0-io_hdd:0"
      - do: открыть страницу с ресурсами сервиса "autotest-for-resources-requests" с предустановленными фильтрами по поставщику - YP и по статусу - "Выдан" (/services/autotest-for-resources-requests/resources/?supplier=2604&type=164&state=granted&view=consuming&layout=cards)
      - assert: в таблице нет ресурса "loc:VLA-seg:default-cpu:0.918-mem:0-hdd:0-ssd:0-ip4:0-net:0-io_ssd:0-io_hdd:0"

    3. Открытие формы редактирования со страницы "Подтверждения":
      - do: залогиниться пользователем robot-abc-001
      - do: открыть страницу "Подтверждения" на табе "Ресурсы" (/approves/resources/)
      - assert: в таблице есть запись о запросе ресурса, где потребитель - "autotest-for-resources-requests", а тип - "Квота, аккаунты"
      - do: кликнуть на многоточие в конце строки с запросом ресурса
      - assert: появился попап с двумя блоками - "Статус", в котором есть пункты "Подтвердить" и "Отклонить", и "Редактировать" и "Посмотреть"
      - do: кликнуть на пункт "Редактировать"
      - assert: появилась форма для редактирования запроса ресурса
      - *deleteResource

    4. Редактировать запрос ресурса со страницы "Подтверждения":
      - automation: ABC-10221
      - tags: 
        - skip_manual_check
      - do: залогиниться пользователем robot-abc-001
      - do: открыть страницу "Подтверждения" на табе "Ресурсы" (/approves/resources/)
      - assert: в таблице есть запись о запросе ресурса, где потребитель - "autotest-for-resources-requests", а тип - "Квота, аккаунты"
      - do: кликнуть на многоточие в конце строки с запросом ресурса
      - assert: появился попап с двумя блоками - "Статус", в котором есть пункты "Подтвердить" и "Отклонить", и "Редактировать" и "Посмотреть"
      - do: кликнуть на пункт "Редактировать"
      - screenshot: появилась форма для редактирования запроса ресурса [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-01-27%2012-23-26.png]
      - do: изменить в форме значение "CPU" на 0.002
      - do: кликнуть на кнопку "Отправить"
      - screenshot: показалась модалка, в которой написано, что ресурс запрошен [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-01-27%2012-26-00.png]
      - *deleteResource

    5. Открытие формы просмотра ресурса со страницы "Подтверждения":
      - do: залогиниться пользователем robot-abc-001
      - do: открыть страницу "Подтверждения" на табе "Ресурсы" (/approves/resources/)
      - assert: в таблице есть запись о запросе ресурса, где потребитель - "autotest-for-resources-requests", а тип - "Квота, аккаунты"
      - do: кликнуть на многоточие в конце строки с запросом ресурса
      - assert: появился попап с двумя блоками - "Статус", в котором есть пункты "Подтвердить" и "Отклонить", и "Редактировать" и "Посмотреть"
      - do: кликнуть на пункт "Посмотреть"
      - assert: появилась модалка с просмотром информации о ресурсе
      - *deleteResource

files: 
  - test/features/desktop/approves/resources-approves.hermione.js

priority: critical

tags:
  - reviewed
  - no_assessors
