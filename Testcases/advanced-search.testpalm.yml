feature: Расширенный поиск

specs:
  Внешний вид поисковой стрелки:
    - do: получить выдачу по запросу "metallica"
    - assert: справа от поисковой стрелки есть кнопка "Расширенный поиск"
    - screenshot: внешний вид стрелки с кнопкой [plain]
    - assert: внешний вид соответствует скриншоту
  Изменение версии статики:
    - tags:
        - no_assessors
    - do: получить выдачу по запросу "кхл"
    - assert: справа от поисковой стрелки есть кнопка "Расширенный поиск"
    - do: в консоли браузера выполнить "BEM.blocks['i-global'].param('static-host', 'test');"
    - do: нажать на иконку "Расширенного поиска"
    - assert: выдача обновилась
    - assert: открылась форма расширенного поиска
    - assert: в адресной строке браузера присутствует поле "text=кхл"
  Базовые проверки:
    beforeEach:
      - do: получить выдачу по запросу "metallica"
      - assert: получена выдача по указанному запросу
      - do: нажать на иконку "Расширенного поиска"
      - tech: сработал счетчик '/head/advanced-search' (vars='action=open')
      - assert: открылась форма расширенного поиска
      - assert: по умолчанию ни один фильтр не выбран
      - screenshot: внешний вид без активных фильтров [advanced-search-form >> plain]
      - assert: внешний вид соответствует скриншоту
    Внешний вид:
      - label: advanced-search-form
      - screenshot: внешний вид без активных фильтров [plain]
      - assert: внешний вид соответствует скриншоту
    Очистка параметров:
      - tags:
          - smoke_extended
      - do: нажать на фильтр "За сутки"
      - do: нажать на кнопку "Найти"
      - assert: выдача обновилась
      - assert: в урле появился параметр '&within=77'
      - assert: фильтр "За сутки" отображается активным
      - do: нажать на кнопку "Очистить"
      - tech: сработал счетчик '/head/advanced-search/clear'
      - assert: выдача обновилась
      - assert: из урла исчез параметр '&within=77'
      - assert: ни один фильтр в форме расширенного поиска не является активным
      - assertMetrics: '*'
    Форма поиска открывается и закрывается:
      - tags:
          - smoke_extended
      - do: проскроллить выдачу вниз до конца и перейти на вторую страницу поисковой выдачи кликнув в кнопку "2"
      - assert: загружена 2-я страница выдачи
      - tech: сработал счетчик '/$page/$main/$pager/button[@pageno=1]
      - assert: форма расширенного поиска отображается на выдаче
      - assert: кнопка "Расширенный поиск" активна
      - do: навести курсор мыши на иконку "Расширенного поиска"
      - screenshot: внешний вид кнопки с ховером [button_hovered]
      - assert: внешний вид соответствует скриншоту
      - do: нажать на иконку "Расширенного поиска"
      - assert: форма расширенного поиска исчезла
      - tech: сработал счетчик '/head/advanced-search/' (vars="action=close")
      - assertMetrics: '*'
    Повторный показ саджеста:
      - do: кликнуть в кнопку "Изменить регион"
      - assert: инпут стал активен
      - assert: кнопка "Изменить регион" исчезла
      - do: ввести в инпут слово "Россия"
      - assert: появился саджест
      - do: скопировать в буфер обмена содержимое ипнута
      - do: кликнуть в крестик для очистки инпута
      - assert: инпут очистился
      - assert: саджест исчез
      - do: вставить в инпут нажатием "Ctrl+V"
      - assert: в поле ввода вставился запрос "Россия"
      - assert: появился саджест
  Проверка фильтров:
    beforeEach:
      - do: получить выдачу по запросу "metallica"
      - assert: получена выдача по указанному запросу
      - do: нажать на иконку "Расширенного поиска"
      - tech: сработал счетчик '/head/advanced-search' (vars='action=open')
      - assert: открылась форма расширенного поиска
      - assert: по умолчанию ни один фильтр не выбран
    Общая проверка:
      - tags:
          - smoke_extended
      - do: нажать региональный фильтр (поиск по домашнему региону)
      - do: нажать на левую кнопку в панели выбора языка
      - do: нажать кнопку "За сутки"
      - do: нажать на кнопку "Найти"
      - assert: выдача перезагрузилась
      - assert: региональный фильтр активен
      - assert: в урл добавился параметр '&rstr={номер_региона}'
      - assert: кнопка "За сутки" активна
      - assert: левая кнопка на языковой панели активна
      - assert: в урл добавился параметр '&lang={аббревиатура выбранного языка}'
      - assert: в урл добавился параметр '&within=77'
      - do: нажать на текст "Очистить"
      - assert: выдача перезагрузилась
      - assert: ни один фильтр в форме расширенного поиска не является активным
      - assert: в урле отсутствуют параметры 'rstr', 'within', 'lang'
      - assertMetrics: '*'
    Поиск в домашнем регионе:
      - tags:
          - smoke_extended
      - do: кликнуть в кнопку с названием вашего региона в левом верхнем углу формы расширенного поиска
      - tech: сработал счетчик '/head/advanced-search/region' (vars='type=set,action=dynamic_click')
      - do: нажать на кнопку "Найти"
      - assert: выдача обновилась
      - assert: в урл добавился параметр '&rstr=...'
      - assert: кнопка c названием региона активна
      - screenshot: внешний вид [change_region]
      - assert: внешний вид соответствует скриншоту
      - assertMetrics: '*'
    Поиск в другом регионе:
      - tags:
          - smoke_extended
      - do: кликнуть в кнопку "Изменить регион"
      - tech: сработал счетчик '/head/advanced-search/region' (vars='type=edit,action=dynamic_click')
      - assert: инпут стал активен
      - assert: кнопка "Изменить регион" исчезла
      - do: ввести в инпут слово "Чита"
      - assert: появился саджест
      - screenshot: внешний вид саджеста для выбора региона [suggest]
      - assert: внешний вид соответствует скриншоту
      - do: кликнуть в первый элемент саджеста
      - do: нажать на кнопку "Найти"
      - assert: выдача обновилась
      - assert: в урле появился параметр '&rstr=...'
      - assert: кнопка региона стала активной
      - assert: в кнопке отображается название выбранного элемента саджеста
      - screenshot: внешний вид [change_region]
      - assert: внешний вид соответствует скриншоту
      - do: нажать кнопку "Очистить"
      - tech: сработал счетчик '/head/advanced-search/clear'
      - do: нажать на кнопку "Найти"
      - assert: выдача обновилась
      - assert: фильтр региона не является активным
      - assert: в урле отсутствуют параметр 'rstr'
      - assertMetrics: '*'
    Кнопка "Изменить регион" - тултип:
      - do: навести курсор мыши на кнопку "Изменить регион"
      - assert: отобразился тултип "Изменить регион
      - assertMetrics: '*'
    Смена языка найденных документов:
      - tags:
          - smoke_extended
      - do: кликнуть по кнопке "Русский"
      - tech: сработал счетчик '/head/advanced-search/lang' (vars='value=ru,action=dynamic_click')
      - do: кликнуть по кнопке "Найти"
      - assert: выдача обновилась
      - assert: в урле появился параметр '&lang=ru'
      - assert: кнопка "Русский" активна
      - do: кликнуть по кнопке "Английский"
      - tech: сработал счетчик '/head/advanced-search/lang' (vars='value=en,action=dynamic_click')
      - do: кликнуть по кнопке "Найти"
      - assert: выдача обновилась
      - assert: в урле к имеющемуся параметру '&lang' добавилось en значение и имеет вид '&lang=ru%2Cen'
      - assert: кнопки "Русский" и "Английский" активны
      - screenshot: внешний вид расширенного поиска при поиске на двух языках [lang]
      - assert: внешний вид соответствует скриншоту
      - assertMetrics: '*'
    Проверка выпадающего списка кнопки "Еще":
      - do: кликнуть по кнопке "Еще"
      - tech: сработал счетчик '/head/advanced-search/lang' (vars='action=dynamic_click')
      - assert: появился выпадающий список с языками
      - screenshot: внешний вид [lang-popup]
      - assert: внешний вид соответствует скриншоту
      - do: нажать кнопку "Вверх" на клавиатуре
      - assert: последний элемент выпадающего списка выделен
      - do: нажать кнопку "Enter" на клавиатуре
      - do: нажать на клавишу "Escape"
      - assert: попап закрылся
      - assert: нажать на кнопку "Найти"
      - assert: выдача перезагрузилась
      - assert: в урле появился параметр '&lang=fr'
      - assert: последний элемент выпадающего списка выделен и выбран
      - screenshot: внешний вид [lang-popup2]
      - assert: внешний вид соответствует скриншоту
      - do: навести курсор мыши на первый элемент выпадающего списка
      - assert: первый элемент выпадающего списка выделен
      - do: кликнуть в первый элемент выпадающего списка
      - do: нажать на клавишу "Escape"
      - assert: попап закрылся
      - assert: нажать на кнопку "Найти"
      - assert: выдача обновилась
      - assert: выпадающий список открыт
      - assert: первый элемент выпадающего списка выделен
      - assert: первый и последний элементы выпадающего списка выбраны
      - assert: в урле значение параметра изменилось на '&lang=be%2Cfr'
      - do: обновить страницу
      - assert: страница обновилась
      - do: кликнуть по кнопке "Еще"
      - tech: сработал счетчик '/head/advanced-search/lang' (vars='action=dynamic_click')
      - assert: выпадающий список открыт
      - assert: первый элемент выпадающего списка выделен
      - assert: первый и последний элементы выпадающего списка выбраны
      - assertMetrics: '*'
    Поиск в свежем (за сутки):
      - tags:
          - smoke_extended
      - do: кликнуть по кнопке "За сутки"
      - do: кликнуть по кнопке "Найти"
      - tech: сработал счетчик '/head/advanced-search/within' (vars='-period=77,action=dynamic_click')
      - assert: выдача обновилась
      - assert: в урле появился параметр '&within=77'
      - assert: кнопка активна
      - screenshot: внешний вид расширенного поиска при поиске за сутки [search_from_yesterday]
      - assert: внешний вид соответствует скриншоту
      - do: кликнуть по кнопке "За сутки" ещё раз
      - do: кликнуть по кнопке "Найти"
      - tech: сработал счётчик '/head/advanced-search/within' (vars='-period=77,action=dynamic_click')
      - assert: выдача обновилась
      - assert: в урле отсутствует параметр '&within=77'
      - assert: кнопка стала неактивна
      - assertMetrics: '*'
  # Тест кейс по следам бага SERP-73458
  Отступ при сворачивании расширенного поиска:
    - do: получить выдачу по запросу "test"
    - assert: справа от поисковой стрелки есть кнопка "Расширенный поиск"
    - screenshot: внешний вид первого результата выдачи и оступа от шапки [plain-before-advanced-search]
    - do: нажать на иконку "Расширенного поиска"
    - tech: сработал счетчик '/head/advanced-search' (vars='action=open')
    - assert: открылась форма расширенного поиска
    - do: нажать на иконку "Расширенного поиска"
    - assert: форма расширенного поиска исчезла
    - assert: кнопка "Расширенный поиск" не активна
    - tech: сработал счетчик '/head/advanced-search/' (vars="action=close")
    - screenshot: внешний вид первого результата и оступа от шапки после скрытия РП [plain-after-advanced-search]
    - assert: отступ такой же как и на первом скриншоте до первого открытия "Расширенного поиска"
    - assertMetrics: '*'
  Отступ при открытом расширенном поиске:
    - params:
        lang: en
    - do: получить выдачу по запросу "сериалы"
    - screenshot: внешний вид расширенного поиска с отступами от шапки и от первого элемента выдачи [shown-advanced-search]
  # Тест кейс по следам бага SERP-72976
  Проверка параметров в урле при комбинации фильтров:
    - do: получить выдачу по запросу "Металлика"
    - assert: получена выдача по указанному запросу
    - do: нажать на кнопку "Расширенный поиск"
    - assert: раскрылась форма расширенного поиска
    - do: кликнуть в кнопку "Изменить регион" в правой части фильтра региона
    - assert: поле "В регионе" стало активно, отображается каретка ввода
    - do: ввести "Санкт-Петербург" в инпут региона и нажать "Enter" на клавиатуре
    - assert: выдача обновилась аяксом
    - assert: в урл добавился параметр '&rstr=-2'
    - do: кликнуть в левую кнопку на языковой панели
    - do: нажать кнопку "Найти"
    - assert: выдача обновилась
    - assert: в урл добавился параметр '&lang={аббревиатура выбранного языка}'
    - assert: в урле теперь отображается оба параметра '&lang={аббревиатура выбранного языка}' и '&rstr=-2'
    - assert: в форме расширенного поиска оба параметра отображаются активными
    - screnshot: внешний вид [lang-and-region-selected]
  Выбранный в настройках язык не сохраняется в урле при совпадении с языками в РП:
    - do: получить выдачу по запросу "Metallica"
    - assert: получена выдача по указанному запросу
    - do: перейти в настройки (работа с куками)
    - do: поменять язык на английский
    - do: нажать кнопку "Сохранить и вернуться к поиску"
    - assert: кука yp содержит значение lang:!en
    - do: нажать кнопку "Найти"
    - assert: проверить, что в запрос НЕ добавился параметр lang
  Выбранный в расширенном поиске язык сохраняется в урле:
    - do: получить выдачу по запросу "Metallica"
    - assert: получена выдача по указанному запросу
    - do: перейти в настройки (работа с куками)
    - do: поменять язык на английский
    - do: нажать кнопку "Сохранить и вернуться к поиску"
    - assert: кука yp содержит значение lang:!en
    - do: нажать кнопку "Найти"
    - assert: проверить, что в запрос НЕ добавился параметр lang
    - do: нажать кнопку "Русский"
    - do: нажать кнопку "Найти"
    - assert: проверить, что в запрос добавился параметр lang со значениями ru,en
    - do: перейти в настройки
    - do: отключить ограничения области поиска - выбранный язык - Любой
    - do: нажать кнопку "Сохранить и вернуться к поиску"
    - assert: проверить что в урле присутствует параметр lang со значением ru,en
  При сбросе языка в РП, но при наличии его в куках, lang в урле должен быть пустым:
    - do: получить выдачу по запросу "Metallica"
    - do: установить в куки поиск по английскому языку
    - do: обновить выдачу
    - do: убрать в РП выдачу по английскому языку
    - do: нажать кнопку "Найти"
    - assert: в урле содержится параметр lang без значений
    - do: обновить страницу
    - assert: расширенный поиск должен быть открыт

specs-integration:
  Очистка параметров:
    - do: получить выдачу с непустой формой расширенного поиска (выбран фильтр свежести)
    - assert: расширенный поиск должен быть открыт
    - do: кликнуть в кнопку "Очистить"
    - tech: параметр within должен отсутствовать в URL
    - assert: кнопка "за сутки" должна быть неактивна
  Форма поиска открывается и закрывается:
    - do: получить выдачу по запросу "metallica"
    - do: навести мышку на кнопку "Расширенный поиск"
    - do: кликнуть в кнопку "Расширенный поиск"
    - assert: должен появиться форма расширенного поиска
    - assert: кнопка "Расширенный поиск" должна быть активна
    - do: кликнуть в кнопку "Расширенный поиск"
    - assert: форма поиска должна быть скрыта
    - assert: кнопка "Расширенный поиск" должна быть неактивна

files:
  - features/desktop/advanced-search/advanced-search.hermione.js
  - features/desktop/advanced-search/advanced-search.hermione.e2e.js

v-team: Beauty

tags:
  - searchresults
  - advancedsearch
  - reviewed
  # временно выключаем для асессоров до рефакторинга, так как ямлы не были актуализированы при отключении аякса
  - no_assessors

counter: /head/advanced-search

tlds:
  - ru
  - by
  - ua
  - kz
  - uz
