feature: Голосовой поиск
type: Голосовой ввод

specs:
  Проверка голосового ввода:
    Короткий запрос [manual]:
      - automation: SERP-85896
      - tags:
          - smoke
          - smoke_extended
          - skip_manual_check
      - do: получить выдачу по запросу 'погода в москве'
      - assert: справа от поисковой стрелки появилась иконка микрофона. Иконка может появиться с задержкой. Если иконка не отображается, проверьте подключен ли ваш микрофон и есть ли к нему доступ
      - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет. На устройстве должен быть выдан доступ к микрофону - проверить доступ можно кликнув в значок замочка в левой части адресной строки браузера)
      - assert: появился попап голосового ввода
      - assert: надпись 'Говорите...' совершает волнообразные движения
      - do: произнести короткий поисковый запрос 'москва'
      - assert: на месте надписи 'Говорите' появляется распознанный запрос
      - assert: во время произнесения запроса снизу мигает желтый индикатор
      - assert: после завершения голосового ввода попап исчез
      - assert: выдача обновилась
      - assert: в инпуте запрос 'москва'
      - assertMetrics: '*'
    Длинный запрос [manual]:
      - automation: SERP-85896
      - tags:
          - skip_manual_check
      - do: получить выдачу по запросу 'погода в москве'
      - do: уменьшить ширину окна браузера вдвое
      - assert: справа от поисковой стрелки появилась иконка микрофона. Иконка может появиться с задержкой. Если иконка не отображается, проверьте подключен ли ваш микрофон и есть ли к нему доступ
      - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет. На устройстве должен быть выдан доступ к микрофону - проверить доступ можно кликнув в значок замочка в левой части адресной строки браузера)
      - assert: появился попап голосового ввода
      - assert: надпись 'Говорите...' совершает волнообразные движения
      - do: произнести длинный поисковый запрос 'погода в санкт-петербурге на 14 дней от гидрометцентра Российкой Федерации'
      - assert: на месте надписи 'Говорите' появляется распознанный запрос
      - assert: когда запрос перестает умещаться в попапе, текст переносится на новую строку
      - assert: во время произнесения запроса снизу мигает желтый индикатор
      - assert: после завершения голосового ввода попап исчез
      - assert: выдача обновилась
      - assert: в инпуте запрос 'погода в санкт Петербурге на 14 дней от гидрометцентра российской федерации'
      - assertMetrics: '*'
    Распознавание останавливается при свертывании браузера [manual]:
      - automation: SERP-85896
      - tags:
          - skip_manual_check
      - do: получить выдачу по запросу 'погода в москве'
      - assert: справа от поисковой стрелки появилась иконка микрофона. Иконка может появиться с задержкой. Если иконка не отображается, проверьте подключен ли ваш микрофон и есть ли к нему доступ
      - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет. На устройстве должен быть выдан доступ к микрофону - проверить доступ можно кликнув в значок замочка в левой части адресной строки браузера)
      - assert: появился попап голосового ввода
      - do: свернуть браузер
      - do: произнести поисковый запрос 'москва'
      - do: снова открыть браузер
      - assert: попап голосового ввода отсутствует
      - assert: в инпуте запрос 'погода в москве'
      - assertMetrics: '*'
  Проверка интерфейса:
    beforeEach:
      - do: получить выдачу по запросу 'погода в Москве'
      - assert: справа от поисковой стрелки появилась иконка микрофона. Иконка может появиться с задержкой. Если иконка не отображается, проверьте выдан ли доступ к микрофону на устройстве - проверить доступ можно кликнув в значок замочка в левой части адресной строки браузера.
    Внешний вид строки поиска голосового ввода:
      - label: voice-search__plain-{{SET_NAME}}
      - screenshot: внешний вид [plain]
    Базовые проверки крестика и попапа:
      - screenshot: внешний вид [voice-search__plain-{{SET_NAME}} >> plain]
      - tags:
          - smoke_extended
      - assert: крестик виден
      - do: кликнуть на крестик
      - screenshot: внешний вид пустой строки поиска [clear]
      - assert: поисковый инпут пуст
      - assert: крестик отсутствует
      - do: кликнуть в паранджу
      - assert: саджест c паранджой закрылся
      - do: ховер на микрофон
      - screenshot: внешний вид микрофона под ховером [hover]
      - do: кликнуть на микрофон
      - tech: сработали динамические счетчики '/header/microphone' и '/header/microphone/start'
      - assert: появляется попап голосового ввода 'Говорите...'
      - screenshot: внешний вид попапа голосового ввода [popup]
      - tech: сработал динамический счетчик '/header/microphone/init'
      - do: кликнуть в паранджу
      - assert: попап с голосовым вводом исчез
      - tech: сработали динамические счетчики '/header/microphone/hide' и '/header/microphone/hide' с 'vars = -eventType=paranja-click'
      - assertMetrics: '*'
    Способы закрытия попапа:
      Крестик:
        - screenshot: внешний вид [voice-search__plain-{{SET_NAME}} >> plain]
        - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет. Если иконка не отображается, проверьте подключен ли ваш микрофон и есть ли к нему доступ)
        - assert: появился попап голосового ввода
        - do: кликнуть крестик в попапе
        - assert: попап с голосовым вводом закрыт
        - tech: сработали динамические счетчики '/header/microphone/stop' и '/header/microphone/hide' с 'vars = -eventType=cross-close'
        - assertMetrics: '*'
      Кнопка Назад:
        - screenshot: внешний вид [voice-search__plain-{{SET_NAME}} >> plain]
        - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет. Если иконка не отображается, проверьте подключен ли ваш микрофон и есть ли к нему доступ)
        - assert: появился попап голосового ввода
        - do: нажать кнопку "назад" в браузере
        - assert: попап с голосовым вводом закрыт
        - tech: сработали динамические счетчики '/header/microphone/stop' и '/header/microphone/hide' с 'vars = -eventType=history-change'
        - assertMetrics: '*'
      Скролл:
        - screenshot: внешний вид [voice-search__plain-{{SET_NAME}} >> plain]
        - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет. Если иконка не отображается, проверьте подключен ли ваш микрофон и есть ли к нему доступ)
        - assert: появился попап голосового ввода
        - do: проскроллить выдачу вниз
        - assert: попап с голосовым вводом закрыт
        - tech: сработали динамические счетчики '/header/microphone/stop' и '/header/microphone/hide' с 'vars = -eventType=scroll-page'
        - assertMetrics: '*'
      Кнопка Esc:
        - screenshot: внешний вид [voice-search__plain-{{SET_NAME}} >> plain]
        - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет. Если иконка не отображается, проверьте подключен ли ваш микрофон и есть ли к нему доступ)
        - assert: появился попап голосового ввода
        - do: нажать кнопку Esc на клавиатуре
        - assert: попап с голосовым вводом закрыт
        - tech: сработали динамические счетчики '/header/microphone/stop' и '/header/microphone/hide' с 'vars = -eventType=esc-key'
        - assertMetrics: '*'
      Ожидание:
        - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет. Если иконка не отображается, проверьте подключен ли ваш микрофон и есть ли к нему доступ)
        - assert: появился попап голосового ввода
        - do: подождать 15 секунд
        - assert: попап с голосовым вводом закрыт
        - tech: сработали динамические счетчики '/header/microphone/stop' и '/header/microphone/hide' с 'vars = -eventType=timeout-empty'
        - assertMetrics: '*'
    Доступ заблокирован:
      Попап показа ошибки:
        - screenshot: внешний вид [voice-search__plain-{{SET_NAME}} >> plain]
        - do: заблокировать доступ к микрофону в браузере
        - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет)
        - assert: появился попап "Вы заблокировали доступ к микрофону"
        - screenshot: попап заблокированного микрофона виден [block-popup]
        - tech: сработал динамический счетчик '/header/microphone/error'
        - do: нажать кнопку "Как настроить микрофон"
        - assert: в новой вкладке открылся сервис Яндекс.Помощь со статьей "Голосовой Поиск"
        - tech: срабоал динамический счетчик '/header/microphone/hide/' c 'vars=-eventType=btn-help'
        - assertMetrics: '*'
      Кнопка "Продолжить поиск":
        - screenshot: внешний вид [voice-search__plain-{{SET_NAME}} >> plain]
        - do: заблокировать доступ к микрофону в браузере
        - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет)
        - assert: появился попап "Вы заблокировали доступ к микрофону"
        - screenshot: внешний вид попапа заблокированного микрофона [block-popup]
        - do: нажать на кнопку "Продолжить поиск"
        - assert: попап закрылся
        - tech: сработал динамический счетчик '/header/microphone/hide' с 'vars = -eventType=btn-continue'
        - assertMetrics: '*'
    Отсутствует интернет:
      - do: отключить на устройстве интернет
      - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет)
      - assert: появился попап "Ошибка соединения"
      - tech: сработал динамический счетчик '/header/microphone/error/' c 'vars= -message=offline'
      - screenshot: внешний вид попапа отсутствующего подключения [offline]
      - do: нажать кнопку "Продолжить поиск"
      - assert: попап закрылся
      - tech: сработал динамический счетчик '/header/microphone/hide/' c 'vars= -eventType=btn-continue'
      - assertMetrics: '*'
  Попап открывается после загрузки страницы:
    - params:
        promo: show-voice-input
    - do: получить выдачу по запросу 'погода в Москве'
    - do: добавить в урл параметр '&promo=show-voice-input', если его нет, и перейти по измененному урлу
    - assert: появляется попап с надписью 'Говорите...'
    - assert: параметр '&promo=show-voice-input' отсутствует в урле
    - do: кликнуть крестик в попапе
    - assert: попап с голосовым вводом закрылся
    - do: нажать на кнопку 'Найти'
    - assert: выдача обновляется
    - assert: параметр '&promo=show-voice-input' отсутствует
    - assertMetrics: '*'
  Голосовой поиск отключен:
    - params:
        exp_flags:
          - voice_search_disable=1
    - do: если у вас нет поключенного и исправного микрофона, то сразу отмечайте данный тест как failed
    - do: получить выдачу по запросу 'погода в Москве'
    - do: подождать 5 секунд
    - assert: иконка голосового ввода отсутствует
    - assertMetrics: '*'
  Флаг query_source=voice убирается при перезапросе:
    beforeEach:
      - do: получить выдачу по запросу 'погода в москве' при помощи голосового ввода (иконки микрофона справа от поисковой стрелки. Если иконка не отображается, проверьте подключен ли ваш микрофон и есть ли к нему доступ)
    При перезапросе через стрелку:
      - do: поменять значение 'погода в москве' на 'котики' в инпуте
      - assert: запрос изменился
      - do: клик в кнопку 'Найти'
      - assert: выдача обновилась
      - assert: параметр query_source=voice отсутствует в урле
      - assertMetrics: '*'
    При клике по ссылке:
      - do: кликнуть первую ссылку в связанных запросах внизу страницы
      - assert: выдача обновилась
      - assert: параметр query_source=voice отсутствует в урле
      - assertMetrics: '*'
  Голосовой поиск делает запрос:
    - do: получить выдачу по запросу 'погода в Москве'
    - assert: справа от поисковой стрелки появилась иконка микрофона. Иконка может появиться с задержкой. Если иконка не отображается, проверьте подключен ли ваш микрофон и есть ли к нему доступ
    - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет)
    - assert: появился попап голосового ввода
    - assert: надпись 'Говорите...' совершает волнообразные движения
    - do: произнести короткий поисковый запрос 'москва'
    - assert: на месте надписи 'Говорите' появляется распознанный запрос
    - assert: во время произнесения запроса снизу мигает желтый индикатор
    - assert: после завершения голосового ввода попап исчез
    - assert: выдача обновилась
    - assert: в инпуте запрос 'москва'
  Кнопка голосового поиска видна сразу:
    - params:
        exp_flags: only=pre-search
    - do: получить выдачу по запросу 'погода в Москве'
    - assert: кнопка Голосового поиска винда справа от поисковой стрелки
  Доступность:
    beforeEach:
      - do: получить выдачу по запросу 'погода в Москве'
      - assert: справа от поисковой стрелки появилась иконка микрофона. Иконка может появиться с задержкой. Если иконка не отображается, проверьте подключен ли ваш микрофон и есть ли к нему доступ
    Нормальное состояние:
      - tags:
        - a11y_serp
      - assert: крестик виден
      - do: кликнуть на крестик
      - assert: поисковый инпут пуст
      - assert: крестик отсутствует
      - do: кликнуть в паранджу
      - assert: саджест c паранджой закрылся
      - do: кликнуть на микрофон
      - assert: появляется попап голосового ввода 'Говорите...'
      - tech: у заголовка должен быть атрибут aria-hidden="true"
      - tech: есть скрытый элемент с текстом 'Говорите...'
      - tech: у скрытого элемента должен быть атрибут role="alert"
      - tech: выполнить скрипт в console браузера - await axe.run('.voice-search-popup')
      - tech: в консоль вывелся объект, у которого свойство `violations` - пустой массив []
    Доступ заблокирован:
      - tags:
        - a11y_serp
      - do: заблокировать доступ к микрофону в браузере
      - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет)
      - assert: появился попап "Вы заблокировали доступ к микрофону"
      - tech: у заголовка должен быть атрибут role="alert"
      - tech: выполнить скрипт в console браузера - await axe.run('.voice-search-popup')
      - tech: в консоль вывелся объект, у которого свойство `violations` - пустой массив []
    Отсутствует интернет:
      - tags:
        - a11y_serp
      - do: разрешить доступ к микрофону в браузере
      - do: отключить на устройстве интернет
      - do: кликнуть иконку микрофона справа от поисковой стрелки (В самой поисковой строке иконки микрофона нет)
      - assert: появился попап "Ошибка соединения"
      - tech: у заголовка должен быть атрибут role="alert"
      - tech: выполнить скрипт в console браузера - await axe.run('.voice-search-popup')
      - tech: в консоль вывелся объект, у которого свойство `violations` - пустой массив []

files:
  - features/desktop/voice-search/voice-search.hermione.js

v-team: Beauty

tags:
  - voice
  - popup
  - input
  - reviewed
  - skip_e2e_check

# Голосовой поиск никак не зависит от данных и от запроса пользователя, т.е. он контекстнонезависимый.
# Таким образом, целесообразнее проводить функциональное тестирование, e2e никакого профита не принесет.
counter: /header/microphone

tlds:
  - ru
  - by
  - uz
  - ua
  - kz
