feature: Логирование клиентских ошибок

specs:
  Проверка обработки ошибки в pre-search:
    - params:
        exp_flags: script_error=pre-search
    - do: получить выдачу по запросу 'test'
    - tech: выполнить в консоли Ya.jserrorsPrev.length
    - assert: должно быть 1
    - tech: выполнить в консоли Ya.jserrors.length
    - assert: должно быть 1
    - tech: выполнить в консоли Ya.jserrorsPrev[0][0]
    - assert: должна быть строка содержащая pre-search
    - tech: выполнить в консоли Ya.jserrorsPrev[0][0] === Ya.jserrors[0].message
    - assert: должно быть true
    - tech: выполнить в консоли Ya.jserrorsPrev[0][1] === Ya.jserrors[0].url
    - assert: должно быть true
    - tech: выполнить в консоли Ya.jserrorsPrev[0][2] === Ya.jserrors[0].line
    - assert: должно быть true
    - tech: выполнить в консоли Ya.jserrorsPrev[0][3] === Ya.jserrors[0].col
    - assert: должно быть true
    - tech: выполнить в консоли Ya.jserrorsPrev[0][4].toString() === Ya.jserrors[0].error.toString()
    - assert: должно быть true

  Проверка обработки ошибки в post-search:
    - params:
        exp_flags: script_error=post-search
    - do: получить выдачу по запросу 'test'
    - tech: выполнить в консоли Ya.jserrorsPrev.length
    - assert: должно быть 0
    - tech: выполнить в консоли Ya.jserrors.length
    - assert: должно быть 1
    - tech: выполнить в консоли Ya.jserrors[0].message
    - assert: должна быть строка содержащая post-search

  Проверка счетчиков:
    - do: получить выдачу по запросу 'test'
    - tech: вызвать функцию window.logSerpJsError c пустым урлом и проверить счетчик
    - tech: вызвать функцию window.logSerpJsError c урлом ошибки extension_bindings и проверить счетчик
    - tech: вызвать функцию window.logSerpJsError c урлом ошибки miscellaneous_binding и проверить счетчик
    - tech: вызвать функцию window.logSerpJsError c протоколом урла 'chrome:' и проверить счетчик
    - tech: вызвать функцию window.logSerpJsError c протоколом урла 'file:' и проверить счетчик
    - tech: вызвать функцию window.logSerpJsError c урлом 'https://yandex.ru' и проверить счетчик
    - tech: вызвать функцию window.logSerpJsError c урлом 'https://yandex.ru', catchType - 'test' и проверить счетчик
    - tech: вызвать функцию window.onerror c урлом 'https://yandex.ru' и проверить счетчик

  Проверка ошибок в AJAX assets:
    - description: |
              есть скрипт проверки
              BEM.blocks['i-request_type_ajax'].prototype._updateAssets({
                assets: {
                  assets: [{ type: 'script', content: 'throw new Error("HermioneTestError in an asset");' }]
                }
              });
    - do: получить выдачу по запросу 'test'
    - do: в консоли DevTools выполнить скрипт из description
    - tech: в консоли должно быть выведено сообщение об ошибке с текстом 'HermioneTestError in an asset'
    - do: в консоли DevTools набрать и выполнить Ya.jserrors
    - tech: в консоли должен быть выведен массив с одним объектом ошибки
    - tech: в объекте ошибки должно быть поле message со значением 'HermioneTestError in an asset'

files:
  - features/common/log-serp-js-error/log-serp-js-error.hermione.js

v-team: Architecture

tags:
  - counters
  - reviewed
  - no_assessors
  - skip_e2e_check

tlds: none
