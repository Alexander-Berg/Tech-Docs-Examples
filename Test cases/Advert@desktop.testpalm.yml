feature: advert-react
tlds: ru
tags: no_assessors

specs:
  Реклама должна не показываться на странице под флагом adv_disabled:
    - params:
        exp_flags:
          - adv-disabled=1
          - force-react-advert=1
    - do: открыть страницу '/turbo?stub=advert/react-basic.json'
    - assert: убедиться, что на странице нет рекламы

  Реклама должна показываться на странице без флага adv_disabled:
    - params:
        exp_flags:
          - force-react-advert=1
    - do: открыть страницу '/turbo?stub=advert/react-basic.json'
    - assert: убедиться, что на странице есть реклама
  
  Реклама не должна показываться на странице при медленных соединениях под флагом:
      - params:
          exp_flags:
            - force-react-advert=1
            - ads-on-bad-connection=1
          user_connection: slow_connection=1
      - do: получить выдачу по запросу 'https://yandex.ru/turbo?stub=advert/react-basic.json&exp_flags=ads-on-bad-connection=1&exp_flags=force-react-advert=1&user_connection=slow_connection=1'
      - assert: убедится что на странице нет рекламы

  Реактовая реклама должна не показываться без флага включающего ее:
    - do: открыть страницу '/turbo?stub=advert/react-basic.json'
    - assert: убедится что на странице есть реклама

  Скриншот стаба рекламы:
    - do: открыть страницу '/turbo?stub=advert/react-basic.json&hermione_advert=stub'
    - screenshot: реклама отображается в вечной загрузке [plain]

  RUM-счётчики про скорость рекламы (adfox):
    - params:
        exp_flags:
          - adv-disabled=0
          - force-react-advert=1
    - tags: no_assessors
    - do: открыть ссылку https://yandex.ru/turbo?stub=advert%2Freact-rum-counters-desktop-1-adfox.json
    - tech: проверить наличие счётчиков 690.2096.207 (/tech/perf/time)
    - tech: |
        Со следующими наборами переменных
        143(page)='28.2719.2048'(/ru/turbo/desktop), 1701(id)='1724'(/load), 1(ad)='2930'(/adfox), 1366(paid)='257673', 2322(start_time)=/[0-9.]+/, 2877(delta)=/[0-9.]+/
        143(page)='28.2719.2048'(/ru/turbo/desktop), 1701(id)='2046'(/render), 1(ad)='2930'(/adfox), 1366(paid)='257673', 2322(start_time)=/[0-9.]+/, 2877(delta)=/[0-9.]+/
    - do: проскроллить до конца страницы
    - assert: должна подгрузиться вторая страница с рекламой
    - tech: проверить, что нет других счётчиков про скорость загрузки рекламы, кроме оправленных выше

  RUM-счётчики про скорость рекламы (partner):
    - params:
        exp_flags:
          - adv-disabled=0
          - force-react-advert=1
    - tags: no_assessors
    - do: открыть ссылку https://yandex.ru/turbo?stub=advert%2Freact-rum-counters-desktop-1-partner.json
    - tech: проверить наличие счётчиков 690.2096.207 (/tech/perf/time)
    - tech: |
        Со следующими наборами переменных
        143(page)='28.2719.2048'(/ru/turbo/desktop), 1701(id)='1724'(/load), 1(ad)='1219'(/partner), 1366(paid)='196263', 2322(start_time)=/[0-9.]+/, 2877(delta)=/[0-9.]+/
        143(page)='28.2719.584'(/ru/turbo/touch), 1701(id)='3105'(/prerender), 1(ad)='2930'(/adfox), 1366(paid)='257673', 2322(start_time)=/[0-9.]+/, 2877(delta)=/[0-9.]+/
        143(page)='28.2719.2048'(/ru/turbo/desktop), 1701(id)='2046'(/render), 1(ad)='1219'(/partner), 1366(paid)='196263', 2322(start_time)=/[0-9.]+/, 2877(delta)=/[0-9.]+/
    - do: проскроллить до конца страницы
    - assert: должна подгрузиться вторая страница с рекламой
    - tech: проверить, что нет других счётчиков про скорость загрузки рекламы, кроме оправленных выше

  Должны пробрасываться параметры cacheId и adSessionId:
    - params:
        exp_flags:
          - adv-disabled=0
          - force-react-advert=1
    - tags: no_assessors
    - do: открыть ссылку https://yandex.ru/turbo?stub=advert/partner-cache-1.json&hermione_advert=stub&load-react-advert-script=1
    - tech: получить объект window.AdvertCalls
    - assert: в массиве partner есть вызов для блока R-I-260855-1
    - assert: у вызова R-I-260855-1 свойству cacheId соответствует значение "123", а свойству adSessionId значение "abc"
    - assert: в массиве partner есть вызов для блока R-I-260855-2
    - assert: у вызова R-I-260855-2 свойству cacheId соответствует значение "234", а свойству adSessionId значение "abc"
    - do: проскроллить до конца страницы
    - assert: должна подгрузиться вторая страница с рекламой
    - tech: получить объект window.AdvertCalls
    - assert: в массиве partner есть вызов для блока R-I-260855-3
    - assert: у вызова R-I-260855-3 нет свойства cacheId и adSessionId
    - assert: в массиве partner есть вызов для блока R-I-260855-4
    - assert: у вызова R-I-260855-4 свойству cacheId соответствует значение "456", а свойству adSessionId значение "bcd"
    - do: проскроллить до конца страницы
    - assert: должна подгрузиться третья страница с рекламой
    - tech: получить объект window.AdvertCalls
    - assert: в массиве partner есть вызов для блока R-I-260855-5
    - assert: у вызова R-I-260855-5 нет свойства cacheId и adSessionId
    - assert: в массиве partner есть вызов для блока R-I-260855-6
    - assert: у вызова R-I-260855-6 нет свойства cacheId и adSessionId

  partner:
    Для горизонтальной рекламы должен добавляться параметр выравнивания:
      - tags: no_assessors
      - do: открыть страницу c рекламой (yandex.ru/turbo?stub=advert/partner-params.json&hermione_advert=stub&exp_flags=adv-disabled=0&exp_flags=force-react-advert=1&load-react-advert-script)
      - tech: получить объект window.AdvertCalls
      - assert: в массиве partner есть вызов для блока R-A-0001-01
      - assert: у вызова R-A-0001-01 есть доп. параметр horizontalAlign=1
      - assert: в массиве partner есть вызов для блока R-A-0001-02
      - assert: у вызова R-A-0001-02 нет доп. параметра horizontalAlign
      - tech: в консоли нет ошибок

files:
- platform/components/Advert/__tests__/Advert.hermione.js
- platform/components/Advert/__tests__/Advert@desktop.hermione.js

v-team: Turbo

manager: tanzwuta

qa-engineer: dakhetov, olga0321
