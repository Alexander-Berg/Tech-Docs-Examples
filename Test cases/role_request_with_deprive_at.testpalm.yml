feature: Запрос роли

specs:
  beforeEach:
    - do: проверить, что в персональном воркфлоу Тестовой системы указан правильный код для роли "group-101" (/system/testsystem/workflow)
    - screenshot: правильные настройки персонального воркфлоу Тестовой системы [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-11%2013-49-20.png]

  Запрос и отзыв персональной роли до даты :
    - do: запустить в Runner сценарий "Запрос и отзыв роли до даты" (https://github.yandex-team.ru/pixel/idm-runner)
    - do: отправить запрос "Запрос роли до даты через api" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "201"
    - screenshot: запрос "Запрос роли до даты через api" должен содержать поле "ttl_date", значение у которого не null [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-11%2013-53-00.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Отзыв запрошенной до даты роли через api" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Нельзя запросить роль до даты в прошлом:
    - do: запустить в Runner сценарий "Запрос и отзыв роли до даты" (https://github.yandex-team.ru/pixel/idm-runner)
    - do: отправить запрос "Запрос роли до даты через api. Нельзя запросить роль до даты в прошлом" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "400"
    - screenshot: запрос "Запрос роли до даты через api. Нельзя запросить роль до даты в прошлом" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-11%2013-47-35.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Нельзя запросить временную роль больше, чем на год:
    - do: отправить запрос "Нельзя запросить временную роль больше чем на год" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "400"
    - screenshot: запрос "Нельзя запросить временную роль больше чем на год" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-11%2013-54-17.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

priority: blocker

files:
  - idm/tests/request_role/test_ttl.py

tags:
  - reviewed
  - no_assessors
  - postman_automation
  - fitcher:idm-www:blocks/desktop/card/__controls/**
  - fitcher:idm-www:blocks/desktop/role-request-form/**
  - fitcher:idm-www:blocks/desktop/table/__check-panel/**
  - fitcher:idm-www:test/auto/01-roles/01-request/**
  - fitcher:idm_backend_palmsync:idm/tests/request_role/test_ttl.py
  - fitcher:idm_backend_palmsync:idm/core/models/role.py
  - fitcher:idm_backend_palmsync:idm/core/models/rolerequest.py
  - fitcher:idm_backend_palmsync:idm/tests/utils.py
  - fitcher:idm_backend_palmsync:idm/users/models.py
  - fitcher:idm_backend_palmsync:idm/core/exceptions.py
