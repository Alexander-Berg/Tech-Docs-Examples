feature: CartScreen

params:
  exp_flags:
    - analytics-disabled=1

specs:
  beforeEach:
    - do: при дальнейшей проверке указанных ожидаемых результатов обращайте внимание на любые некорректные на ваш взгляд поведения, основываясь на свой опыт использования web-приложений (например, сохранение позиции при переходах туда-обратно кнопками на устройстве, пустые экраны при переходах, кривая верстка, скачкИ элементов, плавность скролла, неработающая функциональность и т.п.)

  Внешний вид пустой корзины:
    - do: получить выдачу по запросу 'site:fulmar.ru' (альтернативные запросы - site:kupicase.ru каталог, 'site:super01.ru')
    - assert: на выдаче присутствует сниппет(ы) с галереей карточек товаров [https://jing.yandex-team.ru/files/skurhanski/chrome_ziIi8LshqE.png]
    - do: кликнуть по любой ссылке сниппета для перехода на страницу магазина
    - assert: открылась страница магазина с активной кнопкой Каталог на нижней панели
    - assert: цветовое оформление может отличаться в зависимости от магазина [https://jing.yandex-team.ru/files/skurhanski/chrome_Gw9upIcJ8I.png]
    - do: если в корзине есть товары, необходимо их удалить
    - screenshot: примерный внешний вид [emptyCart]

  Проверка ссылки на каталог в пустой корзине:
    - do: получить выдачу по запросу 'site:fulmar.ru' (альтернативные запросы - site:kupicase.ru каталог, 'site:super01.ru')
    - assert: на выдаче присутствует сниппет(ы) с галереей карточек товаров [https://jing.yandex-team.ru/files/skurhanski/chrome_ziIi8LshqE.png]
    - do: кликнуть по любой ссылке сниппета для перехода на страницу магазина
    - assert: открылась страница магазина с активной кнопкой Каталог на нижней панели
    - assert: цветовое оформление может отличаться в зависимости от магазина [https://jing.yandex-team.ru/files/skurhanski/chrome_Gw9upIcJ8I.png]
    - do: если в корзине есть товары, необходимо их удалить
    - do: кликнуть по ссылке "Перейти в каталог"
    - assert: осуществился переход в раздел Каталог
    - assert: на нижней навигационной панели активна кнопка Каталог

  Внешний вид корзины с товарами:
    - do: получить выдачу по запросу 'site:fulmar.ru' (альтернативные запросы - site:kupicase.ru каталог, 'site:super01.ru')
    - assert: на выдаче присутствует сниппет(ы) с галереей карточек товаров [https://jing.yandex-team.ru/files/skurhanski/chrome_ziIi8LshqE.png]
    - do: кликнуть по любой ссылке сниппета для перехода на страницу магазина
    - assert: открылась страница магазина с активной кнопкой Каталог на нижней панели
    - assert: цветовое оформление может отличаться в зависимости от магазина [https://jing.yandex-team.ru/files/skurhanski/chrome_Gw9upIcJ8I.png]
    - do: кликнуть по пиктограмме Каталог на нижней панели
    - do: добавить несколько товаров в корзину и перейти в раздел Корзина
    - assert: добавленные товары присутствуют в корзине
    - assert: у каждого товара в корзине есть цена, картинка, название и количество
    - screenshot: примерный внешний вид [Carts]

  Внешний вид корзины с товаром под заказ:
    - tags:
        # воспроизводится только в темпларе
        no_assessors
    - params:
        exp_flags:
          - turboforms_endpoint=multiple/
    - do: открыть страницу https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocart/
    - screenshot: внешний вид корзины соответствует скриншоту (количество товаров и описание может отличаться, надписи "под заказ" может не быть) [plain]

  При наличии товара под заказ прячем выбор способа оплаты, а в данных отправляем "наличными":
    - tags:
        # мокается payment_api
        no_assessors
    - params:
        exp_flags:
          - test_tool=hermione
    - do: перейти по ссылке https://yandex.ru/turbo/zymbo.ru/s/krasota-i-zdorove/rascheska-babochka.html?product_id=2173000024&pcgi=turboofferid%3D2173000024&mock_payment_requests=1
    - do: кликнуть по кнопке добавить в корзину
    - do: кликнуть по кнопке перейти в корзину
    - do: нажать на кнопку "Оформить заказ"
    - assert: открылась страница с формой оформления заказа
    - assert: отсутствует опция выбора способа доставки
    - do: ввести имя "test"
    - do: ввести телефон "88001234567"
    - do: ввести email "test@test.ru"
    - do: ввести адрес "Адрес"
    - do: нажать на кнопку "Оформить заказ"
    - assert: появился попап "Подтверждение заказа"
    - assert: попап сменился попапом "Спасибо за заказ!"
    - tech: запрос в корзину не содержит параметр payment_method

  Удаление товара:
    кнопкой Удалить:
      - do: получить выдачу по запросу 'site:fulmar.ru' (альтернативные запросы - site:kupicase.ru каталог, 'site:super01.ru')
      - assert: на выдаче присутствует сниппет(ы) с галереей карточек товаров [https://jing.yandex-team.ru/files/skurhanski/chrome_ziIi8LshqE.png]
      - do: кликнуть по любой ссылке сниппета для перехода на страницу магазина
      - assert: открылась страница магазина с активной кнопкой Каталог на нижней панели
      - do: кликнуть по пиктограмме Каталог на нижней панели
      - do: добавить один товар в корзину и перейти в раздел Корзина
      - assert: в корзине отображается один товар
      - do: нажать кнопку удаления товара из корзины (урна напротив количества товаров)
      - assert: корзина очистилась
      - assert: появилась ссылка в каталог и сообщение о том, что корзина пуста

    изменением количества:
      - do: получить выдачу по запросу 'site:fulmar.ru' (альтернативные запросы - site:kupicase.ru каталог, 'site:super01.ru')
      - assert: на выдаче присутствует сниппет(ы) с галереей карточек товаров [https://jing.yandex-team.ru/files/skurhanski/chrome_ziIi8LshqE.png]
      - do: кликнуть по любой ссылке сниппета для перехода на страницу магазина
      - assert: открылась страница магазина с активной кнопкой Каталог на нижней панели
      - do: кликнуть по пиктограмме Каталог на нижней панели
      - do: добавить один товар в корзину и перейти в раздел Корзина
      - assert: в корзине отображается один товар
      - do: нажать на кнопку уменьшения количества товаров (кнопка минус)
      - assert: корзина очистилась
      - assert: появилась ссылка в каталог и сообщение о том, что корзина пуста

  Изменение количества товара:
    кнопками:
      - automation: TURBOUI-3854
      - do: получить выдачу по запросу 'site:fulmar.ru' (альтернативные запросы - site:kupicase.ru каталог, 'site:super01.ru')
      - assert: на выдаче присутствует сниппет(ы) с галереей карточек товаров [https://jing.yandex-team.ru/files/skurhanski/chrome_ziIi8LshqE.png]
      - do: кликнуть по любой ссылке сниппета для перехода на страницу магазина
      - assert: открылась страница магазина с активной кнопкой Каталог на нижней панели
      - assert: цветовое оформление может отличаться в зависимости от магазина [https://jing.yandex-team.ru/files/skurhanski/chrome_Gw9upIcJ8I.png]
      - do: кликнуть по пиктограмме Каталог на нижней панели
      - do: добавить один товар в корзину и перейти в раздел Корзина
      - assert: в корзине отображается один товар
      - do: с помощью кнопки "плюс" увеличить количество товаров до трёх
      - assert: количество товаров равно трем
      - tech: в запросе к shopping-cart в поле count указано соответствующее количество товаров
      - assert: итоговая сумма соответствует количеству товаров
      - do: с помощью кнопки "минус" уменьшить количество товаров до двух
      - assert: количество товаров равно двум
      - tech: в запросе к shopping-cart в поле count указано соответствующее количество товаров
      - assert: итоговая сумма соответствует количеству товаров

    вводом значения:
      - automation: TURBOUI-3854
      - do: получить выдачу по запросу 'site:fulmar.ru' (альтернативные запросы - site:kupicase.ru каталог, 'site:super01.ru')
      - assert: на выдаче присутствует сниппет(ы) с галереей карточек товаров [https://jing.yandex-team.ru/files/skurhanski/chrome_ziIi8LshqE.png]
      - do: кликнуть по любой ссылке сниппета для перехода на страницу магазина
      - assert: открылась страница магазина с активной кнопкой Каталог на нижней панели
      - assert: цветовое оформление может отличаться в зависимости от магазина [https://jing.yandex-team.ru/files/skurhanski/chrome_Gw9upIcJ8I.png]
      - do: кликнуть по пиктограмме Каталог на нижней панели
      - do: добавить один товар в корзину и перейти в раздел Корзина
      - assert: в корзине отображается один товар
      - do: кликнуть в область с введенным количеством товара
      - assert: появилась нативная клавиатура устройства
      - do: с помощью клавиатуры изменить количество товаров на трехзначное число
      - assert: количество товаров изменилось и отображается корректно
      - tech: в запросе к shopping-cart в поле count указано соответствующее количество товаров
      - assert: итоговая сумма соответствует количеству товаров
      - do: с помощью клавиатуры изменить количество товаров на двузначное
      - assert: количество товаров изменилось и отображается корректно
      - tech: в запросе к shopping-cart в поле count указано соответствующее количество товаров
      - assert: итоговая сумма соответствует количеству товаров

  Открытие карточки товара:
    - automation: TURBOUI-3854
    - do: получить выдачу по запросу 'site:super01.ru каталог'
    - assert: на выдаче присутствует сниппет(ы) с галереей карточек товаров [https://jing.yandex-team.ru/files/skurhanski/chrome_ziIi8LshqE.png]
    - do: кликнуть по любой ссылке сниппета для перехода на страницу магазина
    - assert: открылась страница магазина с активной кнопкой Каталог на нижней панели
    - assert: цветовое оформление может отличаться в зависимости от магазина [https://jing.yandex-team.ru/files/skurhanski/chrome_Gw9upIcJ8I.png]
    - do: кликнуть по пиктограмме Каталог на нижней панели
    - do: кликнуть по карточке, у которой на кнопке указано "N вариантов"
    - assert: открылась каточка товара, в которой присутствует поле для изменения характеристик товара (например, цвет, размер и т.п.)
    - do: указать другой размер (или цвет) товара
    - do: добавить товар в корзину и перейти в раздел Корзина
    - assert: добавленный товар присутствует в корзине
    - do: кликнуть по товару
    - assert: открылась карточка выбранного товара с указанным ранее размером (или цветом)
    - assert: на нижней навигационной панели активна кнопка Каталог
    - assert: в карточке товара отсутствует кнопка добавления в корзину, вместо нее есть кнопка перехода в корзину

  Переход к оформлению:
    - automation: TURBOUI-3854
    - do: получить выдачу по запросу 'site:fulmar.ru' (альтернативные запросы - site:kupicase.ru каталог, 'site:super01.ru')
    - assert: на выдаче присутствует сниппет(ы) с галереей карточек товаров [https://jing.yandex-team.ru/files/skurhanski/chrome_ziIi8LshqE.png]
    - do: кликнуть по любой ссылке сниппета для перехода на страницу магазина
    - assert: открылась страница магазина с активной кнопкой Каталог на нижней панели
    - assert: цветовое оформление может отличаться в зависимости от магазина [https://jing.yandex-team.ru/files/skurhanski/chrome_Gw9upIcJ8I.png]
    - do: кликнуть по пиктограмме Каталог на нижней панели
    - do: добавить товар в корзину и перейти в раздел Корзина
    - assert: добавленный товар присутствует в корзине
    - do: кликнуть по кнопке оформления заказа
    - assert: открылась страница оформления заказа

  Учитывать валюту товара:
    - do: Открыть страницу https://yandex.ru/turbo/spideradio.github.io/s/rnd/i32iw6?product_id=297
    - do: Нажать кнопку "Добавить в корзину"
    - do: Открыть страницу https://yandex.ru/turbo/spideradio.github.io/s/rnd/do4t?product_id=72
    - do: Нажать кнопку "Добавить в корзину"
    - do: Дождаться изменения надписи на "Перейти в корзину"
    - do: Нажать кнопку "Перейти в корзину"
    - assert: В корзине 2 товара стоимостью "730 ₽" и "15 $"
    - assert: Итоговая сумма "745 ₽"
    - do: Удалить первый товар из корзины
    - assert: В корзине 1 товар стоимостью "15 $"
    - assert: Итоговая сумма "15 $"

  Рекомендации:
    - tags: no_assessors
    - do: открыть https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocart/&exp_flags=turboforms_endpoint=/multiple/delay-2000/&patch=ecomCartRecommends
    - assert: виден спиннер загрузки, но рекомендуемые товары не видны
    - do: дождаться появления товаров в корзине в течение 6 секунд
    - assert: вместе с товарами в корзине появились так же и две карусели рекомендованных товаров

  Избранное в корзине:
    - do: залогиниться на yandex.ru
    - do: открыть страницу https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocatalog/
    - do: добавить товар в корзину и перейти в раздел "Корзина"
    - assert: |
        открылась корзина
        у каждого товара отображается кнопка добавления в избранное
    - screenshot: товар с кнопкой выглядит корректно [plain]
    - do: нажать на кнопку добавления в избранное
    - screenshot: кнопка меняет цвет на красный [saved]
    - do: перезагрузить страницу
    - assert: кнопка все ещё выделена красным
    - do: повторно нажать на кнопку добавления в избранное
    - screenshot: кнопка больше не выделена красным [deleted]

  Промокоды:
    Успешное применение промокода:
      - params:
          exp_flags:
            - analytics-disabled=0
            - turbo-app-cart-fresher=1
      # Для того, чтобы сработал промокод, нужно его к чему-то применить
      # В hermione за товары в корзине отвечает патчинг
      - do: перейти по ссылке https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocart/
      - do: удалить все товары из корзины, если они там есть
      - do: перейти на страницу каталога
      - do: найти и добавить в корзину товар с названием "irure duis laborum esse mollit" и стоимостью 3999 рублей
      - do: найти и добавить в корзину товар с названием "reprehenderit sit labore nulla nisi anim voluptate duis" и стоимостью 2699 рублей
      - do: перейти через нижнюю панель в корзину
      - assert: в корзине должен оказаться добавленный товар и поле промокода
      - do: ввести промокод "JZBEPCOTF"
      - do: нажать на кнопку "Применить"
      - tech: отправилась цель "promo-code-apply-click" в счетчик "53911873"
      - assert: цена товара и общий итог по корзине изменились
      - assert: промокод применился только к части товаров
      - tech: отправилась цель "promo-code-apply-success" с параметром "is-full-cart-applied" "false" в счетчик "53911873"

    Неудачное применение промокода:
      - params:
          exp_flags:
            - analytics-disabled=0
            - turbo-app-cart-fresher=1
      # Для того, чтобы сработал промокод, нужно его к чему-то применить
      # В hermione за товары в корзине отвечает патчинг
      - do: перейти по ссылке https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocart/
      - do: удалить все товары из корзины, если они там есть
      - do: перейти на страницу каталога
      - do: найти и добавить товар с названием "reprehenderit sit labore nulla nisi anim voluptate duis" и стоимостью 2699 рублей
      - do: перейти в корзину
      - assert: в корзине должен оказаться добавленный товар и поле ввода промокода
      - do: ввести промокод "ERROR"
      - do: нажать на кнопку "Применить"
      - screenshot: промокод не применился, ошибка [promo]
      - tech: отправилась цель "promo-code-apply-error" с параметром "error-type" "not-applicable-to-cart" в счетчик "53911873"

    В пустой корзине нет поля промокода:
      - params:
          exp_flags:
            - turbo-app-cart-fresher=1
      - do: перейти по ссылке https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocart/
      - assert: поле ввода промокода отсутствует

    В корзине, к которой нельзя применить промокод, нет поля промокода:
      - params:
          exp_flags:
            - turbo-app-cart-fresher=1
      - do: перейти по ссылке https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocart/
      - do: удалить все товары из корзины, если они там есть
      - do: перейти на страницу каталога
      - do: найти и добавить в корзину товар с названием "cillum laboris consectetur reprehenderit pariatur deserunt" и стоимостью 1199 рублей
      - do: перейти в корзину
      - assert: поле ввода промокода отсутствует

    Поле промокода не пропадает при удалении единственного товара в корзине с промокодом:
      - params:
          exp_flags:
            - turbo-app-cart-fresher=1
      - do: перейти по ссылке https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocart/
      - do: удалить все товары из корзины, если они там есть
      - do: перейти на страницу каталога
      - do: найти и добавить в корзину товар с названием "cillum laboris consectetur reprehenderit pariatur deserunt" и стоимостью 1199 рублей
      - do: найти и добавить в корзину товар с названием "esse ad in nostrud esse sunt" и стоимостью 2799 рублей
      - do: перейти в корзину
      - assert: поле ввода промокода есть на странице
      - do: удалить товар "esse ad in nostrud esse sunt"
      - assert: поле ввода промокода есть на странице

    Изменение условий применения промокода:
      - tags: no_assessors # патчим данные в hermione
      - params:
          exp_flags:
            - turbo-app-cart-fresher=1
      - screenshot: внешний вид язычка [fresher]

    Изменение условий применения промокода и числа товаров:
      - tags: no_assessors # патчим данные в hermione
      - params:
          exp_flags:
            - turbo-app-cart-fresher=1
      - screenshot: внешний вид язычка [fresher]

    Саммери в форме после промокода:
      - params:
          exp_flags:
            - turbo-app-cart-fresher=1
            - turbo-app-cart-form-summary=1
            - turboforms_endpoint=https://test-turbo-forms.common.yandex.ru/
      # Для того, чтобы сработал промокод, нужно его к чему-то применить
      # В hermione за товары в корзине отвечает патчинг
      - do: перейти по ссылке https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocart/
      - do: удалить все товары из корзины, если они там есть
      - do: перейти на страницу каталога
      - do: найти и добавить в корзину товар с названием "irure duis laborum esse mollit" и стоимостью 3999 рублей
      - do: найти и добавить в корзину товар с названием "reprehenderit sit labore nulla nisi anim voluptate duis" и стоимостью 2699 рублей
      - do: перейти через нижнюю панель в корзину
      - assert: в корзине должен оказаться добавленный товар и поле промокода
      - do: ввести промокод "JZBEPCOTF"
      - do: нажать на кнопку "Применить"
      - assert: цена товара и общий итог по корзине изменились
      - assert: промокод применился только к части товаров
      - do: нажать "Оформить заказ"
      - assert: открылась форма оформления заказа
      - do: проскроллить форму вниз
      - assert: внизу над кнпкой отправки есть описание заказа
      - screenshot: суммы могу отличаться [plain]

  Изменение цен и количества товаров:
    beforeEach:
      - do: перейти по ссылке https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocart/
      - assert: в корзине нет товаров
      - do: выполнить в консоли скрипт https://paste.yandex-team.ru/1470961, подменяющий товары в корзине и ответы от сервера
      - assert: в корзине появилось три товара
      - do: выполнить в консоли скрипт https://paste.yandex-team.ru/1393938, подменяющий изменённый состав товаров
      - do: |
          нажать кнопку «Оформить заказ»
          нажать кнопку «Отправить»
      - assert: |
          появился язычок с изменившейся информацией о товарах
          товар «labore ullamco Lorem enim cillum» закончился
          товар «nostrud enim consectetur elit» остался в 2 шт и стоит 1500 руб
      - tech: в запросе в ручку `/update` есть не пустой `sk`

    Внешний вид:
      - tags: no_assessors # необходимо выполнять скрипты в консоли
      - params:
          exp_flags:
            - turbo-app-cart-fresher=1
      - screenshot: внешний язычка [fresher]

    Переход на страницу изменившегося товара:
      - tags: no_assessors # необходимо выполнять скрипты в консоли
      - params:
          exp_flags:
            - turbo-app-cart-fresher=1
      - do: нажать по любому товару в язычке
      - assert: открылась страница выбранного товара
      - do: перейти в корзину
      - assert: состав корзины не был изменён

    Пересчёт корзины:
      - tags: no_assessors # необходимо выполнять скрипты в консоли
      - params:
          exp_flags:
            - turbo-app-cart-fresher=1
      - do: нажать на кнопку «Пересчитать корзину»
      - assert:
          язычок закрылся
          произошёл возврат на экран с товарами в корзине
          состав товаров, цены и количество изменились на актуальные
          появился тост с текстом «Корзина пересчитана»
          тост скрылся через 3 секунды
      - do: удалить из скрипта https://paste.yandex-team.ru/1393938 первый товар, а во втором изменить цену на 1000 руб
      - do: |
          нажать кнопку «Оформить заказ»
          нажать кнопку «Отправить»
      - assert: |
          появился язычок с изменившейся информацией о товарах
          товар «nostrud enim consectetur elit» закончился
          товар «labore irure officia excepteur velit non» стоит 1000 руб

  Происходит редирект к корзину при прямом заходе на страницу чекаута:
    - do: открыть страницу https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocart/?page_type=payment
    - assert: произошел редирект на корзину

  Рекомендации в корзине:
    - tags: no_assessors # используется патч
    - do: перейти по ссылке https://yandex.ru/turbo/spideradio.github.io/n/yandexturbocatalog/main/?morda=1&ecommerce_main_page_preview=1&_ym_debug=1
    - do: доскроллить до рекомендаций
    - assert: рекомендации есть на странице
    - do: доскролить так, чтобы первый товар в карусели был внутри viewport
    - assert: |
        проверить, что отправилась цель метрики в счетчик 53911873
        с названием "product-carousel-seen" и параметрами
        ecom_spa: 1,
        host: 'spideradio.github.io',
        metrikaIds: \['65243191'\],
        place: 'cartPage',
        recommendationType: 'personal',
        reqid: '1611135338710778-1076811384583772757300104-hamster-app-host-vla-web-yp-1',
        turbo_app_enabled: 1.
        reqid будет отличаться по значению, но по структуре должен совпадать.
    - assert: |
        проверить, что отправилась цель метрики в счетчик 53911873
        с названием "product-item-seen" и параметрами
        host: 'spideradio.github.io',
        metrikaIds: \['65243191'\],
        offerId: '127',
        originalUrl: 'https://spideradio.github.io/rnd/2lum7hf3',
        place: 'cartPage',
        productUrl: 'https://yandex.ru/turbo/spideradio.github.io/s/?pcgi=rnd%3Djy7b4qqsed',
        reqid: '1611135338710778-1076811384583772757300104-hamster-app-host-vla-web-yp-1',
        recommendationType: 'personal',
        turbo_app_enabled: 1.
        offerId, reqid и productUrl будут отличаться по значению, но по структуре должны совпадать.
    - do: нажать кнопку "В корзину"
    - assert: отправилась цель с теми же параметрами, что и "product-item-seen", но с названием "product-item-click-add-to-cart"
    - do: нажать на картинку товара
    - assert: отправилась цель с теми же параметрами, что и "product-item-seen", но с названием "product-item-click"

  Валюта минимального заказа из товара:
    - do: Открыть страницу https://yandex.ru/turbo/spideradio.github.io/s/rnd/do4t?product_id=72
    - do: Нажать кнопку "Добавить в корзину"
    - do: Дождаться изменения надписи на "Перейти в корзину"
    - do: Нажать кнопку "Перейти в корзину"
    - assert: В корзине 1 товар стоимостью "15 $"
    - assert: Товар нельзя приобрести "Минимальный заказ 400 $"

files:
  - screens/CartScreen/__tests__/CartScreen@phone.hermione.js

tags: ecom-tap

tlds: ru

v-team: Turbo
