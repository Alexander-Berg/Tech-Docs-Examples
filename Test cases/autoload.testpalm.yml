feature: autoload

specs:
  beforeEach:
    - do: при дальнейшей проверке указанных ожидаемых результатов обращайте внимание на любые некорректные на ваш взгляд поведения, основываясь на свой опыт использования web-приложений (например, сохранение позиции при переходах туда-обратно кнопками на устройстве, пустые экраны при переходах, кривая верстка, скачкИ элементов, плавность скролла, неработающая функциональность и т.п.)

  Работа со статусом сети:
    - do: открыть страницу https://yandex.ru/turbo?stub=page/scroll-deep.json
    - assert: открылась турбо страница
    - do: перевести устройство в режим offline
    - do: проскролить до конца страницы
    - assert: загрузки страницы не произошло
    - do: проскролить в начало страницы
    - do: перевести устройство в режим online
    - do: проскролить до конца страницы
    - assert: подгрузилась еще **одна** страница

  Лента рекомендаций на красивых урлах:
    - automation: TURBOUI-4209
    - do: открыть страницу https://yandex.ru/turbo/lenta.ru/s/news/2020/07/10/tr_w/
    - assert: открылась турбо страница статьи
    - do: пролистать до конца первой статьи
    - assert: под первой статьей загрузилась вторая статья
    - do: пролистать до конца второй статьи
    - assert: под второй статьей загрузилась третья статья

  Отправка parent-reqid:
    - tags: no_assessors
    - do: открыть страницу https://yandex.ru/turbo?text=https%3A%2F%2Fpikabu.ru%2Fstory%2Fochen_vazhnaya_informatsiya_na_pakete_s_kurinyimi_golovami_6802163
    # Поменять на `window.__GLOBAL_STATE__.store.global.reqid`
    # после завершения экспримента с https://st.yandex-team.ru/TURBOUI-4285
    - do: узнать reqid первой статьи, выполнив в консоле `JSON.parse(document.body.dataset.bem).page.reqid`
    - do: пролистать страницу до конца вниз и дождаться загрузки второй статьи
    - assert: parent-reqid запроса за второй статьей совпадает с reqid первой статьи
    - do: получить reqid второй статьи, узнав его из ответа AJAX-запроса за этой статьей
    - do: пролистать страницу до конца вниз и дождаться загрузки третьей статьи
    - assert: parent-reqid запроса за третьей статьей совпадает с reqid второй статьи

  Отправка счетчика загрузки страницы:
    - tags: no_assessors
    - do: открыть страницу 'https://yandex.ru/turbo?text=news-infinite-1'
    - assert: открылась турбо страница
    - do: пролистать страницу до конца вниз и дождаться загрузки второй статьи
    - tech: отправлен баобаб счетчик '$page' с событием 'tech', типом 'page-loaded' и параметром 'url' содержащим url загрузившейся страницы

  Баобаб:
    - tags: no_assessors
    - do: открыть страницу https://yandex.ru/turbo?text=news-infinite-1&exp_flags=analytics-disabled=0;validate_counters=1
    - do: проскроллить, чтобы появилась вторая статья
    - tech: должен отработать клиентский счетчик `event = tech, type = autoload` - отобразится в консоли
    - tech: проверить баобаб-дерево второй страницы (также в консоли) - событие - append, корневой узел в дереве - с именем $subpage, trigger-event-id - такой же как id события autoload
    - tech: должен отработать клиентский счетчик на показ второй страницы - `event = tech, type = show`

  Отключение в ecom-spa:
    - tags: no_assessors #spa раскатан на 100%, тут не будет никаких дозагрузок
    - do: открыть страницу https://yandex.ru/turbo?stub=page/rss-yml.json
    - do: проскроллить до конца страницы
    - assert: загрузилась вторая страница
    - do: открыть страницу https://yandex.ru/turbo?exp_flags=turbo-app-any-ua=1&stub=page/rss-yml.json
    - do: проскроллить до конца страницы
    - assert: не было никаких загрузок

  Работа при переключение вкладок:
    - tags: no_assessors
    - do: открыть страницу https://yandex.ru/turbo?exp_flags=adv-disabled%3D0&in-iframe=&check_swipe=1&stub=page%2Fpovarenok-infinite-1.json
    - do: отправить сообщение "показа", выполнив в консолу `window.postMessage('{"action":"overlay-slider-active"}', '*')`
    - do: открыть еще одну вкладку https://yandex.ru/turbo
    - do: вернуться на предыдущую вкладку
    - do: проскролить до кнца страницы
    - assert: загрузилась вторая страница

files:
  - features/common/blocks/autoload/autoload.hermione.js

v-team: Turbo

tlds: none
