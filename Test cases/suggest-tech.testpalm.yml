feature: Саджест
type: Счетчики

specs:
  Safeclick:
    Проверка safeclick счетчика в навигационках:
      - do: кликнуть в "х" поисковой стрелки
      - assert: поисковая стрелка очищена
      - assert: саджест открыт
      - do: введите в поисковую стрелку "одноклассники"
      - assert: в саджесте присутствует навигационная подсказка с ссылкой на ресурс "одноклассники"
      - do: клинуть в навигационную подсказку (имеет ссылку на m.ok.ru)
      - assert: в новой вкладке открылся сервис "Одноклассники"
      - tech: сработал redir-счетчик
      - assertMetrics: '*'
    Проверка корректности sc куки после перехода по навигационке:
      - do: получить выдачу по запросу "янд"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
      - assert: видна навигационная подсказка
      - do: кликнуть в навигационную подсказку
      - do: перейти на yandex.ru/watch
      - assert: сайт содержит корректные куки sc_* без undefined значений
      - assertMetrics: '*'
  Основные:
    beforeEach:
      - do: получить выдачу по запросу "тест"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
    Тип взаимодействия с саджестом и индекс выбранной подсказки при выборе полнотекстовой:
      - do: кликнуть в полнотекстовую
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.mouse\.p1\.nah_not_shown\.click_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с саджестом и индекс выбранной подсказки при выборе навигационки:
      - do: получить выдачу по запросу "вконтакте"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
      - do: кликнуть в навигационную подсказку
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.mouse\.p1\.nah_not_used\.click_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с саджестом и индекс при выделении подсказки и изменении ее текста:
      - do: нажать клавишу "вниз" дважды
      - assert: выбрана вторая подсказка в списке
      - do: дополнить текст запроса текстом "тест"
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.edit\.p0\.nah_not_shown\.button_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с саджестом и индекс при выделении подсказки и нажатии "Enter":
      - do: нажать клавишу "вниз"
      - assert: выбрана первая подсказка в списке
      - do: нажать на клавишу "Enter"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.keyboard\.p1\.nah_not_shown\.keyboard/
      - assertMetrics: '*'
    Тип взаимодействия с саджестом и индекс при выделении подсказки и нажатии "Найти":
      - do: нажать клавишу "вниз"
      - assert: выбрана первая подсказка в списке
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.suggest\.p1\.nah_not_shown\.button_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с саджестом, если саджест не отображался:
      - do: получить выдачу по запросу со специфичным текстом
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: саджест не появился
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.not_shown\.p0\.nah_not_shown\.button_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с саджестом, если саджест не использовался:
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.not_used\.p0\.nah_not_shown\.button_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с историей, если она не была использована:
      - do: сделать перезапрос с текстом "тест"
      - do: кликнуть в поле поиска
      - assert: появился саджест
      - assert: в саджесте присутствует историческая подсказка с текстом "тест"
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.not_used\.p0\.nah_not_used\.button_by_mouse/
      - assertMetrics: '*'
    Тип взаимодействия с историей, если она была использована:
      - do: сделать перезапрос с текстом "тест"
      - do: кликнуть в поле поиска
      - assert: появился саджест
      - assert: в саджесте присутствует историческая подсказка с текстом "тест"
      - do: кликнуть в историческую подсказку
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.mouse\.p1\.nah_used\.click_by_mouse/
      - assertMetrics: '*'
    Способ отправки запроса и индекс выбранной подсказки при использовании фактовой:
      - do: ввести запрос "вес слитка золота"
      - assert: в саджесте отображается фактовая подсказка
      - do: кликнуть в фактовую подсказку
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.mouse\.p2\.nah_not_shown\.click_by_mouse/
      - assertMetrics: '*'
    Способ отправки запроса при нажатии на кнопку "Найти":
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.not_used\.p0\.nah_not_shown\.button_by_mouse/
      - assertMetrics: '*'
    Способ отправки запроса при нажатии Enter на клавиатуре:
      - do: нажать на кнопку "Enter" на клавиатуре
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.not_used\.p0\.nah_not_shown\.keyboard/
      - assertMetrics: '*'
    Проверка вычисляемых полей счетчика:
      - do: удалить два символа запроса
      - do: добавить текст "ст ть"
      - do: кликнуть в первую пословную подсказку
      - do: кликнуть в первую полнотекстовую подсказку
      - tech: отправился счетчик саджеста
      - tech: поле sfc больше 0
      - tech: поле slc больше 0
      - tech: поле tit больше 0
      - tech: поле tit больше sfc
      - tech: поле sfc больше slc
      - tech: поле clks равно 1
      - tech: поле times содержит 9 значений, разделенных "."
      - tech: все значения в поле times не отрицательные
      - tech: поле render_times содержит 9 значений, разделенных "."
      - tech: все значения в поле render_times не отрицательные
      - tech: поле pos равно 27
      - tech: поле ratio содержит 3 значений, разделенных "."
      - tech: поле ratio равно 7.27.10
      - assertMetrics: '*'
    Содержит верное количество запросов/ответов/рендеров:
      - do: добавить текст " лал"
      - do: удалить три символа запроса
      - do: добавить текст "лал1"
      - do: кликнуть в кнопку "Найти"
      - tech: отправился счетчик саджеста
      - tech: поле cchd равно 2
      - tech: поле rqs равно 3
      - tech: поле rsp равно 3
      - tech: поле ersp равно 2
      - tech: поле rndr равно 1
      - assertMetrics: '*'
    При первоначальной очистке инпута логируется один раз clear:
      - do: получить выдачу по запросу "тест"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в крестик очистки инпута
      - do: |
          ввести 'а'
          кликнуть в кнопку "Найти"
      - tech: отправился счетчик саджеста, \
              поле tpah_log начинается с '[[clear'
      - assertMetrics: '*'
    Содержит suggest_reqid в запросах к ручке саджеста, счетчиках и перезапросе:
      - do: получить выдачу по запросу "тест"
      - do: добавить текст в поле ввода
      - do: нажать на кнопку "Найти"
      - tech: отправился счетчик саджеста
      - tech: в запросе за подсказками, \
              в счетчике саджеста и в перезапросе за новой выдачей содержится параметр suggest_reqid \
              c одинаковым значением
    Содержит space_created=1 при использовании стрелки:
      - do: кликнуть в первую пословную подсказку
      - tech: за подсказками ушел запрос с параметром space_created=1
      - do: ввести символ "к"
      - tech: за подсказками ушел запрос без параметра space_created
      - do: кликнуть в первую пословную подсказку
      - tech: за подсказками ушел запрос с параметром space_created=1
      - do: кликнуть в крестик поисковой стрелки
      - tech: за подсказками ушел запрос без параметра space_created
    Клик в стрелку подстановки и поиск:
      - do: получить выдачу по запросу "тест"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
      - do: кликнуть в стрелку в правой части последней полнотекстовой подсказки
      - assert: текст подсказки подставлен в поисковую строку, новый запрос не отправился
      - do: нажать на кнопку "Найти"
      - assert: выдача обновилась, получена выдача по указанному запросу
      - tech: |
          отправился запрос с маской "cid=2873"
          запрос содержит подстроку "mouse.p10."
          запрос содержит подстроку "[arrow,p10"
    Символ * экранирован в значениях параметров:
      - do: нажать в крестик очистки инпута
      - assert: поисковая стрелка очищена
      - do: набрать запрос п*г*да
      - do: нажать клавишу "Enter"
      - assert: получена выдача по указанному запросу
      - tech: отправился счетчик саджеста, символ'*' в параметрах заменен на '%2A'
    Содержит количество различных подсказок:
      - do: нажать в крестик очистки инпута
      - assert: поисковая стрелка очищена
      - do: набрать запрос "лала"
      - assert: появилась навигационная богатая подсказка "Ла-ла Лэнд"
      - do: нажать в крестик очистки инпута
      - assert: поисковая стрелка очищена
      - do: набрать запрос "число пи"
      - assert: появилась фактовая подсказка
      - do: нажать клавишу "Enter"
      - assert: получена выдача по указанному запросу
      - tech: отправился счетчик саджеста, содержащий информацию о количестве отображенных подсказок
    Содержит meta поля из ответа:
      - do: кликнуть в кнопку "Найти"
      - assert: получена выдача по указанному запросу
      - tech: отправился счетчик саджеста, содержащий meta поля из ответа (могут быть log, region, exprt)
    Заполнение поля text при нажатии Enter на навигационной подсказке:
      - do: получить выдачу по запросу "вкон"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест с навигационной подсказкой
      - do: |
          выбрать клавиатурной стрелкой "Вниз" навигационную подсказку
          нажать "Enter" на клавиатуре
      - tech: отправился счетчик саджеста, \
          поле text соответствует значению из атрибута "data-text" элемента подсказки
      - assertMetrics: '*'
    Заполнение поля text при клике на навигационную подсказку:
      - do: получить выдачу по запросу "вкон"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест с навигационной подсказкой
      - do: кликнуть в навигационную подсказку
      - tech: отправился счетчик саджеста, \
          поле text соответствует значению из атрибута "data-text" элемента подсказки
      - assertMetrics: '*'
    Поле prev_query:
      - do: получить выдачу по запросу "тест"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
      - do: кликнуть в любую подсказку
      - tech: отправился счетчик саджеста, \
          поле prev_query равно "%D1%82%D0%B5%D1%81%D1%82"
      - assertMetrics: '*'
  Эксперименты с правками в счетчике:
    Индекс выбранной подсказки не меняется при ховере:
      - params:
          exp_flags:
            - suggest_counter-exp=1
      - do: получить выдачу по запросу "тест"
      - assert: получена выдача по указанному запросу
      - do: кликнуть в поисковую строку
      - assert: появился саджест
      - do: навести указатель мыши на первую подсказку
      - assert: подсказка выделена цветом
      - do: нажать Enter
      - assert: получена выдача по указанному запросу
      - tech: отправился счетчик саджеста, \
              поле path соответствует регулярному выражению /serp_ru_desktop\.not_used\.p0\.nah_not_shown\.keyboard/


specs-integration:
  Safeclick:
    Проверка safeclick счетчика в навигационках:
      - do: кликнуть в "х" поисковой стрелки
      - assert: поисковая стрелка очищена
      - assert: саджест открыт
      - do: введите в поисковую стрелку "одноклассники"
      - assert: в саджесте присутствует навигационная подсказка с ссылкой на ресурс "одноклассники"
      - do: клинуть в навигационную подсказку (имеет ссылку на m.ok.ru)
      - assert: в новой вкладке открылся сервис "Одноклассники"

files:
  - features/desktop/suggest/suggest-tech.hermione.js
  - features/desktop/suggest/suggest-tech.hermione.e2e.js

qa-engineer:
  - e-rea

tags:
  - suggest
  - input
  - reviewed
  - no_assessors
  - skip_e2e_check

browsers:
  notFor:
    - searchapp-phone-group

v-team: Suggest

priority: high

tlds: [ru, by, ua, kz, uz]
