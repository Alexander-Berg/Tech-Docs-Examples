feature: Связанные запросы

specs:
  Базовые проверки:
    beforeEach:
      - do: получить выдачу по запросу 'госуслуги'
      - assert: появился блок связанных запросов внизу страницы

    Проверка внешного вида:
      - tags:
        - no_assessors
      - params:
          foreverdata: '194245807'
      - do: получить выдачу по запросу 'foreverdata'
      - screenshot: пример внешнего вида связанных запросов [plain]

    Проверка доступности:
      - tags:
        - no_assessors
      - tech: |
          блок связанных запросов имеет role 'navigation'
          блок связанных запросов описан (aria-labelledby) элементом __header внутри
          значение атрибута target равно '_self'
          текст первой ссылки соответствует запросу, на который она перенаправляет
      - do: нажать на первую ссылку
      - tech: |
          url текущей страницы поменялся на href ссылки
          path счетчика первой ссылки равен '/$page/$main/related/link'
      - assert: выдача перезагрузилась
      - assertMetrics: '*'

  Проверка блока связанных запросов на второй странице:
    - tags:
        - smoke_extended
    - params:
        p: '2'
    - do: получить выдачу по запросу 'госуслуги'
    - assert: появился блок связанных запросов внизу страницы
    - do: нажать на 'Показать еще' в конце страницы
    - assert: появилась вторая страница выдачи
    - do: проскролить до блока связанных запросов внизу страницы
    - assert: блок связанных запросов идентичен блоку на предыдущей странице [two-page__plain]
    - assertMetrics: '*'

  Пустой блок связанных запросов:
    - do: получить выдачу по запросу 'Fhrhrhrhrhfjtjrhbthdbfnfbdnfndbfndbf'
    - assert: внизу страницы отсутствует блок связанных запросов
    - assertMetrics: '*'

  Проверка экранирования html:
    - tags:
      - no_assessors
    - do: получить выдачу по запросу '<html>'
    - assert: появился блок связанных запросов внизу страницы
    - screenshot: связанные запросы [plain]
    - assertMetrics: '-'

  Над выдачей:
    - tags:
        - smoke_extended
    - do: |
        получить выдачу Поиска по запросу 'госуслуги личный кабинет' (альтернативные запросы 'налоговая личный кабинет для физических', 'госдума проекты на рассмотрении')
        cкролл вниз до конца выдачи
        cкролл обратно на самый верх
    - assert: появились переформулировки над выдачей
    - screenshot: переформулировки над выдачей [related-above]
    - do: кликнуть на первую переформулировку
    - assert: открылась выдача по запросу из переформулировки
    - assertMetrics: '-'

  Над выдачей - в горизонтальной ориентации:
    - do: |
        получить выдачу Поиска по запросу 'госуслуги личный кабинет' (альтернативные запросы 'налоговая личный кабинет для физических', 'госдума проекты на рассмотрении')
        повернуть экран в горизонтальную ориентацию
        cкролл вниз до конца выдачи
        cкролл обратно на самый верх
    - assert: появились переформулировки над выдачей
    - screenshot: переформулировки над выдачей [related-above]
    - do: кликнуть на первую переформулировку
    - assert: открылась выдача по запросу из переформулировки
    - assertMetrics: '-'

  Над выдачей с залипающией рекламой:
    - tags:
      - no_assessors
    - params:
        foreverdata: '2058618529'
    - do: |
        получить выдачу по запросу "foreverdata"
        проскроллить выдачу вниз
    - assert: появился залипающий сниппет
    - screenshot: внешний вид [related-above-sticky-adv]
    - do: проскроллить выдачу вверх до шапки
    - assert: появились переформулировки над выдачей
    - screenshot: внешний вид [related-above]
    - do: проскроллить выдачу вниз
    - assert: появился залипающий сниппет
    - screenshot: внешний вид [related-above-sticky-adv-2]

  Над выдачей появляются, если загрузили страницу кнопкой "Показать ещё":
      - params:
          exp_flags: related-above-enable-for-testing=1
      - do: |
          получить выдачу Поиска по запросу 'чемпионат россии по футболу'
          cкролл в самый низ
          нажать на кнопку "Показать ещё" и дождаться загрузки второй страницы
          скролл наверх
      - assert: появились переформулировки над выдачей

  Счетчик реального показа:
    - tags:
      - no_assessors
    - do: получить выдачу по запросу 'как открыть вино' и прокрутить ее до конца
    - assert: внизу присутствует блок связанных запросов
    - tech: отправлен счетчик 'tech:related-bottom-show'

  Счетчик реального показа не срабатывает при выключенных рекомендациях:
    - tags:
      - no_assessors
    - exp_flags:
        - disable-recommendations=related
    - do: получить выдачу по запросу 'как открыть вино' и прокрутить ее до конца
    - assert: внизу отсутствует блок связанных запросов
    - tech: счетчик 'tech:related-bottom-show' не отправлялся

specs-integration:
  Блок связанных запросов не пустой:
    - do: открыть выдачу с запросом 'госуслуги личный кабинет' (альтернативные запросы 'налоговая личный кабинет для физических', 'госдума проекты на рассмотрении')
    - assert: появился блок связанных запросов внизу страницы
    - counter: /$page/$main/related

  Переформулировки по возврату:
    - do: |
          получить выдачу по запросу 'госуслуги личный кабинет' (альтернативные запросы 'налоговая личный кабинет для физических', 'госдума проекты на рассмотрении')
          нажать на первый органик сниппет
          вернуться обратно на выдачу
    - assert: появились переформулировки под этим сниппетом

  Переформулировки над выдачей:
    - do: открыть выдачу с запросом 'госуслуги личный кабинет' (альтернативные запросы 'налоговая личный кабинет для физических', 'госдума проекты на рассмотрении')
    - do: cкролл вниз до конца выдачи
    - do: cкролл обратно на самый верх
    - assert: появились переформулировки над выдачей
    - screenshot: примерный вид такой [https://jing.yandex-team.ru/files/etestova/STF_2021-02-02_10-09-08.png]
    - counter: /$page/$main/related/shiny_discovery_above/scroller

files:
  - features/touch-phone/related/related.hermione.js
  - features/touch-phone/related/related.hermione.e2e.js

v-team: UniAnswer

tags:
  - reviewed
  - uni_answer

counter: /$page/$main/related

tlds: [ru, by, ua, kz, uz, com.tr, com]

priority: high
