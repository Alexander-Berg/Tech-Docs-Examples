feature: Overlay
tlds: ru
tags: no_assessors

specs:
  aliases:
    - &CheckOverlayOpenedAgain
      - assert: оверлей закрылся, видна начальная страница, урл изменился на /overlay?urls=/turbo?text=about
      - do: сделать шаг назад браузерной кнопкой
      - assert: открылся оверлей
      - screenshot: внешний вид соответствует скриншоту [plain_2]
      - assert: урл страницы изменился на /turbo?text=about&displayUrl=1
    - &AssertOverlayOpened
      - do: открыть локально страницу /overlay?urls=/turbo?text=about
      - do: кликнуть по первой ссылке
      - assert: открылся оверлей
      - screenshot: внешний вид соответствует скриншоту [plain_1]
      - assert: урл страницы изменился на /turbo?text=about&displayUrl=1


  Открытие и закрытие оверлея:
    - *AssertOverlayOpened
    - do: сделать шаг назад браузерной кнопкой
    - *CheckOverlayOpenedAgain

  Открытие и закрытие оверлея с хуком, заменяющим историю:
    - do: открыть локально страницу /overlay?urls=/turbo?text=about
    - do: выполнить в консоли команду
          window.Ya.turboOverlay.onOverlayContentShown = function(params) {
          return { displayUrl:params.displayUrl + '&updated-display=1', title:'1234' + params.title };
          };
          window.Ya.turboOverlay.onOverlayOpen = function() { console.log('overlay opened'); }
          window.Ya.turboOverlay.onOverlayClose = function() { console.log('overlay closed'); }
    - do: кликнуть по ссылке
    - assert: >
        урл страницы сменился на /turbo?text=about&updated-display=1,
        тайтл сменился на 1234Турбо-страницы для владельцев сайтов,
        в консоли вывелось сообщение 'overlay opened'
    - do: кликнуть по кнопке назад
    - assert: в консоли вывелось сообщение 'overlay closed'

  Кнопка назад возвращает назад:
    - *AssertOverlayOpened
    - do: кликнуть по кнопке назад в шапке оверлея
    - *CheckOverlayOpenedAgain

  Замена урла при переходе по ссылкам работает корректно:
    - do: открыть локально старницу /overlay?urls=/turbo?text=bin:selection-filter-reload
    - do: кликнуть по ссылке
    - assert: >
        открылся оверлей,
        загрузилась страница,
        урл сменился на /turbo?text=bin:selection-filter-reload,
        тайтл сменился на Турбо-Страница
    - do: нажать 'все каналы' и выбрать 'первый'
    - assert: >
       страница перезагрузилась, но шапка не пропала,
       тайтл изменился на Private school,
       урл сменился на /turbo?text=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FPrivate_school
    - do: сделать шаг назад
    - assert: вернулись к первой странице

  Должен фолбэчить на оригинал:
    - do: открыть локально страницу /overlay?urls=/turbo?text=nodata
    - do: кликнуть по ссылке
    - assert: страница перезагрузилась на https://hamster.yandex.ru/turbo

  Должен фолбэчить по таймауту на некорректном домене:
    - do: открыть локально страницу /overlay?urls=https://hamster.yandex.ru/turbo?text=test_news
    - do: кликнуть по ссылке
    - assert: страница перезагрузилась на https://hamster.yandex.ru/turbo

  Хук на фолбэк работает корректно:
    - do: открыть локально страницу /overlay?urls=/turbo?text=nodata
    - do: выполнить в консоли команду
          window.Ya.turboOverlay.onOverlayFallback = function(params) {
          window.__fallback_hook_params__ = params;
          return { preventDefault:true };
          };
    - do: кликнуть по ссылке
    - assert: >
        урл страницы сменился на /turbo?text=nodata
        в течение 10 секунд ничего не происходит
    - do: выполнить в консоли команду
          var params = window.__fallback_hook_params__;
          params.callback(params.originalUrl + '?text=about');
    - assert: произошел редирект на страницу https://hamster.yandex.ru/turbo?text=about

  Должен менять url при скролле бесконечной ленты:
    - do: открыть локально страницу /overlay?urls=/turbo?text=news-infinite-1
    - do: кликнуть по ссылке
    - assert: загрузилась первая новость
    - do: проверить урл в адресной строке
    - assert: в адресной строке url https://yandex.ru/turbo?text=news-infinite-1
    - do: скроллить страницу вниз до конца
    - assert: подгрузилась вторая новость
    - do: скроллить страницу вниз, пока вторая новость не будет занимать 20% от viewport
    - do: проверить урл в адресной строке
    - assert: в адресной строке url https://yandex.ru/turbo?text=news-infinite-2
    - do: проскроллить вторую статью до конца
    - do: скроллить страницу вверх до начала первой статьи
    - assert: в адресной строке url https://yandex.ru/turbo?text=news-infinite-1

  Показывает и скрывает крестик:
    - do: открыть локально страницу /overlay?urls=/turbo?text=about
    - do: кликнуть по первой ссылке
    - screenshot: внешний вид [without_cross]
    - do: выполнить в консоле команду `window.Ya.turboOverlay.showCloseButton();`
    - screenshot: показался крестик [with_cross]
    - do: выполнить в консоле команду `window.Ya.turboOverlay.hideCloseButton();`
    - screenshot: крестик скрылся [with_cross_hidden]

  Закрывает несколько страниц по клику на крестик:
    - do: открыть локально страницу /overlay?urls=/turbo?stub=link/internal.json
    - do: выполнить в консоле команду `window.Ya.turboOverlay.showCloseButton();`
    - do: кликнуть по первой ссылке
    - screenshot: внешний вид соответствует скриншоту [with_cross]
    - do: кликнуть по lorem ipsum
    - assert: страница изменилась на википедийную турбо-статью, урл изменился на /turbo?text=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FPrivate_school
    - do: кликнуть поо крестику
    - assert: вернулись к изначальной странице
    - do: браузерной кнопке перейти назад
    - assert: перешли к первой турбо-странице

  Ссылки турбо-в-турбо должны работать корректно:
    - do: открыть локально страницу /overlay?urls=/turbo?stub=link/react-internal.json
    - do: кликнуть по первой ссылке
    - assert: >
        открылся оверлей,
        загрузилась страница,
        урл сменился на /turbo?stub=link/react-internal.json,
        тайтл сменился на Пример блока Link
    - do: кликнуть по ссылке Lorem Ipsum
    - assert: >
        загрузилась страница,
        урл сменился на /turbo?text=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FPrivate_school,
        тайтл сменился на Пример блока Private school

  Должен фолбэчить на турбо-в-турбо:
    - do: открыть локально страницу /overlay?urls=/turbo?text=bin:broken-navigate3
    - do: кликнуть по первой ссылке
    - assert: >
        открылся оверлей,
        загрузилась страница
    - do: кликнуть по второй ссылке
    - assert: страница перезагрузилась на some-url.ru

  Открывает страницы в новом iframe по обычной ссылке под флагом на новостях:
    - params:
        exp_flags:
            - touch_alternate_sidebar=1
    - do: открыть локально страницу /overlay?urls=/turbo?stub=link%2Fnews-turbo-or-not-turbo.json
    - do: кликнуть по первой ссылке
    - assert: >
        открылся оверлей,
        загрузилась страница
    - do: кликнуть по пятой ссылке
    - assert: показался спиннер, загрузилась страница с описанием турбо-страниц, урл изменился на /turbo?text=about
    - tech: >
        на странице присутствует
        два элемента с классом '.turbo-overlay__body',
        два элемента с классом '.turbo-overlay__iframe',
        один элемент с классом '.turbo-overlay__body-visible'
        урл внутри iframe содержит cgi-параметры text=about, new_overlay=1 и depth=1
    - do: перейти назад браузерной навигацией
    - assert: урл сменился на /turbo?stub=link%2Fnews-turbo-or-not-turbo.json, показалась предыдущая страница без спиннера
    - tech: >
        на странице присутствует
        один элемент с классом '.turbo-overlay__body',
        один элемент с классом '.turbo-overlay__iframe',
        один элемент с классом '.turbo-overlay__body-visible'
        урл внутри iframe содержит cgi-параметры stub=link%2Fnews-turbo-or-not-turbo.json, new_overlay=1 и depth=0

  Открывает страницы в новом iframe по реактовой ссылке под флагом на новостях:
    - params:
        exp_flags:
            - touch_alternate_sidebar=1
    - do: открыть локально страницу /overlay?urls=/turbo?stub=link%2Fnews-turbo-or-not-turbo.json
    - do: кликнуть по первой ссылке
    - assert: >
        открылся оверлей,
        загрузилась страница
    - do: кликнуть по шестой ссылке
    - assert: показался спиннер, загрузилась страница с описанием турбо-страниц, урл изменился на /turbo?text=about
    - tech: >
        на странице присутствует
        два элемента с классом '.turbo-overlay__body',
        два элемента с классом '.turbo-overlay__iframe',
        один элемент с классом '.turbo-overlay__body-visible'
        урл внутри iframe содержит cgi-параметры text=about, new_overlay=1 и depth=1
    - do: перейти назад браузерной навигацией
    - assert: урл сменился на /turbo?stub=link%2Fnews-turbo-or-not-turbo.json, показалась предыдущая страница без спиннера
    - tech: >
        на странице присутствует
        один элемент с классом '.turbo-overlay__body',
        один элемент с классом '.turbo-overlay__iframe',
        один элемент с классом '.turbo-overlay__body-visible'
        урл внутри iframe содержит cgi-параметры stub=link%2Fnews-turbo-or-not-turbo.json, new_overlay=1 и depth=0

  Открывает страницы в том же iframe по обычной ссылке без флага на новостях:
    - do: открыть локально страницу /overlay?urls=/turbo?stub=link%2Fnews-turbo-or-not-turbo.json
    - do: кликнуть по первой ссылке
    - assert: >
        открылся оверлей,
        загрузилась страница
    - do: кликнуть по пятой ссылке
    - assert: показался спиннер, загрузилась страница с описанием турбо-страниц, урл изменился на /turbo?text=about
    - tech: >
        на странице присутствует
        один элемент с классом '.turbo-overlay__body',
        один элемент с классом '.turbo-overlay__iframe',
        один элемент с классом '.turbo-overlay__body-visible'
        урл внутри iframe содержит cgi-параметры text=about, new_overlay=1 и depth=1
    - do: перейти назад браузерной навигацией
    - assert: урл сменился на /turbo?stub=link%2Fnews-turbo-or-not-turbo.json, показался спиннер и затем показалась предыдущая страница
    - tech: >
        на странице присутствует
        один элемент с классом '.turbo-overlay__body',
        один элемент с классом '.turbo-overlay__iframe',
        один элемент с классом '.turbo-overlay__body-visible'
        урл внутри iframe содержит cgi-параметры stub=link%2Fnews-turbo-or-not-turbo.json, new_overlay=1 и depth=0

  Открывает страницы в том же iframe по реактовой ссылке без флага на новостях:
    - do: открыть локально страницу /overlay?urls=/turbo?stub=link%2Fnews-turbo-or-not-turbo.json
    - do: кликнуть по первой ссылке
    - assert: >
        открылся оверлей,
        загрузилась страница
    - do: кликнуть по шестой ссылке
    - assert: показался спиннер, загрузилась страница с описанием турбо-страниц, урл изменился на /turbo?text=about
    - tech: >
        на странице присутствует
        один элемент с классом '.turbo-overlay__body',
        один элемент с классом '.turbo-overlay__iframe',
        один элемент с классом '.turbo-overlay__body-visible'
        урл внутри iframe содержит cgi-параметры text=about, new_overlay=1 и depth=1
    - do: перейти назад браузерной навигацией
    - assert: урл сменился на /turbo?stub=link%2Fnews-turbo-or-not-turbo.json, показался спиннер и затем показалась предыдущая страница
    - tech: >
        на странице присутствует
        один элемент с классом '.turbo-overlay__body',
        один элемент с классом '.turbo-overlay__iframe',
        один элемент с классом '.turbo-overlay__body-visible'
        урл внутри iframe содержит cgi-параметры stub=link%2Fnews-turbo-or-not-turbo.json, new_overlay=1 и depth=0

  Тайтл страницы:
    - do: открыть локально страницу /overlay?urls=/turbo?stub=link%2Fnews-turbo-or-not-turbo.json и кликнуть по второй ссылке
    - screenshot: открылся оверлей [with-title]

  Multipage режим:
    - do: |
          открыть локально страницу /overlay?urls=/turbo?stub=link%2Fnews-turbo-or-not-turbo.json,/turbo?stub=link%2Fdefault.json,/turbo?stub=link%2Ftel.json
          кликнуть по седьмой ссылке
    - screenshot: открылся оверлей [multipage]

  Multipage режим с тайтлом:
    - do: |
          открыть локально страницу /overlay?urls=/turbo?stub=link%2Fnews-turbo-or-not-turbo.json,/turbo?stub=link%2Fdefault.json,/turbo?stub=link%2Ftel.json
          кликнуть по восьмой ссылке
    - screenshot: открылся оверлей [multipage-with-title]

  Перелистывание страниц в multipage-режиме:
    - do: |
          открыть локально страницу /overlay?urls=/turbo?stub=link%2Fnews-turbo-or-not-turbo.json,/turbo?stub=link%2Fdefault.json,/turbo?stub=link%2Ftel.json
          кликнуть по седьмой ссылке
          свайпнуть справа налево по странице
    - screenshot: страница сменилась [multipage-swipe-right]
    - do: свайпнуть слева направо по странице
    - screenshot: страница сменилась [multipage-swipe-left]

  Оверлей со скрытой шапкой выглядит корректно при открытии просмотрщика:
    - do: |
          открыть локально страницу /overlay?urls=/turbo?stub=page/images.json
          кликнуть по первой ссылке
          долистать до маленькой картинки с зелёной галочкой и открыть её
    - screenshot: картинка открылась на полный экран [header-hidden]

  Drawer:
    Открытие и закрытие оверлея:
      - do: открыть локально страницу /overlay?urls=/turbo?stub=page/images.json&view-type=drawer
      - do: кликнуть по первой ссылке
      - assert: открылся оверлей
      - screenshot: внешний вид соответствует скриншоту [plain_1]
      - assert: урл страницы изменился на /turbo?text=about&displayUrl=1
      - do: сделать шаг назад браузерной кнопкой
      - assert: оверлей закрылся, видна начальная страница, урл изменился на /overlay?urls=/turbo?text=about
      - do: сделать шаг назад браузерной кнопкой
      - assert: открылся оверлей
      - screenshot: внешний вид соответствует скриншоту [plain_2]
      - assert: урл страницы изменился на /turbo?text=about&displayUrl=1
    Закрывается по post-message "close":
      - do: открыть локально страницу /overlay?urls=/turbo?stub=page/images.json&view-type=drawer
      - do: кликнуть по первой ссылке
      - assert: открылся оверлей
      - do: в консоли из iframe вызвать `window.top.postMessage('{ "action":"close"}, '*')`;
      - assert: оверлей закрылся
    Оверлей пробрасывает cgi-параметр в iframe:
      - do: открыть локально страницу /overlay?urls=/turbo?stub=page/images.json&view-type=drawer
      - do: кликнуть по первой ссылке
      - assert: открылся оверлей
      - assert: в атрибуте src у iframe есть cgi-параметр overlay-drawer=1

files:
- platform/overlay/__tests__/overlay.hermione.js

v-team: Turbo

manager: tanzwuta

qa-engineer: dakhetov, olga0321
