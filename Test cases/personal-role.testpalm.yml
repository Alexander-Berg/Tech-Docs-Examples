feature: Добавление и удаление сотрудника

specs:
  beforeEach:
    - do: (PREPARE) запустить в Runner сценарий "api/v4/services/members/ POST + DELETE" (https://github.yandex-team.ru/pixel/abc-runner)
    - do: (PREPARE) проверить, что robot-cat-leopold является руководителем в сервисе с id=3887 (/services/postman_add_roles/)
    - do: (PREPARE) проверить, что в сервисе с id=3887 выдано только две роли - руководителя для robot-cat-leopold и робота для robot-internal-002 (/services/postman_add_roles/)  
 
  Добавление и удаление бессрочной роли в сервис:
    - do: отправить запрос "Добавление бессрочной роли в сервис" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Нельзя запросить запрошенную роль" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "409"
    - screenshot: ответ на запрос должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2010-18-10.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запрос id бессрочной роли" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Запрос id бессрочной роли" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2010-19-04.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление роли из сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Добавление и удаление роли на срок:
    - do: отправить запрос "Добавление роли на срок в сервис" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запрос id роли на срок" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Запрос id роли на срок" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2010-24-41.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление роли на срок из сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Добавление роли участником сервиса, который не является руководителем:
    - do: отправить запрос "Добавление запроса бессрочной роли в сервис участником сервиса" с токеном "robot-internal-002"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Нельзя запросить запрошенную роль" с токеном "robot-internal-002"
    - assert: пришёл ответ со статусом "409"
    - screenshot: ответ на запрос должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-15%2019-26-09.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "[IDM] забираем id запроса от участника сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "[IDM] забираем id запроса от участника сервиса" должен содержать id (при каждом запросе он меняется) [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-16%2010-29-54.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Апрув запроса от участника сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запрос id заапрувленной роли" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Запрос id заапрувленной роли" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2010-29-49.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление заапрувленной роли из сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Добавление роли не-участником сервиса, но с базовыми правами с последующим отклонением запроса:
    - do: отправить запрос "Добавление запроса бессрочной роли в сервис не участником сервиса" с токеном "robot-internal-003"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "[IDM] забираем id запроса от не участника сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "[IDM] забираем id запроса от не участника сервиса" должен содержать id (при каждом запросе он меняется) [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-16%2010-28-33.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление запроса от не участника сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"  

  Добавление и удаление роли до даты руководителем сервиса:
    - do: отправить запрос "Добавление роли до даты в сервис" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "201" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запрос id роли до даты" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "Запрос id роли до даты" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2010-33-49.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Удаление роли до даты из сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "204" и без тела
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Пользователь с ограниченной ролью не может запросить роль:
    - do: отправить запрос "Добавление бессрочной роли в сервис Ограниченная роль" с токеном "robot-cat-matroskin"
    - assert: пришёл ответ со статусом "403" и телом "Your permissions are not enough"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"    

  Пользователь с сильно ограниченной ролью не может запрость роль:
    - do: отправить запрос "Добавление бессрочной роли в сервис Сильно ограниченная роль" с токеном "robot-cat-bayun"
    - assert: пришёл ответ со статусом "403" и телом "Your permissions are not enough"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"  

  Пользователь с ограниченной ролью не может удалять участников:
    - do: отправить запрос "Удаление роли из сервиса (ограниченная роль)" с токеном "robot-cat-matroskin"
    - assert: пришёл ответ со статусом "403" и телом "Your permissions are not enough"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"    

  Пользователь с сильно ограниченной ролью не может удалять участников:
    - do: отправить запрос "Удаление роли из сервиса (сильно ограниченная роль)" с токеном "robot-cat-bayun"
    - assert: пришёл ответ со статусом "403" и телом "Your permissions are not enough"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PAS

  Пользователь без роли в АВС не может удалять участников:
    - do: отправить запрос "Удаление роли из сервиса (без роли)" с токеном "arnold"
    - assert: пришёл ответ со статусом "403" и телом "Your permissions are not enough"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"  

  Валидация параметров запросов: 
    - do: отправить запрос "Запрос с двумя параметрами даты" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "400"
    - screenshot: ответ на запрос "Запрос с двумя параметрами даты" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2010-23-48.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS" 


priority: blocker

files:
  - tests/unit/services/api/test_members.py

tags:
  - reviewed
  - no_assessors
  - postman_automation
  - fitcher:abc:src/blocks/desktop/service-team-editor/**
  - fitcher:abc:src/blocks/desktop/service-team-department/**
  - fitcher:abc:src/blocks/desktop/service-team-editor-department/**
  - fitcher:abc:src/blocks/desktop/service-team-editor-member/**
  - fitcher:abc:src/blocks/desktop/service-team-member/**
  - fitcher:plan:tests/unit/services/api/test_members.py

