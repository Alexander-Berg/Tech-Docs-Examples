feature: Синхронизация

specs:
  Запуск синхронизации узлов и сверки для активной системы:
    - do: проверить, что "Тестовая система" находится в статусе "Активна" (/system/testsystem/sync)
    - do: запустить в Runner сценарий "Система. Синхронизация" (https://github.yandex-team.ru/pixel/idm-runner)
    - do: отправить запрос "Запуск синхронизации узлов" с токеном "robot-cat-leopold" и запомнить время отправки (раннер записывает его в переменную окружения role_sync_started)
    - assert: пришёл ответ со статусом "200" и телом "{}"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запуск сверки" с токеном "robot-cat-leopold" и запомнить время отправки (раннер записывает его в переменную окружения check_started)
    - assert: пришёл ответ со статусом "200" и телом "{}"
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Проверить, что запущено обновление дерева ролей" с токеном "robot-cat-leopold"
    - assert: |
        пришёл ответ со статусом "200"
        в блоке, где "action" имеет значение "role_tree_started_sync", дата из поля "added" должна быть больше или равна, чем то значение, которое записывали в переменную "check_started"
    - screenshot: запрос "Проверить, что запущено обновление дерева ролей" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-11%2012-23-08.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Проверить, что запущено сравнение ролей с системой" с токеном "robot-cat-leopold"
    - assert: |
        пришёл ответ со статусом "200"
        в блоке, где "action" имеет значение "started_comparison_with_system", дата из поля "added" должна быть больше или равна, чем то значение, которое записывали в переменную "role_sync_started"
    - screenshot: запрос "Проверить, что запущено сравнение ролей с системой" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-11%2012-23-46.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Запуск синхронизации узлов и сверки невозможен для сломанной/выключенной системы:
    - do: проверить, что система "Altay" находится в статусе "Неактивна" (/system/altay/sync)
    - do: запустить в Runner сценарий "Система. Синхронизация" (https://github.yandex-team.ru/pixel/idm-runner)
    - do: отправить запрос "Синхронизация узлов для сломанной системы недоступна" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "403"
    - screenshot: запрос "Синхронизация узлов для сломанной системы недоступна" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-11%2010-26-32.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Запуск сверки для сломанной/выключенной системы невозможен" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "403"
    - screenshot: запрос "Запуск сверки для сломанной/выключенной системы невозможен" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-11%2012-07-15.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Запуск просмотра изменений узлов:
    - do: проверить, что система "system_aware_of_memberships_with_logins" находится в статусе "Активна" (/system/system_aware_of_memberships_with_logins/sync)
    - do: запустить в Runner сценарий "Система. Синхронизация" (https://github.yandex-team.ru/pixel/idm-runner)
    - do: отправить запрос "Сохраненные и свежеполученные узлы дерева ролей системы совпадают." с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: запрос "Сохраненные и свежеполученные узлы дерева ролей системы совпадают." должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-11%2012-05-52.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

priority: blocker

files:
  - idm/tests/api/frontend/test_system.py

tags:
  - reviewed
  - no_assessors
  - postman_automation
  - fitcher:idm-www:blocks/desktop/sync/**
  - fitcher:idm-www:test/auto/system/sync/**
  - fitcher:idm_backend_palmsync:idm/tests/api/frontend/test_system.py
  - fitcher:idm_backend_palmsync:idm/core/constants/groupmembership.py
  - fitcher:idm_backend_palmsync:idm/core/constants/role.py
  - fitcher:idm_backend_palmsync:idm/core/constants/rolefield.py
  - fitcher:idm_backend_palmsync:idm/core/constants/system.py
  - fitcher:idm_backend_palmsync:idm/core/models/favorite_system.py
  - fitcher:idm_backend_palmsync:idm/core/models/rolenode.py
  - fitcher:idm_backend_palmsync:idm/core/models/action.py
  - fitcher:idm_backend_palmsync:idm/core/models/system.py
  - fitcher:idm_backend_palmsync:idm/core/models/systemrolepush.py
  - fitcher:idm_backend_palmsync:idm/core/models/role.py
  - fitcher:idm_backend_palmsync:idm/services/models.py
  - fitcher:idm_backend_palmsync:idm/users/constants/group.py
  - fitcher:idm_backend_palmsync:idm/users/models.py
