feature: Довыдача роли

specs:
  beforeEach:
    - do: проверить, что тестовая роль для довыдачи находится в статусе "Ошибка системы", и у неё есть кнопка "Довыдать" (/system/testsystem#role=12400701,f-role-id=12400701)
    - screenshot: карточка тестовой роли для довыдачи [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-16%2012-51-50.png]
    - do: проверить, что тестовая роль, которую невозможно довыдать, не имеет кнопки "Довыдать" (/system/testsystem#role=12840172,f-role-id=12840172)
    - screenshot: карточка тестовой роли, которую невозможно довыдать [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-03%2012-44-09.png]

  Выполнение правил для довыдачи роли:
    - do: запустить в Runner сценарий "Довыдача роли" (https://github.yandex-team.ru/pixel/idm-runner)
    - do: отправить запрос "Успешная довыдача роли" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "202"
    - screenshot: ответ на запрос "Успешная довыдача роли" должен содержать null [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-03%2012-40-31.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Нельзя довыдать роль, если недостаточно прав" с токеном "robot-cat-bayun"
    - assert: пришёл ответ со статусом "403"
    - screenshot: ответ на запрос "Нельзя довыдать роль, если недостаточно прав" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-03%2012-41-56.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "Нельзя довыдать роль в неправильном состоянии" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "403"
    - screenshot: ответ на запрос "Нельзя довыдать роль в неправильном состоянии" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-02-03%2012-42-24.png]
    - do: кликнуть по табе "Test Results" в Response части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

priority: blocker

files:
  - idm/tests/api/frontend/test_role.py

tags:
  - reviewed
  - no_assessors
  - postman_automation
  - fitcher:idm-www:blocks/desktop/card/__controls/**
  - fitcher:idm-www:blocks/desktop/cards/**
  - fitcher:idm-www:test/auto/01-roles/01-request/**
  - fitcher:idm_backend_palmsync:idm/tests/api/frontend/test_role.py
  - fitcher:idm_backend_palmsync:idm/api/exceptions.py
  - fitcher:idm_backend_palmsync:idm/core/constants/role.py
  - fitcher:idm_backend_palmsync:idm/core/constants/rolefield.py
  - fitcher:idm_backend_palmsync:idm/core/models/role.py
  - fitcher:idm_backend_palmsync:idm/core/models/rolenode.py
  - fitcher:idm_backend_palmsync:idm/core/models/rolefield.py
  - fitcher:idm_backend_palmsync:idm/core/models/rolealias.py
  - fitcher:idm_backend_palmsync:idm/core/models/approverequest.py
  - fitcher:idm_backend_palmsync:idm/permissions/utils.py
  - fitcher:idm_backend_palmsync:idm/tests/utils.py
  - fitcher:idm_backend_palmsync:idm/users/constants/group.py
  - fitcher:idm_backend_palmsync:idm/users/models.py