feature: advert-react
tlds: ru
params:
  exp_flags:
    - force-react-advert=1

specs:
  Реклама должна не показываться на странице под флагом adv_disabled:
    - tags: no_assessors
    - params:
        exp_flags:
          - adv-disabled=1
    - do: открыть страницу '/turbo?stub=advert/react-basic.json'
    - assert: убедиться, что на странице нет рекламы

  Реклама должна показываться на странице без флага adv_disabled:
    - do: открыть страницу '/turbo?stub=advert/react-basic.json'
    - assert: убедиться, что на странице есть реклама

  Реклама не должна показываться на странице при медленных соединениях под флагом:
      - tags: no_assessors
      - params:
          exp_flags:
            - force-react-advert=1
            - ads-on-bad-connection=1
          user_connection: slow_connection=1
      - do: получить выдачу по запросу 'https://yandex.ru/turbo?stub=advert/react-basic.json&exp_flags=ads-on-bad-connection=1&exp_flags=force-react-advert=1&user_connection=slow_connection=1'
      - assert: убедится что на странице нет рекламы

  Реактовая реклама должна не показываться без флага включающего ее:
    - tags: no_assessors
    - do: открыть страницу '/turbo?stub=advert/react-basic.json'
    - assert: убедится что на странице используется реклама от бэма (селектор .advert, а не .turbo-advert)

  Скриншот стаба рекламы:
    - tags: no_assessors
    - do: открыть страницу '/turbo?stub=advert/react-basic.json&hermione_advert=stub'
    - screenshot: реклама отображается в вечной загрузке [plain]

  RUM-счётчики про скорость рекламы (adfox):
    - params:
        exp_flags:
          - adv-disabled=0
          - force-react-advert=1
    - tags: no_assessors
    - do: открыть ссылку https://yandex.ru/turbo?stub=advert%2Freact-rum-counters-1-adfox.json
    - tech: проверить наличие счётчиков 690.2096.207 (/tech/perf/time)
    - tech: |
        Со следующими наборами переменных
        143(page)='28.2719.584'(/ru/turbo/touch), 1701(id)='1724'(/load), 1(ad)='2930'(/adfox), 1366(paid)='257673', 2322(start_time)=/[0-9.]+/, 2877(delta)=/[0-9.]+/
        143(page)='28.2719.584'(/ru/turbo/touch), 1701(id)='3105'(/prerender), 1(ad)='2930'(/adfox), 1366(paid)='257673', 2322(start_time)=/[0-9.]+/, 2877(delta)=/[0-9.]+/
        143(page)='28.2719.584'(/ru/turbo/touch), 1701(id)='2046'(/render), 1(ad)='2930'(/adfox), 1366(paid)='257673', 2322(start_time)=/[0-9.]+/, 2877(delta)=/[0-9.]+/
    - do: проскроллить до конца страницы
    - assert: должна подгрузиться вторая страница с рекламой
    - tech: проверить, что нет других счётчиков про скорость загрузки рекламы, кроме оправленных выше

  RUM-счётчики про скорость рекламы (partner):
    - params:
        exp_flags:
          - adv-disabled=0
          - force-react-advert=1
    - tags: no_assessors
    - do: открыть ссылку https://yandex.ru/turbo?stub=advert%2Freact-rum-counters-1-partner.json
    - tech: проверить наличие счётчиков 690.2096.207 (/tech/perf/time)
    - tech: |
        Со следующими наборами переменных
        143(page)='28.2719.584'(/ru/turbo/touch), 1701(id)='1724'(/load), 1(ad)='1219'(/partner), 1366(paid)='196263', 2322(start_time)=/[0-9.]+/, 2877(delta)=/[0-9.]+/
        143(page)='28.2719.584'(/ru/turbo/touch), 1701(id)='3105'(/prerender), 1(ad)='2930'(/partner), 1366(paid)='257673', 2322(start_time)=/[0-9.]+/, 2877(delta)=/[0-9.]+/
        143(page)='28.2719.584'(/ru/turbo/touch), 1701(id)='2046'(/render), 1(ad)='1219'(/partner), 1366(paid)='196263', 2322(start_time)=/[0-9.]+/, 2877(delta)=/[0-9.]+/
    - do: проскроллить до конца страницы
    - assert: должна подгрузиться вторая страница с рекламой
    - tech: проверить, что нет других счётчиков про скорость загрузки рекламы, кроме оправленных выше

  Должны пробрасываться параметры cacheId и adSessionId:
    - params:
        exp_flags:
          - adv-disabled=0
          - force-react-advert=1
    - tags: no_assessors
    - do: открыть ссылку https://yandex.ru/turbo?stub=advert/partner-cache-1.json&hermione_advert=stub&load-react-advert-script=1
    - tech: получить объект window.AdvertCalls
    - assert: в массиве partner есть вызов для блока R-I-260855-1
    - assert: у вызова R-I-260855-1 свойству cacheId соответствует значение "123", а свойству adSessionId значение "abc"
    - assert: в массиве partner есть вызов для блока R-I-260855-2
    - assert: у вызова R-I-260855-2 свойству cacheId соответствует значение "234", а свойству adSessionId значение "abc"
    - do: проскроллить до конца страницы
    - assert: должна подгрузиться вторая страница с рекламой
    - tech: получить объект window.AdvertCalls
    - assert: в массиве partner есть вызов для блока R-I-260855-3
    - assert: у вызова R-I-260855-3 нет свойства cacheId и adSessionId
    - assert: в массиве partner есть вызов для блока R-I-260855-4
    - assert: у вызова R-I-260855-4 свойству cacheId соответствует значение "456", а свойству adSessionId значение "bcd"
    - do: проскроллить до конца страницы
    - assert: должна подгрузиться третья страница с рекламой
    - tech: получить объект window.AdvertCalls
    - assert: в массиве partner есть вызов для блока R-I-260855-5
    - assert: у вызова R-I-260855-5 нет свойства cacheId и adSessionId
    - assert: в массиве partner есть вызов для блока R-I-260855-6
    - assert: у вызова R-I-260855-6 нет свойства cacheId и adSessionId
  
  Реклама-перетяжка в начале страницы:
    Вертикальная ориентация:
        - do: открыть ссылку https://yandex.ru/turbo?stub=advert%2Ftop.json&exp_flags=adv-disabled=0&hermione_advert=stub&exp_flags=force-react-advert=1&load-react-advert-script
        - do: убедиться, что во время загрузки реклама сверху имеет серую подложку
        - screenshot: В начале страницы должен быть блок рекламы [plain]
        - tech: убедиться, что не было клиентских ошибок
    Горизонтальная ориентация:
        - do: открыть ссылку https://yandex.ru/turbo?stub=advert%2Ftop.json&exp_flags=adv-disabled=0&hermione_advert=stub&exp_flags=force-react-advert=1&load-react-advert-script
        - do: убедиться, что во время загрузки реклама сверху имеет серую подложку
        - do: изменить ориентацию устройства на горизонтальную
        - screenshot: В начале страницы должен быть блок рекламы [plain-landscape]
        - tech: убедиться, что не было клиентских ошибок

files:
  - platform/components/Advert/__tests__/Advert.hermione.js
  - platform/components/Advert/__tests__/Advert@phone.hermione.js

v-team: Turbo

manager: tanzwuta

qa-engineer: dakhetov, olga0321
