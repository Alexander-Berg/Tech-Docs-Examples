feature: Каталог сервисов

specs:
  beforeEach:
    - do: (PREPARE) запустить в Runner сценарий "api/v4/services/" (https://github.yandex-team.ru/pixel/abc-runner)

  Запрос можно отправить без фильтров:
    - do: отправить запрос "api/v4/services/ без фильтров" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ без фильтров" должен содержать поля вида [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-30-44.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Пользователь с ограниченной ролью может просматривать список своих сервисов, но не видит их статуса:
    - do: отправить запрос "api/v4/services/ без фильтров Ограниченная роль" с токеном "robot-cat-matroskin"
    - assert: пришёл ответ со статусом "200", в теле ответа нет полей "state"
    - screenshot: ответ на запрос "api/v4/services/ без фильтров Ограниченная роль" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-31-55.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
  
  Пользователь с сильно ограниченной ролью может просматривать список своих сервисов, но не видит их статуса:
    - do: отправить запрос "api/v4/services/ без фильтров Сильно ограниченная роль" с токеном "robot-cat-bayun"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ без фильтров Сильно ограниченная роль" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-31-55.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
  
  Запрос со всеми доступными по сервисам полями:
    - do: отправить запрос "api/v4/services/ все поля" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ все поля" должен содержать по каждому сервису поля вида [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-34-06.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Запрос с фильтрацией по id сервиса(-ов):
    - do: отправить запрос "api/v4/services/ фильтрация по id сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по id сервиса" должен содержать запись только про сервис с id 3886 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-35-46.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"  
    - do: отправить запрос "api/v4/services/ фильтрация по id нескольких сервисов" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по id нескольких сервисов" должен содержать записи про два сервиса - с id 3465 и 3886 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-36-33.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по id сервиса. Невалидное значение" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по id сервиса. Невалидное значение" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-37-22.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Запрос с фильтрацией по slug'у сервиса(-ов):
    - do: отправить запрос "api/v4/services/ фильтрация по slug сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по slug сервиса" должен содержать запись только про сервис с id 3886 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-38-16.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по slug нескольких сервисов" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по slug нескольких сервисов" должен содержать записи только про сервисы с id 3465 и 3886 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-38-50.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по slug сервиса. Невалидное значение" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по slug сервиса. Невалидное значение" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-39-39.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Запрос с фильтрацией по имени сервиса:
    - do: отправить запрос "api/v4/services/ фильтрация по name сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по name сервиса" должен содержать запись только про сервис с id 3886 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-40-47.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по name_en сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по name_en сервиса" должен содержать запись только про сервис с id 3465 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-41-39.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
  
  Запрос с фильтрацией по члену сервиса:
    - do: отправить запрос "api/v4/services/ фильтрация по member сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по member сервиса" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-43-25.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
  
  Запрос с фильтрацией по статусу(-ам) сервиса:
    - do: отправить запрос "api/v4/services/ фильтрация state=closed" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: в ответе на запрос "api/v4/services/ фильтрация state=closed" у каждой записи поле "state" должно иметь значение "closed" [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-44-05.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация state__in=deleted,needinfo,supported" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация state__in=deleted,needinfo,supported" должен содержать записи, у которых поле "state" имеет значения "deleted", "needinfo" или "supported" [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-44-58.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация readonly_state__in=creating,moving,renaming,deleting" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация readonly_state__in=creating,moving,renaming,deleting" должен содержать записи, у которых поле "readonly_state__in" имеет одно из значений - "creating", "moving", "renaming", "deleting" [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-46-14.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    
  Фильтрация по родителю(-ям) сервиса:  
    - do: отправить запрос "api/v4/services/ фильтрация по parent сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: в ответе на запрос "api/v4/services/ фильтрация по parent сервиса" у каждой записи про сервис поле id в блоке parent должно иметь значение 3465 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-48-29.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по parent__in сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: в ответе на запрос "api/v4/services/ фильтрация по parent__in сервиса" у каждой записи про сервис поле id в блоке parent должно иметь значение 850 или 3465 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-49-40.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по parent__slug сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: в ответе на запрос "api/v4/services/ фильтрация по parent__slug сервиса" у каждой записи про сервис поле id в блоке parent должно иметь значение 3465 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-48-29.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по parent__slug__in сервиса" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: в ответе на запрос "api/v4/services/ фильтрация по parent__slug__in сервиса" у каждой записи про сервис поле id в блоке parent должно иметь значение 850 или 3465 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-49-40.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по parent__isnull=true" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: в ответе на запрос "api/v4/services/ фильтрация по parent__isnull=true" каждая запись должна иметь значение null в поле "parent" [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-51-18.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по parent__isnull=false" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: в ответе на запрос "api/v4/services/ фильтрация по parent__isnull=false" не должно быть записей, у которых поле "parent" имеет значение null [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-52-09.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по parent__with_descendants" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: в ответе на запрос "api/v4/services/ фильтрация по parent__with_descendants" у каждой записи про сервис поле id в блоке parent должно иметь значение 3465 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-48-29.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по parent__with_descendants без потомков" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по parent__with_descendants без потомков" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-54-06.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по parent__with_descendants__slug" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по parent__with_descendants__slug" должен содержать у каждой записи поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-54-39.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Фильтрация сервисов по подозрительности:
    - do: отправить запрос "api/v4/services/ фильтрация по is_suspicious=True" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по is_suspicious=True" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-55-29.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по is_suspicious=False" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: ответ на запрос "api/v4/services/ фильтрация по is_suspicious=False" должен содержать поля [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-55-58.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

  Фильтрация сервисов по тегам:
    - do: отправить запрос "api/v4/services/ фильтрация по tag'y" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: в ответе на запрос "api/v4/services/ фильтрация по tag'y" каждая запись должна содержать в блоке "tags" тег "micro" с id=99 [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-56-59.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"
    - do: отправить запрос "api/v4/services/ фильтрация по tags__slug__in=micro,oebs" с токеном "robot-cat-leopold"
    - assert: пришёл ответ со статусом "200"
    - screenshot: в ответе на запрос "api/v4/services/ фильтрация по tags__slug__in=micro,oebs" каждая запись должна содержать в блоке "tags" теги "micro" или "oebs" с id=99 или 137 соответственно [https://jing.yandex-team.ru/files/pixel/Screenshot%20from%202021-03-05%2020-56-59.png]
    - do: кликнуть по табе "Test Results" в "Response" части postman UI
    - assert: на табе "Test Results" все тесты со статусом "PASS"

priority: blocker

files:
  - tests/unit/services/api/test_api_frontend.py

tags:
  - reviewed
  - no_assessors
  - postman_automation
  - fitcher:abc:src/common/components/AbcTable/**
  - fitcher:abc:src/blocks/desktop/services/**
  - fitcher:abc:abc/src/features/Catalogue/**
  - fitcher:plan:tests/unit/services/api/test_api_frontend.py
