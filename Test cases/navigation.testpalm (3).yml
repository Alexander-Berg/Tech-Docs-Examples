feature: Turbo Navigation

specs:
  aliases:
    - &PageActions
      - do: нажать на надпись Lorem ipsum
      - assert: открылась страница википедии Independent school
    - &CheckNavigation
      - assert: открывается турбо-страница
      - do: нажать на надпись turbo in turbo
      - assert: открылась страница википедии Independent school
      - tech: отправился postmessage с параметрами — action navigate-turbo-link, orig https://en.wikipedia.org/wiki/Private_school, url https://yandex.ru/turbo?text=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FPrivate_school
    - &SelectionActions
      - assert: открывается турбо-страница
      - do: нажать на селект "все каналы" и выбрать "Первый"
      - assert: открылась страница википедии Independent school

  Ссылки турбо-в-турбо должны работать корректно:
    - params:
        foreverdata: '3861577595'
    - do: получить выдачу по запросу 'foreverdata' и кликнуть в заголовок первого сниппета (название заголовка Тестовая страница для турбо в турбо — ссылки — турбо)
    - assert: открывается турбо-страница
    - do: нажать на надпись Lorem ipsum
    - assert: открылась страница википедии Independent school
    - tech: отправился postmessage с параметрами — action navigate-turbo-link, orig https://en.wikipedia.org/wiki/Private_school, url https://yandex.ru/turbo?text=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FPrivate_school

  Кнопки турбо-в-турбо должны работать корректно:
    - params:
        foreverdata: '730835245'
    - do: получить выдачу по запросу 'foreverdata' и кликнуть в заголовок первого сниппета (название заголовка Тестовая страница для турбо в турбо — кнопки — турбо)
    - *PageActions

  Selection-filter заменяет историю:
    - params:
        foreverdata: '609799926'
    - do: получить выдачу по запросу 'foreverdata' и кликнуть в заголовок первого сниппета (название заголовка Тестовая страница для перезагрузки с селектом — турбо)
    - *SelectionActions
    - tech: отправился postmessage с параметрами — action replace-turbo-link, orig https://en.wikipedia.org/wiki/Private_school, url https://yandex.ru/turbo?text=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FPrivate_school
    - do: нажать кнопку назад в вверхнем левом углу или крестик в верхнем правом углу (должно быть что-то одно или крестик или кнопка "назад")
    - assert: страница турбо закрылась, видно поисковую выдачу

  Selection-filter делает корректную навигацию:
    - params:
        foreverdata: '34226355'
    - do: получить выдачу по запросу 'foreverdata' и кликнуть в заголовок первого сниппета (название заголовка Тестовая страница для навигации с селектом — турбо)
    - *SelectionActions
    - tech: отправился postmessage с параметрами — action navigate-turbo-link, orig https://en.wikipedia.org/wiki/Private_school, url https://yandex.ru/turbo?text=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FPrivate_school
    - do: нажать кнопку назад в вверхнем левом углу или крестик в верхнем правом углу (должно быть что-то одно или крестик или кнопка "назад")
    - assert: вернулись на страницу с селектами

  Ссылки турбо-в-турбо должны работать корректно вне айфрейма:
    - do: открыть главную страницу поиска, удалить все параметры кроме yandex.ru и добавить в адресную строку к URL /turbo?stub=link/internal.json
    - *PageActions

  Кнопки турбо-в-турбо должны работать корректно вне айфрейма:
    - do: открыть главную страницу поиска, удалить все параметры кроме yandex.ru и добавить в адресную строку к URL /turbo?stub=button/internal.json
    - *PageActions

  Selection-filter заменяет историю вне айфрейма:
    # bin выбраны специально, что бы проверять продовую замену урла (text vs stub)
    - do: открыть главную страницу поиска, удалить все параметры кроме yandex.ru и добавить в адресную строку к URL /turbo?text=bin:selection-filter-reload
    - *SelectionActions
    - do: перейти назад в браузере
    - assert: вернулись на yandex.ru

  Selection-filter делает корректную навигацию вне айфрейма:
    - do: открыть главную страницу поиска, удалить все параметры кроме yandex.ru и добавить в адресную строку к URL /turbo?text=bin:selection-filter-navigate
    - *SelectionActions
    - do: перейти назад в браузере
    - assert: вернулись на страницу с селектами

  На ios12 страница перезагружается при переходах с серпа:
    - browsers:
        - ios-safari-11-touch
    - params:
        foreverdata: '3861577595'
    - do: получить выдачу по запросу 'foreverdata' и кликнуть в заголовок первого сниппета (название заголовка Тестовая страница для турбо в турбо — ссылки — турбо)
    - assert: открывается турбо-страница
    - do: нажать на надпись lorem ipsum
    - assert: открылась страница википедии Independent school
    - do: перезагрузить страницу
    - assert: открыта страница турбо; кнопка "назад" или крестик вверху исчезли
    - do: перейти на предыдущую страницу
    - assert: страница изменилась. Видно страницу с ссылкой lorem ipsum.

  Реакт-ссылки турбо-в-турбо должны работать корректно:
    - params:
        foreverdata: '2405768249'
    - do: получить выдачу по запросу 'foreverdata' и кликнуть в заголовок первого сниппета (название заголовка Тестовая страница для турбо в турбо — ссылки — турбо)
    - *CheckNavigation

  Реакт-ссылки турбо-в-турбо должны работать корректно вне айфрейма:
    - do: открыть главную страницу поиска, удалить все параметры кроме yandex.ru и добавить в адресную строку к URL /turbo?stub=link/react-internal.json
    - *CheckNavigation

  Параметр no_turbo при навигации турбо-в-турбо для turboOnly сервисах:
    - do: открыть страницу https://yandex.ru/turbo?text=bin:turbo-only
    - do: нажать на надпись turbo in turbo
    - tech: |
        перед переходом отправился postmessage с параметрами
        action navigate-turbo-link,
        orig https://en.wikipedia.org/wiki/Private_school?no_turbo=1
    - assert: открылась страница википедии Independent school

  Параметр no_turbo при замене истории в turboOnly сервисах:
    - do: открыть страницу https://yandex.ru/turbo?text=bin:turbo-only
    - do: нажать на селект "все каналы" и выбрать "Первый"
    - tech: |
        перед переходом отправился postmessage с параметрами
        action replace-turbo-link,
        orig https://en.wikipedia.org/wiki/Private_school?no_turbo=1
    - assert: открылась страница википедии Independent school

  Передает tpid и exp_flags при навигации турбо-в-турбо:
    - tags: no_assessors
    - do: открыть страницу в темпларе /turbo?stub=link/internal.json&tpid=100&exp_flags=test_tool=hermione
    - do: нажать на надпись Lorem ipsum
    - assert: открылась страница википедии Independent school, урл содержит параметр tpid=100 и exp_flags=test_tool=hermione

  Передает nomooa при навигации турбо-в-турбо:
    - do: открыть страницу https://yandex.ru/turbo?stub=link/internal.json&nomooa=1
    - do: нажать на надпись Lorem ipsum
    - assert: открылась страница википедии Independent school, урл содержит параметр nomooa=1

  Передает trbsrc при навигации турбо-в-турбо:
    - do: открыть страницу https://yandex.ru/turbo?stub=link/internal.json
    - *PageActions
    - tech: |
          в параметре url post-message'а содержится trbsrc=turbo

  Не дублирует trbsrc при навигации турбо-в-турбо, когда этот параметр уже присутствует:
      - do: открыть страницу https://yandex.ru/turbo?stub=link/news-turbo-or-not-turbo.json
      - do: нажать на надпись "Ссылка с параметром trbsrc=news"
      - assert: открылась страница с ифнормацией о турбо-страницах
      - tech: |
          в параметре url post-message'а не содержится trbsrc=turbo

  Не ломаются относительные ссылки:
    - do: открыть страницу https://yandex.ru/turbo?stub=link/relative-link.json
    - do: нажать  на первую ссылку
    - assert: >
        урл страницы изменился на https://yandex.ru/sport/a/b/c
        (урл может содержать дополнительные параметры)
    - do: вернуться назад и нажать на вторую ссылку
    - assert: >
        урл страницы изменился на https://yandex.ru/sport/a/b/c
        (урл может содержать дополнительные параметры)

  Под флагом открытия в новой iframe страница новостей сохраняет старое поведение в новой вкладке:
    - params:
        exp_flags: adv-disabled=1
    - do: открыть страницу https://yandex.ru/turbo?stub=link%2Fnews_blank.json&exp_flags=touch_alternate_sidebar%3D2&new_overlay=1
    - do: кликнуть по ссылке
    - assert: открылась страница википедии Independent school


  Обработка турбо-в-турбо происходит на реактовой ссылке, когда клик прошел на элемент внутрее нее:
    - do: открыть страницу в темпларе https://yandex.ru/turbo?stub=productspage/index.json
    - do: нажать на второй в списке товар
    - tech: отправился post-message с параметрами action — 'navigate-turbo-link', url — '/turbo?stub=productpage%2Fproduct-2.json', orig — 'productpage/product-2.json'

  Selection-filter работает с ссылками турбо-в-турбо:
    - do: открыть страницу https://yandex.ru/turbo?stub=selection-filter%2Fturbo-in-turbo.json
    - do: кликнуть на селект с текстом "Черный"
    - do: выбрать опцию "Серебро"
    - assert: произошёл переход на страницу https://yandex.ru/turbo/s/zymbo.ru/krasota-i-zdorove/rascheska-babochka.html?pcgi=turboofferid%3D2173000095 (содержимое страницы не важно, важен URL)


files:
  - features/common/post-message/navigation/navigation.hermione.js

v-team: Turbo

manager: tanzwuta

qa-engineer: olga0321, dakhetov

tlds: none
