feature: Турбо

specs:
  aliases:
    - &OpenTurbo
      - do: тапнуть на заголовок сниппета турбо-страницы
      - assert: |
          открылся сайд-блок с контентом страницы,
          в сайд-блоке показывается Турбо-страница (с ракетой в заголовке),
          в сайд-блоке есть кнопка 'Назад' или крестик в верхнем правом углу

  Страница открывается в новой вкладке:
    - browsers:
        notFor:
          - ios-yandex-browser-17-touch
          - android-yandex-browser-17-touch
    - params:
        foreverdata: '4079370912'
    - do: получить выдачу по запросу 'foreverdata'
    - assert: в выдаче присутствует сниппет 'Обслуживание V40, врождённые болячки... — Volvo V40, 2002 year on DRIVE2'
    - do: кликнуть в тайтл сниппета
    - assert: открылась новая вкладка браузера

  Новый таб и счётчики при клике на заголовок до инициализации js:
    - tags: no_assessors
    - params:
        foreverdata: '4079370912'
    - do: получить выдачу по запросу 'foreverdata'
    - assert: турбо-сниппет с ракетой появился на выдаче
    - assert: ссылка на заголовке сниппета содержит 'drive2-com.turbopages.org/drive2.com/s/l/5959212/'
    - do: кликнуть на заголовок до инициализации js или правой кнопкой и "Открыть в новой вкладке"
    - tech: проверить счетчик на заголовке - path = '/$page/$main/$result/title[@turbo = true]'
    - assert: открылась новая вкладка браузера с Турбо-страницей (с ракетой в заголовке)

  Не должно быть двойной анимации закрытия оверлея [manual]:
    - tags: skip_manual_check
    - automation: SERP-73952
    - browsers:
        - ios-yandex-browser-17-touch
    - params:
        foreverdata: '3614159941'
    - do: получить выдачу по запросу 'foreverdata'
    - assert: в выдаче присутствует турбо-сниппет 'Тестовая страница для турбо в турбо - турбо'
    - *OpenTurbo
    - do: закрыть оверлей жестом свайпа слева направо, свайп должен быть от самого края экрана, так iphone работает
    - assert: не должно быть повторной анимации закрытия оверлея

  Открытие в оверлее урла с якорем:
    - tags: no_assessors
    - browsers:
        - ios-yandex-browser-17-touch
        - android-yandex-browser-17-touch
    - params:
        foreverdata: '4252077949'
    - do: получить выдачу по запросу 'foreverdata'
    - assert: в выдаче присутствует сниппет 'Тестовая страница для открытия с якорем - турбо'
    - do: кликнуть в тайтл сниппета
    - assert: |
        открылся турбо-оверлей
        открывшаяся в оверлее страница проскролливается к разделу "related - Заголовок — первый анкор"

  Проверка метрики при клике на заголовок:
    - tags: no_assessors
    - do: получить выдачу по запросу 'акита-ину'
    - assert: турбо-сниппет с ракетой появился на выдаче
    - do: Кликнуть на заголовок первого турбо сниппета
    - assertMetrics:
      - daily.total_session_count == 1
      - web.total_request_count == 1
      - web.total_all_click == 1
      - web.total_click_count == 1
      - web.total_dynamic_click_count == 0
      - web.abandonment == 0
      - web.total_turbo_result_clicks == 1

  Проверка метрики при открытии трех турбо страниц:
    - tags: no_assessors
    - do: получить выдачу по запросу 'википедия виски'
    - assert: турбо-сниппет с ракетой появился на выдаче
    - do: Кликнуть на заголовок первого турбо сниппета
    - do: Получить выдачу по запросу 'википедия текила'
    - do: Кликнуть на заголовок второго турбо сниппета
    - do: Получить выдачу по запросу 'википедия ром'
    - do: Кликнуть на заголовок третьего турбо сниппета
    - assertMetrics:
      - daily.total_session_count == 1
      - web.total_request_count == 3
      - web.total_all_click == 3
      - web.total_click_count == 3
      - web.total_dynamic_click_count == 0
      - web.abandonment == 0
      - web.total_turbo_result_clicks == 3

  Добавляет флаг itd=1 к первой загружаемой странице мультипейджа:
    - tags: no_assessors
    - browsers:
      - ios-yandex-browser-17-touch #актуально для ios>=13
      - android-yandex-browser-17-touch
    - do: получить выдачу по запросу 'акита-ину'
    - do: кликнуть в заголовок первого турбо-сниппета не сайта Википедии
    - assert: |
        открылся многостраничный оверлей
        активный iframe src содержит параметр itd
        соседние iframe не содержат параметр itd
    - do: закрыть оверлей
    - do: кликнуть в заголовок второго турбо-сниппета не сайта Википедии
    - assert: |
        открылся многостраничный оверлей
        открывшаяся страница не та же, что и в первый раз
        активный iframe src содержит параметр itd
        соседние iframe не содержат параметр itd

  Флаг turbo-host меняет хост турбо-страницы:
    - tags: no_assessors
    - params:
        exp_flags: turbo-host=my.example.com
        foreverdata: '4079370912'
    - do: получить выдачу по запросу 'foreverdata'
    - assert: турбо-сниппет с ракетой появился на выдаче
    - assert: ссылка в гринурле содержит ведет на домен 'my.example.com'

files:
  - features/touch-phone/turbo/turbo.hermione.js

tags:
  - turbo
  - reviewed
  - overlay
  - organic

v-team: Turbo

counter: /web/item/turbo_text

priority: normal

browsers:
  notFor:
    - android-uc-browser-11-touch
    - android-uc-browser-touch

tlds: [ru, by, ua, uz, kz, com.tr, com]
