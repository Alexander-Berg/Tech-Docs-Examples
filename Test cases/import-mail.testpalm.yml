feature: Импорт почты

description: |
  Preconditions.
  Чтобы подготовить файл, его надо скачать на странице импорта почты на вкладке "Из CSV-файла" по кнопке "Скачать шаблон"
  Для подготовки корректного файла надо указать свои данные(email и пароль) не нарушая структуру.
  Для подготовки некорректного файла надо удалить запятые или данные в загруженном файле.

import-steps:
  - tests/hermione/shared-steps/registration.testpalm.steps.yml

aliases:
  - &data_entry
    - do: ввести почту Mail.ru в поле "Почта"
    - do: ввести пароль от почты в поле "Пароль"
    - do: ввести ФИО или логин сотрудника организации в поле "Сотрудник в Коннекте", выбираем его из саджеста
  - &successful_import
    - do: нажать кнопку "Начать перенос почты"
    - assert: |
        выполнился переход на "Перенос почтовых ящиков"
        появилась первая зеленая галка "Сверка данных"
        появилась вторая зеленая галка "Заведение новых учётных записей"
        появилась третья зеленая галка "Настройка переноса почты на новые ящики"
    - screenshot: внешний вид вкладки переноса [progress]
  - &unsuccessful_import
    - do: нажать кнопку "Начать перенос почты"
    - assert: |
        над кнопкой "Начать перенос почты" появилось красное сообщение об ошибке
        над кнопкой "Начать перенос почты" появилась таблица с ошибками
    - screenshot: внешний вид вкладки ввода данных [user-input]

specs:
  beforeEach:
    - do: авторизоваться под учеткой в паспорте у которой есть организация с подтвержденным доменом или зарегистрироваться и создать организацию с доменом
    - attach: Регистрация организации с промо коннекта с подтверждением домена
    - do: перейте на страницу сервиса "Почта" по ссылке {{CONNECT_HOST}}/portal/services/mail?noredirect=1
    - do: перейте на вкладку "Импорт почты"
  Положительные:
    1. Сервер импорта "Свой сервер":
      - screenshot: внешний вид вкладки "Импорт почты" [plain]
      - assert: |
          предвыбранна вкладка "Свой сервер" в блоке "Выберите сервер импорта"
          в поле "Протокол" предвыбранна вкладка IMAP
          стоит галка "Использовать SSL-шифрование"
          поле "Сервер" пустое
          поле "Порт" пустое
          отображается подсказка под полем "Порт", текст "Стандартный порт — 993"
          в поле "Настройки переноса почты" проставлены три галки
          кнопка "Дальше" неактивна
      - do: отжать галку "Использовать SSL-шифрование"
      - assert: изменился текст под полем "Порт", текст "Стандартный порт — 143"
      - do: нажать на подчеркнутый пунктиром текст "143"
      - assert: номер порта 143 прописался в поле "Порт"
      - do: выбрать вкладку POP3 в поле "Протокол"
      - assert: изменился текст под полем "Порт", текст "Стандартный порт — 110"
      - do: поставить галку "Использовать SSL-шифрование"
      - assert: изменился текст под полем "Порт", текст "Стандартный порт — 995"
      - do: |
          заполнить поле "Сервер", например test.ru
          заполнить поле "Порт", например 995
      - assert: кнопка "Дальше" стала активной
    2. Сервер импорта "Mail.ru":
      - do: перейти на вкладку "Mail.ru" в блоке "Выберите сервер импорта"
      - assert: |
          в поле "Протокол" предвыбранна вкладка IMAP
          стоит галка "Использовать SSL-шифрование"
          поле "Сервер" содержит значение imap.mail.ru
          поле "Порт" содержит значение 993
          отображается подсказка под полем "Порт", текст "Стандартный порт — 993"
          в поле "Настройки переноса почты" проставлены три галки
      - do: выбрать вкладку POP3 в поле "Протокол"
      - assert: |
          изменился текст под полем "Порт", текст "Стандартный порт — 995"
          поле "Сервер" содержит значение pop.mail.ru
          поле "Порт" содержит значение 995
          кнопка "Дальше" активна
    3. Сервер импорта "Gmail":
      - do: перейти на вкладку "Gmail" в блоке "Выберите сервер импорта"
      - assert: |
          в поле "Протокол" предвыбранна вкладка IMAP
          стоит галка "Использовать SSL-шифрование"
          поле "Сервер" содержит значение imap.gmail.ru
          поле "Порт" содержит значение 993
          отображается подсказка под полем "Порт", текст "Стандартный порт — 993"
          в поле "Настройки переноса почты" проставлены три галки
      - do: выбрать вкладку POP3 в поле "Протокол"
      - assert: |
          изменился текст под полем "Порт", текст "Стандартный порт — 995"
          поле "Сервер" содержит значение pop.gmail.ru
          поле "Порт" содержит значение 995
          кнопка "Дальше" активна

    4. Вручную:
      - do: перейти на вкладку "Mail.ru" в блоке "Выберите сервер импорта"
      - do: нажать кнопку "Дальше"
      - screenshot: открыта страница импорта вручную [plain]
      - assert: |
          предвыбранна вкладка "Вручную"
          обязательные поля "Почта" и "Пароль" пустые
          необязательное поле "Сотрудник в Коннекте" пустое
          кнопка "Начать перенос почты" неактивная
      - *data_entry
      - assert: кнопка "Начать перенос почты" активная
      - assert: пароль отображается в виде точек
      - do: нажать на иконку с глазом рядом с заголовком колонки Пароль
      - assert: пароль отображается как есть, не замаскированный точками
      - do: нажать на "Добавить почту"
      - assert: добавились еще поля "Почта", "Пароль", "Сотрудник в Коннекте"
      - *data_entry
      - assert: в конце строки отображается иконка корзины
      - do: нажать на иконку корзины
      - assert: |
          строка удалилась
          появилась нотификация "Почта сотрудника удалена" с экшеном "Отменить"
      - do: нажать на экшен "Отменить" в нотификации
      - assert: удаленная строка восстановилась вместе с данными
      - do: нажать на иконку корзины в этой строке
      - assert: |
          строка удалилась
          появилась нотификация "Почта сотрудника удалена" с экшеном "Отменить"
      - do: нажать крестик в нотификации
      - *successful_import

    5. Через файл:
      - do: перейти на вкладку "Mail.ru" в блоке "Выберите сервер импорта"
      - do: нажать кнопку "Дальше"
      - do: перейти на вкладку "Из CSV-файла"
      - screenshot: открыта вкладка импорта "Из CSV-файла" [plain]
      - assert: |
          кнопка "Начать перенос почты" задизейблена
          отображаются кнопка "Загрузить файл" с подсказкой "Загрузите файл в формате .csv объёмом не более 1 МБ"
          отображается подсказка "Сформируйте текстовый файл. В каждой его строке укажите логин и пароль в кавычках и через запятую. Например: "email@yandex.ru","password"" над кнопкой "Скачать шаблон"
          есть кнопка "Скачать шаблон"
      - do: загрузить подготовленный корректный файл(см description) по кнопке "Загрузить файл"
      - assert: |
          отображается название загруженного файла
          рядом с файлом отображается кнопка с крестиком
          кнопка "Начать перенос почты" активна
      - screenshot: открыта страница импорта с загруженным файлом [file]
      - do: нажать на крестик рядом с загруженным файлом
      - assert: |
          кнопка "Начать перенос почты" задизейблена
          отображаются кнопка "Загрузить файл" с подсказкой "Загрузите файл в формате .csv объёмом не более 1 МБ"
      - do: загрузить подготовленный корректный файл(см description) по кнопке "Загрузить файл"
      - *successful_import

  Отрицательные:
    1. Некорректные данные в сервере импорта:
      - do: |
          перейти на вкладку "Mail.ru" в блоке "Выберите сервер импорта"
          выбрать вкладку POP3 в поле "Протокол"
          ввести некорректное значение в поле "Сервер", например test
          ввести некорректное значение в поле "Порт", например test
          нажать на кнопку "Дальше"
      - assert: появилась нотификация "Не удалось соединиться с сервером импорта"
    2. Некорректные данные в импорте вручную:
      - do: |
          перейти на вкладку "Gmail" в блоке "Выберите сервер импорта"
          нажать кнопку "Дальше"
          ввести некорректное значение в поле "Почта", например test
          ввести некорректное значение в поле "Пароль", например test
          нажать на кнопку "Начать перенос почты"
      - assert: |
          перенос не выполнился
          появилось сообщение "Некорректная почта" под строчкой с введёнными данными
      - do: ввести правильное значение в поле "Почта", например test@mail.ru
      - *unsuccessful_import
    3. Некорректные данные в импорте через файл:
      - do: |
          перейти на вкладку "Gmail" в блоке "Выберите сервер импорта"
          нажать кнопку "Дальше"
          перейти на вкладку "Из CSV-файла"
      - assert: открыта вкладка импорта из файла
      - do: загрузить подготовленный некорректный файл(см description) по кнопке "Загрузить файл"
      - *unsuccessful_import

files:
  - tests/hermione/suites/mail/import-mail.js

priority: blocker

tlds:
  - ru
  - com

tags:
  - smoke_test_assessors
  - regression
  - smoke_test
  - reviewed
