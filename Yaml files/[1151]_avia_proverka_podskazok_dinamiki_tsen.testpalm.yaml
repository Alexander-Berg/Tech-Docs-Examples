feature: Авиа
type: Выдача
description: >-
  Подсказки Динамики цен отображаются по следующему принципу:

  - При загрузке выдачи запрашивается ответ из price index (ручка dynamics).

  - В зависимости от ответа показывается та или иная подсказка Динамики цен.


  Алгоритм, по которому определяется, какая именно подсказка должна быть
  показана, расписан далее:

  Получаем ответ от ручки price index и принимает её минимальное значение за
  min. Затем сравниваем с текущей минимальной ценой на выдаче.

  **1. Если не удалось найти min (нет цен за остальные 6 дней) – нейтральная
  подсказка (4)**.

  **2.Если за все 7 дней присутствуют цены:**

  Берётся min из цен остальных 6 дней. Параллельно определяется, что меньше –
  10% от текущей цены, либо $30.

  Если min цена находится в отрезке [тек – x; тек + x] (где x = min {10%; $30}),
  выводится подсказка о **примерно таких же ценах (3)**

  Если min цена находится вне этого отрезка, происходит сравнение с текущей
  ценой. Если текущая меньше, выводится подсказка **«Это хорошая цена» (1)**.
  Если меньше min цена, выводится подсказка **«Это дорого» (2)**.

  **3. Если есть цены, но не за все 6 дней:**

  Берём min из имеющихся цен. Решаем, что меньше - 10% от текущей цены, либо
  $30.

  x = min {10%; $30}

  - Если min цена меньше (тек – x) – подсказка **«Это дорого» (2).**

  - Если min цена располагается внутри отрезка [тек – x; тек + x] –
  **нейтральная подсказка (4).**

  - Если min цена больше (тек + x) - **нейтральная подсказка (4).**


  **Для того, чтобы узнать, какой ответ нам присылает price index, необходимо
  сделать следующее:**

  1. На главной странице открыть DevTools браузера (по умолчанию - F12) и
  перейти на вкладку Network:


  ![DevTools](https://jing.yandex-team.ru/files/gouken67/%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80%201.png)


  2. Ввести в поле Filter слово "dynamics".

  3. Получить нужную выдачу.

  В DevTools будут появляться только запросы для dynamics.

  4. Кликнуть по появившемуся запросу. Перейти во вкладку Preview.


  Появляется ответ от price index:


  ![Ответ от price
  index](https://jing.yandex-team.ru/files/gouken67/%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80%202.png)


  Читается это так:

  1. В каждой строке записана дата, минимальная цена по аналогичной выдаче за
  эту дату, значение валюты и актуальность.

  2. Актуальность определяется полем roughly. Если оно имеет значение true,
  значит указанная здесь цена не является актуальной, если false - то является.


  **Виды подсказок:**

  1. Подсказка о хорошей цене: "Билеты на соседние даты стоят дороже - на <X>
  р."

  2. Подсказка о плохой цене: "Билеты на соседние даты стоят дешевле - на <X>
  р."

  3. Подсказка о примерно такой же цене: "Билеты на соседние даты стоят примерно
  столько же"

  4. Нейтральная подсказка: "Сравните стоимость билетов на разные даты"


  Далее будет описан способ, который позволит просмотреть большую часть
  подсказок.
specs:
  'Авиа: Проверка подсказок Динамики цен':
    - do: 'Открыть главную страницу путешествий, вкладка Авиабилеты'
    - do: |-
        Заполнить форму поиска билетов
        Откуда: Екатеринбург
        Куда: Кейптаун
        Туда: Любое число месяца, который будет через 3 месяца от текущего.
        Пассажиры: 1 взрослых
        Класс: Эконом
    - do: |-
        Открыть DevTools.
        Перейти во вкладку Network.
        Ввести слово "dynamics" в поле Filter.
    - do: Нажать кнопку “Найти” на странице Авиабилетов.
    - assert: >-
        Открылась страница выдачи. Во вкладке Network появился ответ для
        "dynamics"
    - do: Ознакомиться с ответом для "dynamics".
    - assert: >-
        Необходимо, чтобы в ответе было одно из этих состояний:

        - Есть информация только по текущему дню;

        - Есть информация по текущему и другим дням, но значение roughly у
        записей равно true;

        - Информации нет совсем.

        Если это не так, необходимо повторить шаги 1-5 со смещением на одну
        неделю вперёд.


        **ВАЖНО:** Для текущего дня подойдёт любое значение roughly, для
        остальных - только true.
    - do: >-
        В случае успешного прохождения предыдущего шага: посмотреть на подсказку
        Динамики цен.
    - assert: Подсказка Динамики цен имеет нейтральный вид (4).
    - do: |-
        Выбрать произвольный день в промежутке +-3 дня от текущего.
        Получить выдачу для этого дня по направлению Москва - Кейптаун.
    - assert: >-
        Открылась страница выдачи. Во вкладке Network появился новый ответ для
        “dynamics”.
    - do: Обновить страницу. Ознакомиться с ответом для "dynamics".
    - assert: >-
        В ответе запись текущего дня и запись дня прошлой выдачи имеют roughly:
        false.
    - do: Посмотреть на подсказку Динамики цен.
    - assert: >-
        Пусть min цена - это цена в ответе dynamics для дня предыдущей выдачи,
        тек - текущая минимальная цена на выдаче, x = min {тек * 10%; $30}.


        - Если min цена меньше (тек – x) – подсказка «Это дорого» (2).

        - Если min цена располагается внутри отрезка [тек – x; тек + x] –
        нейтральная подсказка (4).

        - Если min цена больше (тек + x) - нейтральная подсказка (4).


        Говоря проще: если текущая минимальная цена на выдаче отличается от
        минимальной цены из ответа dynamics больше чем на x, мы считаем её
        дорогой.
    - do: Кликнуть на подсказку Динамики цен.
    - assert: 'Открылась Динамика цен, появился новый ответ для dynamics.'
    - do: |-
        Дождаться, пока все варианты прогрузятся.
        Обновить страницу.
    - assert: >-
        Открылась страница выдачи. Во вкладке Network появился ответ для
        “dynamics”.
    - do: Ознакомиться с ответом для “dynamics”.
    - assert: 'Строки для всех дней имеют roughly: false.'
    - do: Посмотреть на подсказку Динамики цен.
    - assert: >-
        Пусть min цена - это цена в ответе dynamics для дня предыдущей выдачи,
        тек - текущая минимальная цена на выдаче, x = min {тек * 10%; $30}.

        Если min цена находится в отрезке [тек – x; тек + x] (где x = min {10%;
        $30}), выводится подсказка о **примерно таких же ценах (3)**

        Если min цена находится вне этого отрезка, происходит сравнение с
        текущей ценой. Если текущая меньше, выводится подсказка **«Это хорошая
        цена» (1)**. Если меньше min цена, выводится подсказка **«Это дорого»
        (2).**
manual: true
Функциональность: Динамика
Устройство: Десктоп
Страница: Выдача
Сервис: Авиа
Тестирование асессорами: Нет
Окружение: Testing
Автор: gouken67
